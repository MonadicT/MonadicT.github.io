<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><meta name="description" /><meta content="Haskell, Parsec, DSL" name="keywords" /><meta content="Praki Prakash" name="author" /><link href="/images/favicon.ico" rel="icon" type="image/x-icon" /><link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="/site-default.css" rel="stylesheet" type="text/css" /><link href="/rss-feed" rel="alternate" title="MonadicT" type="application/rss+xml" /><link href="http://MonadicT.github.io/2016/11/27/ParsecParser/" rel="canonical" /><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88106602-1', 'auto');
  ga('send', 'pageview');</script><title>Writing a parser using Parsec</title></head><div id="wrap"><body><div id="header"><form action="http://www.google.com/search" id="searchform" method="get"><div><input class="box" id="s" name="q" type="text" /><input name="sitesearch" type="hidden" value="http://MonadicT.github.io" /></div></form><h1><a href="/">MonadicT</a></h1></div><div id="content-wrap"><div id="content"><div id="post"><h2 class="page-title">Writing a parser using Parsec</h2>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
I need a parser for a simple Domain Specific Language and I am writing
it in Haskell using the Parsec combinator library. My future posts
will show why I am building this parser but in this post, I will focus
on how to construct a parser for an imperative language using Parsec.
</p>

<p>
I will make no attempt to explain Haskell features except to touch
upon some details of applicatives. There are many resources available on the
Internet for <a href="http://bfy.tw/Gbf">learning Haskell</a>
</p>

<p>
The implementation will be using Applicatives which will be easier to
read than one written in a monadic approach. The language I intend to
parse is a context-free grammar (CFG) and applicatives will do just
fine. It is helpful to review type signatures for <code>&lt;$&gt;</code>, <code>&lt;*&gt;</code>,
<code>*&gt;</code> and <code>&lt;*</code> shown below.
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="font-weight: bold; text-decoration: underline;">:</span>t (<span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span>)
(<span style="color: #d7af00; font-weight: bold;">&lt;$&gt;</span>) <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Functor</span> f <span style="font-weight: bold; font-style: italic;">=&gt;</span> (a <span style="font-weight: bold; font-style: italic;">-&gt;</span> b) <span style="font-weight: bold; font-style: italic;">-&gt;</span> f a <span style="font-weight: bold; font-style: italic;">-&gt;</span> f b

<span style="font-weight: bold; text-decoration: underline;">:</span>t (<span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span>)
(<span style="color: #d7af00; font-weight: bold;">&lt;*&gt;</span>) <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Applicative</span> f <span style="font-weight: bold; font-style: italic;">=&gt;</span> f (a <span style="font-weight: bold; font-style: italic;">-&gt;</span> b) <span style="font-weight: bold; font-style: italic;">-&gt;</span> f a <span style="font-weight: bold; font-style: italic;">-&gt;</span> f b

<span style="font-weight: bold; text-decoration: underline;">:</span>t (<span style="font-weight: bold; font-style: italic;">&lt;*</span>)
(<span style="color: #d7af00; font-weight: bold;">&lt;*</span>) <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Applicative</span> f <span style="font-weight: bold; font-style: italic;">=&gt;</span> f a <span style="font-weight: bold; font-style: italic;">-&gt;</span> f b <span style="font-weight: bold; font-style: italic;">-&gt;</span> f a

<span style="font-weight: bold; text-decoration: underline;">:</span>t (<span style="font-weight: bold; font-style: italic;">*&gt;</span>)
(<span style="color: #d7af00; font-weight: bold;">*&gt;</span>) <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Applicative</span> f <span style="font-weight: bold; font-style: italic;">=&gt;</span> f a <span style="font-weight: bold; font-style: italic;">-&gt;</span> f b <span style="font-weight: bold; font-style: italic;">-&gt;</span> f b
</pre>
</div>

<p>
<code>&lt;$&gt;</code> applies a function <code>(a -&gt; b)</code> to an argument <code>(f a)</code> in a
computational context and produces a new value <code>(f b)</code>.
</p>

<p>
<code>&lt;*&gt;</code> extracts both the function <code>(a -&gt; b)</code> and the argument from
context <code>(f a)</code> producing a new value in <code>(f b)</code>.
</p>

<p>
<code>&lt;*</code> always returns the first argument and <code>*&gt;</code> the second.
</p>

<p>
The syntax of the language that our parser will recognize is shown below.
</p>

<pre class="example">
script :: sequence of stmts
stmt :: var_decl
    | if_stmt
    | while_stmt
    | for_stmt
    | continue_stmt
    | break_stmt
    | "{" stmt... "}"

var_decl :: ident ":=" expr

bool :: "true" | "false"

expr :: bexpr bool_op bexpr
    | bexpr

bexpr :: rexpr relop rexpr
    | rexpr

rexpr :: term termOp term
    | term

term :: term factor_op factor
    | factor

factor :: ID
    | number
    | string
    | True
    | False
    | "(" expr ")"
    | "+|-" factor
    | ID "(" [exppr ["," expr]] ")"

term_op :: "+" | "-"

factor_op :: "*" | "/"

if_stmt :: "if" expr stmt | "if" bool_expr stmt "else" stmt

while_stmt :: "while" expr stmt

for_stmt :: "for" ID stmt

break_stmt :: "break"

continue_stmt :: "continue"
</pre>

<p>
The result of parsing will be an abstract syntax tree (AST). In
further posts, I will implement evaluation of the tree or use it
generate code.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Implementation</h2>
<div class="outline-text-2" id="text-2">
<p>
Using Parsec in applicative style leads to remarkably concise and
simple implementation.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Module declaration</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Lists exports from this module. We export lower-level parse functions
for testing purposes.
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #ff5f00; font-weight: bold;">module</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> (<span style="font-weight: bold; text-decoration: underline;">Expr</span>(<span style="font-weight: bold; font-style: italic;">..</span>), <span style="font-weight: bold; text-decoration: underline;">Stmt</span>(<span style="font-weight: bold; font-style: italic;">..</span>), dslP, parse, exprP, stmtP) <span style="color: #ff5f00; font-weight: bold;">where</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Imports</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Notable imports are Parsec and friends. We also import some functions
from <code>Control.Applicative</code>.
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Control.Applicative</span> (liftA2, pure, (<span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span>), (<span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span>), (<span style="font-weight: bold; font-style: italic;">&lt;*</span>), (<span style="font-weight: bold; font-style: italic;">*&gt;</span>))
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Text.Parsec</span>
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Text.Parsec.String</span> (<span style="font-weight: bold; text-decoration: underline;">Parser</span>)
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Text.ParserCombinators.Parsec.Char</span> (digit, letter,
       alphaNum, lower, upper)
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Text.ParserCombinators.Parsec.Language</span> (emptyDef)
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="color: #ff5f00; font-weight: bold;">qualified</span> <span style="font-weight: bold; text-decoration: underline;">Text.ParserCombinators.Parsec.Token</span> <span style="color: #ff5f00; font-weight: bold;">as</span> <span style="font-weight: bold; text-decoration: underline;">Token</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Lexer</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">tokenDef</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>makeTokenParser <span style="font-weight: bold; font-style: italic;">$</span> emptyDef
     { <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>commentStart    <span style="font-weight: bold; font-style: italic;">=</span> <span style="color: #afafff; font-style: italic;">"/*"</span>
            , <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>commentEnd      <span style="font-weight: bold; font-style: italic;">=</span> <span style="color: #afafff; font-style: italic;">"*/"</span>
            , <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>commentLine     <span style="font-weight: bold; font-style: italic;">=</span> <span style="color: #afafff; font-style: italic;">"//"</span>
            , <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>identStart      <span style="font-weight: bold; font-style: italic;">=</span> letter
            , <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>identLetter     <span style="font-weight: bold; font-style: italic;">=</span> alphaNum
            , <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>reservedNames   <span style="font-weight: bold; font-style: italic;">=</span> [ <span style="color: #afafff; font-style: italic;">"break"</span>
                                      , <span style="color: #afafff; font-style: italic;">"continue"</span>
                                      , <span style="color: #afafff; font-style: italic;">"else"</span>
                                      , <span style="color: #afafff; font-style: italic;">"false"</span>
                                      , <span style="color: #afafff; font-style: italic;">"if"</span>
                                      , <span style="color: #afafff; font-style: italic;">"print"</span>
                                      , <span style="color: #afafff; font-style: italic;">"true"</span>
                                      , <span style="color: #afafff; font-style: italic;">"while"</span>
                                      ]
            , <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>reservedOpNames <span style="font-weight: bold; font-style: italic;">=</span> [<span style="color: #afafff; font-style: italic;">"+"</span>, <span style="color: #afafff; font-style: italic;">"-"</span>, <span style="color: #afafff; font-style: italic;">"*"</span>, <span style="color: #afafff; font-style: italic;">"/"</span>, <span style="color: #afafff; font-style: italic;">":="</span>
                                      , <span style="color: #afafff; font-style: italic;">"&lt;"</span>, <span style="color: #afafff; font-style: italic;">"&gt;"</span>, <span style="color: #afafff; font-style: italic;">"|"</span>
                                      , <span style="color: #afafff; font-style: italic;">"and"</span>, <span style="color: #afafff; font-style: italic;">"or"</span>, <span style="color: #afafff; font-style: italic;">"not"</span>]
            }


<span style="color: #d7af00; font-weight: bold;">reserved</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>reserved tokenDef
<span style="color: #d7af00; font-weight: bold;">reservedOp</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>reservedOp tokenDef
<span style="color: #d7af00; font-weight: bold;">ident</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>identifier tokenDef
<span style="color: #d7af00; font-weight: bold;">integer</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>integer tokenDef
<span style="color: #d7af00; font-weight: bold;">float</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>float tokenDef
<span style="color: #d7af00; font-weight: bold;">stringLit</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>stringLiteral tokenDef
<span style="color: #d7af00; font-weight: bold;">ws</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>whiteSpace tokenDef
<span style="color: #d7af00; font-weight: bold;">symbol</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>symbol tokenDef
<span style="color: #d7af00; font-weight: bold;">parens</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>parens tokenDef
<span style="color: #d7af00; font-weight: bold;">braces</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Token</span><span style="font-weight: bold; font-style: italic;">.</span>braces tokenDef
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">Data types</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #ff5f00; font-weight: bold;">data</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; font-style: italic;">=</span>
    <span style="font-weight: bold; text-decoration: underline;">Add</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Sub</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Mul</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Div</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Eq</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Less</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Greater</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Le</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Ge</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Ne</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">And</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Or</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Not</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Neg</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="font-weight: bold; text-decoration: underline;">String</span> [<span style="font-weight: bold; text-decoration: underline;">Expr</span>]
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">V</span> <span style="font-weight: bold; text-decoration: underline;">String</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">I</span> <span style="font-weight: bold; text-decoration: underline;">Integer</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">D</span> <span style="font-weight: bold; text-decoration: underline;">Double</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">S</span> <span style="font-weight: bold; text-decoration: underline;">String</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">T</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">F</span>
    <span style="color: #ff5f00; font-weight: bold;">deriving</span> (<span style="font-weight: bold; text-decoration: underline;">Show</span>, <span style="font-weight: bold; text-decoration: underline;">Eq</span>)

<span style="color: #ff5f00; font-weight: bold;">data</span> <span style="font-weight: bold; text-decoration: underline;">Stmt</span> <span style="font-weight: bold; font-style: italic;">=</span>
    <span style="font-weight: bold; text-decoration: underline;">Assign</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Block</span> [<span style="font-weight: bold; text-decoration: underline;">Stmt</span>]
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Print</span> [<span style="font-weight: bold; text-decoration: underline;">Expr</span>]
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">If</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Stmt</span> (<span style="font-weight: bold; text-decoration: underline;">Maybe</span> <span style="font-weight: bold; text-decoration: underline;">Stmt</span>)
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">While</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span> <span style="font-weight: bold; text-decoration: underline;">Stmt</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Break</span>
    <span style="font-weight: bold; font-style: italic;">|</span> <span style="font-weight: bold; text-decoration: underline;">Continue</span>
    <span style="color: #ff5f00; font-weight: bold;">deriving</span> (<span style="font-weight: bold; text-decoration: underline;">Show</span>, <span style="font-weight: bold; text-decoration: underline;">Eq</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">Useful combinators</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">commaSep</span> p  <span style="font-weight: bold; font-style: italic;">=</span> p <span style="font-weight: bold; font-style: italic;">`sepBy`</span> (symbol <span style="color: #afafff; font-style: italic;">","</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">Expression parser</h3>
<div class="outline-text-3" id="text-2-6">
<p>
This is the expression parser. This accepts semantically invalid
expressions as there is no distinction between numerical, string and
boolean expressions. In a future post, I will implement a semantic
pass over the AST which will flag invalid expressions.
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">exprP</span> <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
<span style="color: #008787; font-weight: bold; font-style: italic;">--</span><span style="color: #008787; font-weight: bold; font-style: italic;">exprP = termP `chainl1` termopP</span>

<span style="color: #d7af00; font-weight: bold;">exprP</span> <span style="font-weight: bold; font-style: italic;">=</span> bexprP <span style="font-weight: bold; font-style: italic;">`chainl1`</span> bopP

<span style="color: #d7af00; font-weight: bold;">bexprP</span> <span style="font-weight: bold; font-style: italic;">=</span> rexprP <span style="font-weight: bold; font-style: italic;">`chainl1`</span> relopP

<span style="color: #d7af00; font-weight: bold;">rexprP</span> <span style="font-weight: bold; font-style: italic;">=</span> termP <span style="font-weight: bold; font-style: italic;">`chainl1`</span> termopP

<span style="color: #d7af00; font-weight: bold;">termP</span> <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
<span style="color: #d7af00; font-weight: bold;">termP</span> <span style="font-weight: bold; font-style: italic;">=</span> factorP <span style="font-weight: bold; font-style: italic;">`chainl1`</span> factoropP

<span style="color: #d7af00; font-weight: bold;">factorP</span> <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> <span style="font-weight: bold; text-decoration: underline;">Expr</span>
<span style="color: #d7af00; font-weight: bold;">factorP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Not</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> (notP <span style="font-weight: bold; font-style: italic;">*&gt;</span> factorP)
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> <span style="font-weight: bold; text-decoration: underline;">Neg</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> (symbol <span style="color: #afafff; font-style: italic;">"-"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> factorP)
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> symbol <span style="color: #afafff; font-style: italic;">"+"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> factorP
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> <span style="font-weight: bold; text-decoration: underline;">D</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> try float
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> <span style="font-weight: bold; text-decoration: underline;">I</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> try integer
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> <span style="font-weight: bold; text-decoration: underline;">S</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> stringLit
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reserved <span style="color: #afafff; font-style: italic;">"true"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">T</span>
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reserved <span style="color: #afafff; font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">F</span>
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> try callP
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> <span style="font-weight: bold; text-decoration: underline;">V</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> ident
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> parens exprP

<span style="color: #d7af00; font-weight: bold;">relopP</span> <span style="font-weight: bold; font-style: italic;">=</span> (reservedOp <span style="color: #afafff; font-style: italic;">"="</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Eq</span>
           <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reservedOp <span style="color: #afafff; font-style: italic;">"&lt;"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Less</span>
           <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reservedOp <span style="color: #afafff; font-style: italic;">"&gt;"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Greater</span>
           <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reservedOp <span style="color: #afafff; font-style: italic;">"!="</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Ne</span>
           <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reservedOp <span style="color: #afafff; font-style: italic;">"&lt;="</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Le</span>
           <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reservedOp <span style="color: #afafff; font-style: italic;">"&lt;="</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Ge</span>)

<span style="color: #d7af00; font-weight: bold;">bopP</span> <span style="font-weight: bold; font-style: italic;">=</span> symbol <span style="color: #afafff; font-style: italic;">"|"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Or</span>
       <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> symbol <span style="color: #afafff; font-style: italic;">"&amp;"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">And</span>
       <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reserved <span style="color: #afafff; font-style: italic;">"or"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Or</span>
       <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reserved <span style="color: #afafff; font-style: italic;">"and"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">And</span>

<span style="color: #d7af00; font-weight: bold;">termopP</span> <span style="font-weight: bold; font-style: italic;">=</span> symbol <span style="color: #afafff; font-style: italic;">"+"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Add</span>
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> symbol <span style="color: #afafff; font-style: italic;">"-"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span>  return <span style="font-weight: bold; text-decoration: underline;">Sub</span>

<span style="color: #d7af00; font-weight: bold;">factoropP</span> <span style="font-weight: bold; font-style: italic;">=</span> symbol <span style="color: #afafff; font-style: italic;">"*"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Mul</span>
   <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> symbol <span style="color: #afafff; font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Div</span>

<span style="color: #d7af00; font-weight: bold;">callP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> ident <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> parens (commaSep exprP)

<span style="color: #d7af00; font-weight: bold;">notP</span> <span style="font-weight: bold; font-style: italic;">=</span> reservedOp <span style="color: #afafff; font-style: italic;">"!"</span> <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> reserved <span style="color: #afafff; font-style: italic;">"not"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7">Statement parser</h3>
<div class="outline-text-3" id="text-2-7">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">stmtP</span> <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> <span style="font-weight: bold; text-decoration: underline;">Stmt</span>
<span style="color: #d7af00; font-weight: bold;">stmtP</span> <span style="font-weight: bold; font-style: italic;">=</span>   assignP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> blockP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> printP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> try ifElseP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> ifP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> whileP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> breakP
      <span style="font-weight: bold; font-style: italic;">&lt;|&gt;</span> continueP

<span style="color: #d7af00; font-weight: bold;">blockP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Block</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> braces (many stmtP)

<span style="color: #d7af00; font-weight: bold;">printP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Print</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> (reserved <span style="color: #afafff; font-style: italic;">"print"</span> <span style="font-weight: bold; font-style: italic;">&gt;&gt;</span> (commaSep exprP))

<span style="color: #d7af00; font-weight: bold;">assignP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">Assign</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> exprP <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> (reservedOp <span style="color: #afafff; font-style: italic;">":="</span> <span style="font-weight: bold; font-style: italic;">&gt;&gt;</span> exprP)

<span style="color: #d7af00; font-weight: bold;">ifP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">If</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> ((reserved <span style="color: #afafff; font-style: italic;">"if"</span>) <span style="font-weight: bold; font-style: italic;">&gt;&gt;</span> exprP) <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> stmtP <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Nothing</span>

<span style="color: #d7af00; font-weight: bold;">ifElseP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">If</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> ((reserved <span style="color: #afafff; font-style: italic;">"if"</span>) <span style="font-weight: bold; font-style: italic;">&gt;&gt;</span> exprP) <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> stmtP
                 <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> ((reserved <span style="color: #afafff; font-style: italic;">"else"</span>) <span style="font-weight: bold; font-style: italic;">*&gt;</span> (<span style="font-weight: bold; text-decoration: underline;">Just</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> stmtP))

<span style="color: #d7af00; font-weight: bold;">whileP</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="font-weight: bold; text-decoration: underline;">While</span> <span style="font-weight: bold; font-style: italic;">&lt;$&gt;</span> (reserved <span style="color: #afafff; font-style: italic;">"while"</span> <span style="font-weight: bold; font-style: italic;">&gt;&gt;</span> exprP) <span style="font-weight: bold; font-style: italic;">&lt;*&gt;</span> stmtP

<span style="color: #d7af00; font-weight: bold;">breakP</span> <span style="font-weight: bold; font-style: italic;">=</span> reserved <span style="color: #afafff; font-style: italic;">"break"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Break</span>

<span style="color: #d7af00; font-weight: bold;">continueP</span> <span style="font-weight: bold; font-style: italic;">=</span> reserved <span style="color: #afafff; font-style: italic;">"continue"</span> <span style="font-weight: bold; font-style: italic;">*&gt;</span> return <span style="font-weight: bold; text-decoration: underline;">Continue</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8">DSL Parser</h3>
<div class="outline-text-3" id="text-2-8">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">dslP</span> <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> [<span style="font-weight: bold; text-decoration: underline;">Stmt</span>]
<span style="color: #d7af00; font-weight: bold;">dslP</span> <span style="font-weight: bold; font-style: italic;">=</span> ws <span style="font-weight: bold; font-style: italic;">*&gt;</span> many stmtP <span style="font-weight: bold; font-style: italic;">&lt;*</span> eof
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9">Most problematic areas</h3>
<div class="outline-text-3" id="text-2-9">
<p>
With Parsec, it turns out to be important to order the parsers and
adorn them with <code>try</code>. This was most evident in <code>factorP</code>. Very
briefly, when there are two parsers one of which is a prefix of the
orher, the parser of the longer input should be listed first. If a
parser can fail after consuming some input, it should be wrapped in
<code>try</code> so that the next parser will be tried at the correct input
position.
</p>

<p>
Other than this, using Parsec to build parsers is pretty straightforward.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Test program</h2>
<div class="outline-text-2" id="text-3">
<p>
Here is test program that verifies the correctness of the parser. The
tokenizer seems to have a bug. It correctly parses "1.2" as <code>D 1.2</code>
but parses <code>-1.2</code> as <code>I (-1)</code>. I will defer this issue for now!
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Module imports</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Text.Parsec</span> (parseTest)
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Data.List</span> (intercalate)
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Text.Parsec.String</span>
<span style="color: #ff5f00; font-weight: bold;">import</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Expression tests</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Testing expression parsing.
</p>
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">exprTests</span> <span style="font-weight: bold; font-style: italic;">::</span> [(<span style="font-weight: bold; text-decoration: underline;">String</span>, <span style="font-weight: bold; text-decoration: underline;">Expr</span>)]
<span style="color: #d7af00; font-weight: bold;">exprTests</span> <span style="font-weight: bold; font-style: italic;">=</span> [(<span style="color: #afafff; font-style: italic;">"10"</span>, <span style="font-weight: bold; text-decoration: underline;">I</span> 10)
         , (<span style="color: #afafff; font-style: italic;">"-1"</span>, <span style="font-weight: bold; text-decoration: underline;">Neg</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1))
         , (<span style="color: #afafff; font-style: italic;">"- 1"</span>, <span style="font-weight: bold; text-decoration: underline;">Neg</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1))
         , (<span style="color: #afafff; font-style: italic;">"1.2"</span>, <span style="font-weight: bold; text-decoration: underline;">D</span> 1<span style="font-weight: bold; font-style: italic;">.</span>2)
         , (<span style="color: #afafff; font-style: italic;">"-1.2"</span>, <span style="font-weight: bold; text-decoration: underline;">Neg</span> (<span style="font-weight: bold; text-decoration: underline;">D</span> 1<span style="font-weight: bold; font-style: italic;">.</span>2))
         , (<span style="color: #afafff; font-style: italic;">"- 1.3"</span>, <span style="font-weight: bold; text-decoration: underline;">Neg</span> (<span style="font-weight: bold; text-decoration: underline;">D</span> 1<span style="font-weight: bold; font-style: italic;">.</span>3))
         , (<span style="color: #afafff; font-style: italic;">"a"</span>, <span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>)
         , (<span style="color: #afafff; font-style: italic;">"\"a\""</span>, <span style="font-weight: bold; text-decoration: underline;">S</span> <span style="color: #afafff; font-style: italic;">"a"</span>)
         , (<span style="color: #afafff; font-style: italic;">"true"</span>, <span style="font-weight: bold; text-decoration: underline;">T</span>)
         , (<span style="color: #afafff; font-style: italic;">"false"</span>, <span style="font-weight: bold; text-decoration: underline;">F</span>)
         , (<span style="color: #afafff; font-style: italic;">"1 + 2"</span>, <span style="font-weight: bold; text-decoration: underline;">Add</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">I</span> 2))
         , (<span style="color: #afafff; font-style: italic;">"1 + -2"</span>, <span style="font-weight: bold; text-decoration: underline;">Add</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">Neg</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 2)))
         , (<span style="color: #afafff; font-style: italic;">"1 + 2 * 3"</span>, <span style="font-weight: bold; text-decoration: underline;">Add</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">Mul</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 2) (<span style="font-weight: bold; text-decoration: underline;">I</span> 3)))
         , (<span style="color: #afafff; font-style: italic;">"1 - 2"</span>, <span style="font-weight: bold; text-decoration: underline;">Sub</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">I</span> 2))
         , (<span style="color: #afafff; font-style: italic;">"1 - 2 * 3"</span>, <span style="font-weight: bold; text-decoration: underline;">Sub</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">Mul</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 2) (<span style="font-weight: bold; text-decoration: underline;">I</span> 3)))
         , (<span style="color: #afafff; font-style: italic;">"1 + 2 * 3 / 4"</span>, <span style="font-weight: bold; text-decoration: underline;">Add</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">Div</span> (<span style="font-weight: bold; text-decoration: underline;">Mul</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 2) (<span style="font-weight: bold; text-decoration: underline;">I</span> 3)) (<span style="font-weight: bold; text-decoration: underline;">I</span> 4)))
         , (<span style="color: #afafff; font-style: italic;">"1 + a"</span>, <span style="font-weight: bold; text-decoration: underline;">Add</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>))
         , (<span style="color: #afafff; font-style: italic;">"1 = a"</span>, <span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>))
         , (<span style="color: #afafff; font-style: italic;">"1 = 2"</span>, <span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">I</span> 2))
         , (<span style="color: #afafff; font-style: italic;">"true and true"</span>, <span style="font-weight: bold; text-decoration: underline;">And</span> <span style="font-weight: bold; text-decoration: underline;">T</span> <span style="font-weight: bold; text-decoration: underline;">T</span>)
         , (<span style="color: #afafff; font-style: italic;">"true &amp; true"</span>, <span style="font-weight: bold; text-decoration: underline;">And</span> <span style="font-weight: bold; text-decoration: underline;">T</span> <span style="font-weight: bold; text-decoration: underline;">T</span>)
         , (<span style="color: #afafff; font-style: italic;">"true | true"</span>, <span style="font-weight: bold; text-decoration: underline;">Or</span> <span style="font-weight: bold; text-decoration: underline;">T</span> <span style="font-weight: bold; text-decoration: underline;">T</span>)
         , (<span style="color: #afafff; font-style: italic;">"true or true"</span>, <span style="font-weight: bold; text-decoration: underline;">Or</span> <span style="font-weight: bold; text-decoration: underline;">T</span> <span style="font-weight: bold; text-decoration: underline;">T</span>)
         , (<span style="color: #afafff; font-style: italic;">"1 = 2 &amp; 2 = 4"</span>, <span style="font-weight: bold; text-decoration: underline;">And</span> (<span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 1) (<span style="font-weight: bold; text-decoration: underline;">I</span> 2)) (<span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">I</span> 2) (<span style="font-weight: bold; text-decoration: underline;">I</span> 4)))
         , (<span style="color: #afafff; font-style: italic;">"a = b &amp; c = d"</span>, <span style="font-weight: bold; text-decoration: underline;">And</span> (<span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"b"</span>)) (<span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"c"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"d"</span>)))
         , (<span style="color: #afafff; font-style: italic;">"a = b | c = d"</span>, <span style="font-weight: bold; text-decoration: underline;">Or</span> (<span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"b"</span>)) (<span style="font-weight: bold; text-decoration: underline;">Eq</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"c"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"d"</span>)))
         , (<span style="color: #afafff; font-style: italic;">"(a | b) &amp; (c | d)"</span>, <span style="font-weight: bold; text-decoration: underline;">And</span> (<span style="font-weight: bold; text-decoration: underline;">Or</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"b"</span>)) (<span style="font-weight: bold; text-decoration: underline;">Or</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"c"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"d"</span>)))
         , (<span style="color: #afafff; font-style: italic;">"(a &amp; b) | (c &amp; d)"</span>, <span style="font-weight: bold; text-decoration: underline;">Or</span> (<span style="font-weight: bold; text-decoration: underline;">And</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"a"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"b"</span>)) (<span style="font-weight: bold; text-decoration: underline;">And</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"c"</span>) (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"d"</span>)))
         , (<span style="color: #afafff; font-style: italic;">"-(1.2)"</span>, <span style="font-weight: bold; text-decoration: underline;">Neg</span> (<span style="font-weight: bold; text-decoration: underline;">D</span> 1<span style="font-weight: bold; font-style: italic;">.</span>2))
         , (<span style="color: #afafff; font-style: italic;">"+(1.2)"</span>, <span style="font-weight: bold; text-decoration: underline;">D</span> 1<span style="font-weight: bold; font-style: italic;">.</span>2)
         , (<span style="color: #afafff; font-style: italic;">"not true"</span>, <span style="font-weight: bold; text-decoration: underline;">Not</span> <span style="font-weight: bold; text-decoration: underline;">T</span>)
         , (<span style="color: #afafff; font-style: italic;">"not not true"</span>, <span style="font-weight: bold; text-decoration: underline;">Not</span> (<span style="font-weight: bold; text-decoration: underline;">Not</span> <span style="font-weight: bold; text-decoration: underline;">T</span>))
         , (<span style="color: #afafff; font-style: italic;">"true = false"</span>, <span style="font-weight: bold; text-decoration: underline;">Eq</span> <span style="font-weight: bold; text-decoration: underline;">T</span> <span style="font-weight: bold; text-decoration: underline;">F</span>)
         , (<span style="color: #afafff; font-style: italic;">"foo()"</span>, <span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="color: #afafff; font-style: italic;">"foo"</span> <span style="font-weight: bold; text-decoration: underline;">[]</span>)
         , (<span style="color: #afafff; font-style: italic;">"foo(1)"</span>, <span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="color: #afafff; font-style: italic;">"foo"</span> [<span style="font-weight: bold; text-decoration: underline;">I</span> 1])
         , (<span style="color: #afafff; font-style: italic;">"foo(1, true)"</span>, <span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="color: #afafff; font-style: italic;">"foo"</span> [<span style="font-weight: bold; text-decoration: underline;">I</span> 1, <span style="font-weight: bold; text-decoration: underline;">T</span>])
         , (<span style="color: #afafff; font-style: italic;">"foo(1, 2)"</span>, <span style="font-weight: bold; text-decoration: underline;">Call</span> <span style="color: #afafff; font-style: italic;">"foo"</span> [<span style="font-weight: bold; text-decoration: underline;">I</span> 1, <span style="font-weight: bold; text-decoration: underline;">I</span> 2])
         ]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Statement tests</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Testing statement parsing.
</p>
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">stmtTests</span> <span style="font-weight: bold; font-style: italic;">::</span> [(<span style="font-weight: bold; text-decoration: underline;">String</span>, <span style="font-weight: bold; text-decoration: underline;">Stmt</span>)]
<span style="color: #d7af00; font-weight: bold;">stmtTests</span> <span style="font-weight: bold; font-style: italic;">=</span> [ (<span style="color: #afafff; font-style: italic;">"x := 1"</span>, <span style="font-weight: bold; text-decoration: underline;">Assign</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"x"</span>) (<span style="font-weight: bold; text-decoration: underline;">I</span> 1))
            , (<span style="color: #afafff; font-style: italic;">"print 1, 2"</span>, <span style="font-weight: bold; text-decoration: underline;">Print</span> [<span style="font-weight: bold; text-decoration: underline;">I</span> 1, <span style="font-weight: bold; text-decoration: underline;">I</span> 2])
            , (<span style="color: #afafff; font-style: italic;">"print 1"</span>, <span style="font-weight: bold; text-decoration: underline;">Print</span> [<span style="font-weight: bold; text-decoration: underline;">I</span> 1])
            , (<span style="color: #afafff; font-style: italic;">"{}"</span>, <span style="font-weight: bold; text-decoration: underline;">Block</span> <span style="font-weight: bold; text-decoration: underline;">[]</span>)
            , (<span style="color: #afafff; font-style: italic;">"if true print \"T\" else print \"F\""</span>,
               <span style="font-weight: bold; text-decoration: underline;">If</span> <span style="font-weight: bold; text-decoration: underline;">T</span> (<span style="font-weight: bold; text-decoration: underline;">Print</span> [<span style="font-weight: bold; text-decoration: underline;">S</span> <span style="color: #afafff; font-style: italic;">"T"</span>]) (<span style="font-weight: bold; text-decoration: underline;">Just</span> (<span style="font-weight: bold; text-decoration: underline;">Print</span> [<span style="font-weight: bold; text-decoration: underline;">S</span> <span style="color: #afafff; font-style: italic;">"F"</span>])))
            , (<span style="color: #afafff; font-style: italic;">"if true print 1"</span>, <span style="font-weight: bold; text-decoration: underline;">If</span> <span style="font-weight: bold; text-decoration: underline;">T</span> (<span style="font-weight: bold; text-decoration: underline;">Print</span> [<span style="font-weight: bold; text-decoration: underline;">I</span> 1]) <span style="font-weight: bold; text-decoration: underline;">Nothing</span>)
            , (<span style="color: #afafff; font-style: italic;">"break"</span>, <span style="font-weight: bold; text-decoration: underline;">Break</span>)
            , (<span style="color: #afafff; font-style: italic;">"continue"</span>, <span style="font-weight: bold; text-decoration: underline;">Continue</span>)
            ]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">Dsl tests</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Example DSL and its expected result.
</p>
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">dslTests</span> <span style="font-weight: bold; font-style: italic;">::</span> [(<span style="font-weight: bold; text-decoration: underline;">String</span>, [<span style="font-weight: bold; text-decoration: underline;">Stmt</span>])]
<span style="color: #d7af00; font-weight: bold;">dslTests</span> <span style="font-weight: bold; font-style: italic;">=</span>  [ (<span style="color: #afafff; font-style: italic;">"x := 1 y:= 2"</span>, [<span style="font-weight: bold; text-decoration: underline;">Assign</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"x"</span>) (<span style="font-weight: bold; text-decoration: underline;">I</span> 1), <span style="font-weight: bold; text-decoration: underline;">Assign</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"y"</span>) (<span style="font-weight: bold; text-decoration: underline;">I</span> 2)])
            , (<span style="color: #afafff; font-style: italic;">" x := 1 "</span>, [<span style="font-weight: bold; text-decoration: underline;">Assign</span> (<span style="font-weight: bold; text-decoration: underline;">V</span> <span style="color: #afafff; font-style: italic;">"x"</span>) (<span style="font-weight: bold; text-decoration: underline;">I</span> 1)])
            ]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5">Test runner</h3>
<div class="outline-text-3" id="text-3-5">
<p>
<code>testParser</code> accepts a list of input and expected results of parsing
them. Inputs that don't produce the expected results are printed.
</p>
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">testParser</span><span style="font-weight: bold; font-style: italic;">::</span> (<span style="font-weight: bold; text-decoration: underline;">Eq</span> a, <span style="font-weight: bold; text-decoration: underline;">Show</span> a) <span style="font-weight: bold; font-style: italic;">=&gt;</span> <span style="font-weight: bold; text-decoration: underline;">Parser</span> a <span style="font-weight: bold; font-style: italic;">-&gt;</span> [(<span style="font-weight: bold; text-decoration: underline;">String</span>, a)] <span style="font-weight: bold; font-style: italic;">-&gt;</span> <span style="font-weight: bold; text-decoration: underline;">IO</span> <span style="font-weight: bold; text-decoration: underline;">()</span>
<span style="color: #d7af00; font-weight: bold;">testParser</span> p tests <span style="font-weight: bold; font-style: italic;">=</span> <span style="color: #ff5f00; font-weight: bold;">do</span>
  putStr (intercalate <span style="color: #afafff; font-style: italic;">"\r\n"</span>
           (filter (not <span style="font-weight: bold; font-style: italic;">.</span> null)
             (map
               (<span style="font-weight: bold; font-style: italic;">\</span>(s, e, r) <span style="font-weight: bold; font-style: italic;">-&gt;</span> <span style="color: #ff5f00; font-weight: bold;">case</span> r <span style="color: #ff5f00; font-weight: bold;">of</span>
                  <span style="font-weight: bold; text-decoration: underline;">Right</span> ast <span style="font-weight: bold; font-style: italic;">-&gt;</span> <span style="color: #ff5f00; font-weight: bold;">if</span> e <span style="font-weight: bold; font-style: italic;">==</span> ast
                        <span style="color: #ff5f00; font-weight: bold;">then</span> <span style="color: #afafff; font-style: italic;">""</span> <span style="color: #008787; font-weight: bold; font-style: italic;">-- </span><span style="color: #008787; font-weight: bold; font-style: italic;">"Parsed: " ++  s</span>
                        <span style="color: #ff5f00; font-weight: bold;">else</span> <span style="color: #afafff; font-style: italic;">"Error: "</span> <span style="font-weight: bold; font-style: italic;">++</span> s <span style="font-weight: bold; font-style: italic;">++</span> <span style="color: #afafff; font-style: italic;">" Exp: "</span> <span style="font-weight: bold; font-style: italic;">++</span>
                              show e <span style="font-weight: bold; font-style: italic;">++</span> <span style="color: #afafff; font-style: italic;">" Act: "</span> <span style="font-weight: bold; font-style: italic;">++</span> show ast
                  <span style="font-weight: bold; text-decoration: underline;">Left</span> e <span style="font-weight: bold; font-style: italic;">-&gt;</span> <span style="color: #afafff; font-style: italic;">"Parse error: \n"</span> <span style="font-weight: bold; font-style: italic;">++</span> show e)
               (map (<span style="font-weight: bold; font-style: italic;">\</span>(s, e) <span style="font-weight: bold; font-style: italic;">-&gt;</span> (s, e, parse p s s)) tests))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6">Main program</h3>
<div class="outline-text-3" id="text-3-6">
<p>
Runs all tests defined above.
</p>
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #d7af00; font-weight: bold;">main</span> <span style="font-weight: bold; font-style: italic;">::</span> <span style="font-weight: bold; text-decoration: underline;">IO</span> <span style="font-weight: bold; text-decoration: underline;">()</span>
<span style="color: #d7af00; font-weight: bold;">main</span> <span style="font-weight: bold; font-style: italic;">=</span> <span style="color: #ff5f00; font-weight: bold;">do</span>
   testParser exprP exprTests
   testParser stmtP stmtTests
   testParser dslP dslTests
   putStr <span style="color: #afafff; font-style: italic;">"\nDONE!\n"</span>
</pre>
</div>
</div>
</div>
</div>
<div class="post-tags">Tags: <a href="/tags/#Haskell,">Haskell, </a><a href="/tags/#Parsec,">Parsec, </a><a href="/tags/#DSL">DSL </a></div></div><div id="related"><h3 class="random-posts">Random Posts</h3><ul class="posts"><li><span>23 Feb 2014</span><a href="/2014/02/23/rate-limited-fns/">core.async for throttling a Clojure function</a></li><li><span>19 Jun 2016</span><a href="/2016/06/19/Blogging/">Blogging with emacs and org-mode</a></li><li><span>27 Nov 2016</span><a href="/2016/11/27/ParsecParser/">Writing a parser using Parsec</a></li><li><span>25 Feb 2014</span><a href="/2014/02/25/Ubuntu-Network_trouble/">How to fix Wi-Fi connection issues in Ubuntu 13.04</a></li><li><span>26 Feb 2014</span><a href="/2014/02/26/JavaForkJoin/">Java Fork/Join Framework - an exemplar of elegant design</a></li></ul></div></div><div id="sidebar"><div style="border-bottom: solid 1px #ddd">PRAKI PRAKASH</div><div><img src="/images/praki-outline.png" style="float:left;padding:
                                                .5em" />I'm just an ordinary bloke! I like building things, real as well
     as imaginary. Check my instagram link below for my non-technical
     stuff.<span style="visibility: hidden">Maker, programmer, culinarian, but not necessarily in
      that order! Toiled at VMware, Yahoo, Westbridge and
      Arzoo. Recovering Java programmer, functional
      programming ideologue and Clojure practitioner. Maker of
      very thin wood shavings using antique hand
      tools. Inventor of delectable culinary chef d'uvre!</span></div><div style="padding-top: 1em; padding-bottom:1em"><a href="//github.com/MonadicT" style="text-decoration:none;" target="_top"><img alt="Github" src="/images/GitHub-Mark-32px.png" style="border:0;width:16px;height:16px;" title="GitHub" /></a>&nbsp;&nbsp;<a href="//plus.google.com/106671634457466903954?prsrc=3" rel="publisher" style="text-decoration:none;" target="_top"><img alt="Google+" src="//ssl.gstatic.com/images/icons/gplus-32.png" style="border:0;width:16px;height:16px;" title="Google+" /></a>&nbsp;&nbsp;<a href="https://twitter.com/MonadicT"><img alt="Twitter" src="/images/Twitter_logo_blue.png" style="border:0;width:16px;height:16PX" title="Twitter" /></a><a class="ig-b- ig-b-24" href="https://www.instagram.com/fgx3prak/?ref=badge"><img alt="Instagram" height="16px" src="//badges.instagram.com/static/images/ig-badge-16.png" style="padding-left:4px;width:16px;height:16px" width="16px" /></a><a href="/rss-feed" id="rss-feed"><img height="16px" src="/images/rss.png" width="16px" /></a></div><a class="twitter-timeline" data-widget-id="438551614102577152" href="https://twitter.com/MonadicT/favorites">Favorite Tweets by @MonadicT</a><script type="text/javascript">function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');</script></div></div><div id="footer"><p>&copy; 2013-2016<a href="http://MonadicT.github.io"> Praki Prakash</a></p></div></body></div></html>