<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MonadicT</title>
<meta name=generator content="GNU Emacs 25.3.1 (aarch64-unknown-linux-gnu, GTK+ Version 3.22.26)
 of 2017-12-09">
<meta name=author content="Praki Prakash">
<link href="blog-style.css" rel="stylesheet"/>
</head>
<body>
<div id="blog-header" class="margin-row"><div class="blog-margin-left"></div><div class="blog-margin-middle" id="xblog-header"><h1><div id="blog-title">MonadicT</div></h1><div>Search <form action="http://www.google.com/search" id="searchform"
method="get"><div><input class="box" id="s" name="q" type="text" />
<input name="sitesearch" type="hidden" value="http://MonadicT.github.io" />
</div></form></div></div><div class="blog-margin-right"></div></div>
<div id="blog-banner" class="margin-row"><div class="blog-margin-left"></div><div class="blog-margin-middle"><div  id="site-links"><a href="/index.html">Home</a><a href="/articles.html">Articles</a><a href="/about.html">About</a></div><div id="social-media-icons"><a target="_new" href="https://twitter.com/MonadicT">
<span style={background-color: white; height:48px;width:48px;border-radius:24px}></span>
<img height="48px" width="48px"
   title="Visit my Twitter page"
   src="/images/twitter.png"/></a><a id="github-link" target="_new"
  href="https://github.com/MonadicT"><img id="github-logo"
  height="48" width="48" src="/images/github.png"/></a></div></div><div class="blog-margin-right"></div></div> <div id="blog-content">
<div id="blog-content-left">

</div>
 <div id="blog-content-middle">

<div id="outline-container-org2b328b3" class="outline-2">
<h2 id="org2b328b3"><span class="section-number-2">1</span> Blog site generator</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org933a6a3" class="outline-3">
<h3 id="org933a6a3"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Org-mode has a flexible export framework which can be leveraged to
generate Html content suitable for publishing with Jekyll, a static
site generator. This post describes the elisp package I use to
maintain my blog at <a href="https://monadict.github.io">https://monadict.github.io</a>.
</p>

<p>
Blog entries are written as a regular <code>.org</code> file. A post should have
a <code>#+title</code>, <code>#+summary</code>, <code>#+publish_date</code>, <code>#+tags</code> and
<code>#+export_file_name</code> for proper formatting and structure. The
<code>export_file_name</code> header is used by Org-mode to create the generated
Html file.
</p>

<p>
The entire site with Home, About, Tags, RSS and all the posts can be
regenerated by <code>Meta blog-gen-publish</code>, also bound to <code>C-c C-g</code>. An
individual post can be quickly examined by invoking Org export menu
(<code>C-c C-e</code>) which shows the options for processing the buffer. <code>C-c
C-e</code> C-f will generate a HTML file.
</p>

<p>
If there is <code>#+publish-data</code> header, the post will be skipped when the
site is regenerated.
</p>

<p>
A new blog entry with all the required headers can be created by
executing <code>blog-gen-new-post</code>.
</p>
</div>
</div>

<div id="outline-container-orgfa8db4a" class="outline-3">
<h3 id="orgfa8db4a"><span class="section-number-3">1.2</span> Design description</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Customizable variables describe</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd23b5cf" class="outline-2">
<h2 id="orgd23b5cf"><span class="section-number-2">2</span> Implementation</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgfb4a829" class="outline-3">
<h3 id="orgfb4a829"><span class="section-number-3">2.1</span> Dependencies</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Not many! <code>yatl</code> is my Elisp package for generating Html fragments
from s-expressions.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(require 'cl)
(require 'yatl)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga198393" class="outline-3">
<h3 id="orga198393"><span class="section-number-3">2.2</span> Useful macros/functions</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgdc103f5" class="outline-4">
<h4 id="orgdc103f5"><span class="section-number-4">2.2.1</span> Assert utlity</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro assert-equal (actual expected)
  `(when (not (equal ,actual ,expected))
     (error "Actual: %s expected: %s"
            (format "%s" ',actual)
            (format "%s" ',expected))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org16325e3" class="outline-4">
<h4 id="org16325e3"><span class="section-number-4">2.2.2</span> Key-value string parser</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
Parses key-value string of form <i>@key=val@key=val</i>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-parse-kvp(s)
  (let (res)
    (mapconcat
     (lambda (kv-str)
       (let* ((kv (split-string kv-str "="))
              (key (car kv))
              (val (cadr kv))
              (val (if (string-match "^\".*\"$" val)
                       val
                     (format "\"%s\"" val))))
         (concat key "=" val)))
     (split-string s "@" t)
     " ")))

(assert-equal (blog-gen-parse-kvp "") "")
(assert-equal (blog-gen-parse-kvp "@") "")
(assert-equal (blog-gen-parse-kvp "@a=b") "a=\"b\"")
(assert-equal (blog-gen-parse-kvp "@a=b@c=d") "a=\"b\" c=\"d\"")

</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defmacro lisp (&amp;rest forms)
    `(let ((res ,@forms))
       res))

(assert-equal (lisp 1) 1)
(assert-equal (lisp (+ 1 2 3)) 6)
(assert-equal (lisp (concat "a" "n")) "an")
(assert-equal (lisp (list 1 2 3)) '(1 2 3))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgcb7f62e" class="outline-4">
<h4 id="orgcb7f62e"><span class="section-number-4">2.2.3</span> Parse element name</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
Parses element name and returns the list of element name, id, class
and attributes. Multiple class names but id must be unique. Id is
introdued by |?|, class name with |.| and attribute with |!|.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">;; Exanple names: div, div?id, div.cls1.clas2, div!k=v!k=v
(defun blog-gen-parse-elem-name(s)
  (let ((nm-id-cls (list '() '() '() '()))
        attrs idx buf)
    (setq  idx 0)
    (mapcar
     (lambda (c)
       (cond
        ((eq c ?.) (progn
                     (setq idx 2)
                     (push c (nth idx nm-id-cls))))
        ((eq c ??) (progn
                     (if (null (cadr nm-id-cls))
                         (setq idx 1)
                       (error "ID specified again!"))))
        ((eq c ?@) (progn
                     (setq idx 3)
                     (push c (nth idx nm-id-cls))))
        ((eq idx -1) (error "Expect one of \".,+,#'"))
        (t (push c (nth idx nm-id-cls)))))
     s)
    (list (concat (reverse (car nm-id-cls)))
          (concat (reverse (cadr nm-id-cls)))
          (concat (reverse (caddr nm-id-cls)))
          (blog-gen-parse-kvp (concat (reverse (nth 3 nm-id-cls)))))))

(assert-equal (blog-gen-parse-elem-name "div")
             '("div" "" "" ""))
(assert-equal (blog-gen-parse-elem-name "div?id")
             '("div" "id" "" ""))
(assert-equal (blog-gen-parse-elem-name "div?id.c1.c2")
             '("div" "id" ".c1.c2" ""))
(assert-equal (blog-gen-parse-elem-name "div?id.c1.c2@foo=bar@baz=qux")
               '("div" "id" ".c1.c2" "foo=\"bar\" baz=\"qux\""))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org6d838d5" class="outline-4">
<h4 id="org6d838d5"><span class="section-number-4">2.2.4</span> Return string representation</h4>
<div class="outline-text-4" id="text-2-2-4">
<div class="org-src-container">
<pre><code class="src src-elisp"> (defun blog-gen-as-string(o)
   (cond
    ((stringp o) o)
    ((numberp o) (number-to-string o))
    (t (symbol-name o))))

(as-string 1)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org922a947" class="outline-4">
<h4 id="org922a947"><span class="section-number-4">2.2.5</span> Convert a list to HTML element</h4>
<div class="outline-text-4" id="text-2-2-5">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-mk-elem(o)
  (cond
   ((and (listp o) (equal (car o) 'lisp))
    (let ((res (eval (cadr o))))
      res))
   ((listp o)
    (multiple-value-bind (nm id cls attrs) (blog-gen-parse-elem-name (symbol-name (car o)))
      (let* ((attrs (seq-filter
                     (lambda (s)
                       (and (symbolp s)
                            (s-starts-with? "@" (as-string s))))
                     (cdr o)))
             (children (seq-filter
                        (lambda (s)
                          (or (listp s)
                              (not (s-starts-with? "@" (as-string s)))))
                        (cdr o)))
             (attrs-s (mapconcat #'blog-gen-parse-kvp (mapcar #'symbol-name attrs) " "))
             (children-s (mapconcat #'blog-gen-mk-elem children " ")))
        (concat
         (format "&lt;%s" nm)
         (unless (string-empty-p id) (format " id=\"%s\"" id))
         (unless (string-empty-p cls) (format " class=\"%s\"" cls))
         (unless (string-empty-p attrs-s) (format " %s" attrs-s))
         (if (string-empty-p children-s)
             (format "/&gt;\n")
           (format "&gt;\n%s\n&lt;/%s&gt;\n" children-s nm))))))
   ((symbolp o) (symbol-name o))
   ((stringp o) o)
   (t (format "%S" o))))

(assert (string-equal (blog-gen-mk-elem "a")
                      "a"))

(assert (string-equal (blog-gen-mk-elem '(div))
                      "&lt;div/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(div?id))
                      "&lt;div id=\"id\"/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(div?id.c1.c2))
                      "&lt;div id=\"id\" class=\".c1.c2\"/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(div?id.c1 @foo=bar@fit=bit))
                      "&lt;div id=\"id\" class=\".c1\" foo=\"bar\" fit=\"bit\"/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(lisp ))
                     nil))

(assert (string-equal (blog-gen-mk-elem (lisp 1)) "1"))

(let ((foo "BAR"))
  (assert (string-equal (blog-gen-mk-elem '(lisp foo))
                        "BAR")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orge9e874f" class="outline-4">
<h4 id="orge9e874f"><span class="section-number-4">2.2.6</span> Generate HTML from list</h4>
<div class="outline-text-4" id="text-2-2-6">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro html(&amp;rest forms)
  `(concat
    "&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n"
    ,(mapconcat
      #'blog-gen-mk-elem
      forms
      "\n")
    "&lt;/html&gt;"))

(html
 (head
  (script @type=javascript @src=foo.js)
  (link @rel=stylesheet @href=https://www.w3schools.com/html/styles.css))
 (body
  "a,b"))

(html
 (lisp (format "%S" (+ 40 2))))

(html
 (body
  (div)
  (lisp (concat  "Hello," "world! " (current-time-string)))))
</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defmacro flex-row(&amp;rest forms)
    `(concat
      "&lt;div class={display:flex;flex-direction:row;width:100}&gt;"
      ,@forms
      "&lt;/div&gt;"))

  (defmacro flex-cell(flex-by &amp;rest forms)
    `(concat
      (format "&lt;div style={flex: %s}" ,flex-by)
      ,@forms
      "&lt;/div&gt;"))

  (flex-row (flex-cell 1) (flex-cell 2 org-version) (flex-cell 1))


(defmacro html-gen(&amp;rest forms)
  `(concat
    "&lt;html&gt;\n"
    ,@(mapconcat
      #'car
      forms
      "\n")
    "&lt;/html&gt;"))

(blog-gen-mk-elem '(html
           (head
            (script src=foo))
           (body)))

</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf9f048d" class="outline-3">
<h3 id="orgf9f048d"><span class="section-number-3">2.3</span> Variables</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre><code class="src src-elisp">(require 'ox-html)

 ;;; Variables and options

(defgroup org-export-blog nil
  "Options specific to RSS export back-end."
  :tag "Org Blog"
  :group 'org-export
  :version "24.4"
  :package-version '(Org . "9.0"))

(defcustom blog-gen-publish-url "http://MonadicT.github.io"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-title "MonadicT"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-author "Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-copyright-message "Copyright &amp;copy; 2014-%s, Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-style-file "blog-style.css"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-banner-file "banner.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-footer-file "footer.org"
  "???"
  :group 'org-export-blog
  :type 'string)

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org5eead3d" class="outline-3">
<h3 id="org5eead3d"><span class="section-number-3">2.4</span> Inner template generator</h3>
<div class="outline-text-3" id="text-2-4">
<p>
This function is called from Org-export machinery.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">
(defun blog-gen-inner-template (contents info)
  (mapconcat
   (lambda (x) (format "%s" x))
   (yatl-compile
    (body
     (blog-gen-top-matter)
     (div?blog-content
      (div?blog-content-left " ")
      (div?blog-content-middle
       contents)
      (div?blog-content-right))
     (div.blog-footer
      (format blog-gen-copyright-message
              (format-time-string "%Y")))))
   ""))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgfa41430" class="outline-3">
<h3 id="orgfa41430"><span class="section-number-3">2.5</span> twitter-link</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-twitter-link()
  "&lt;a target=\"_new\" href=\"https://twitter.com/MonadicT\"&gt;
&lt;span style={background-color: white; height:48px;width:48px;border-radius:24px}&gt;&lt;/span&gt;
&lt;img height=\"48px\" width=\"48px\"
   title=\"Visit my Twitter page\"
   src=\"/images/twitter.png\"/&gt;&lt;/a&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org4f55dd0" class="outline-3">
<h3 id="org4f55dd0"><span class="section-number-3">2.6</span> github-link</h3>
<div class="outline-text-3" id="text-2-6">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-github-link()
  "&lt;a id=\"github-link\" target=\"_new\"
  href=\"https://github.com/MonadicT\"&gt;&lt;img id=\"github-logo\"
  height=\"48\" width=\"48\" src=\"/images/github.png\"/&gt;&lt;/a&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org4015ef7" class="outline-3">
<h3 id="org4015ef7"><span class="section-number-3">2.7</span> Home link</h3>
<div class="outline-text-3" id="text-2-7">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-home-link()
  "&lt;a href=\"/index.html\"&gt;Home&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org54ec22a" class="outline-3">
<h3 id="org54ec22a"><span class="section-number-3">2.8</span> Articles link</h3>
<div class="outline-text-3" id="text-2-8">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-articles-link()
  "&lt;a href=\"/articles.html\"&gt;Articles&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org9b3a365" class="outline-3">
<h3 id="org9b3a365"><span class="section-number-3">2.9</span> About link</h3>
<div class="outline-text-3" id="text-2-9">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-about-link()
  "&lt;a href=\"/about.html\"&gt;About&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org2687eb0" class="outline-3">
<h3 id="org2687eb0"><span class="section-number-3">2.10</span> Site links</h3>
<div class="outline-text-3" id="text-2-10">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-site-links()
  (concat
   "&lt;div  id=\"site-links\"&gt;"
   (blog-gen-home-link)
   (blog-gen-articles-link)
   (blog-gen-about-link)
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org275b82a" class="outline-3">
<h3 id="org275b82a"><span class="section-number-3">2.11</span> top-matter</h3>
<div class="outline-text-3" id="text-2-11">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-top-matter()
  (concat
   "&lt;div id=\"blog-header\" class=\"margin-row\"&gt;"
   "&lt;div class=\"blog-margin-left\"&gt;&lt;/div&gt;"
   (format
    "&lt;div class=\"blog-margin-middle\" id=\"xblog-header\"&gt;&lt;h1&gt;&lt;div id=\"blog-title\"&gt;%s&lt;/div&gt;&lt;/h1&gt;%s&lt;/div&gt;"
    blog-gen-title
   (blog-gen-search-form))
   "&lt;div class=\"blog-margin-right\"&gt;"
   "&lt;/div&gt;"
    "&lt;/div&gt;\n"
    "&lt;div id=\"blog-banner\" class=\"margin-row\"&gt;"
    "&lt;div class=\"blog-margin-left\"&gt;"
    "&lt;/div&gt;"
    "&lt;div class=\"blog-margin-middle\"&gt;"
    (blog-gen-site-links)
    (blog-gen-social-media-icons)
    "&lt;/div&gt;"
    "&lt;div class=\"blog-margin-right\"&gt;&lt;/div&gt;"
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org4d96d98" class="outline-3">
<h3 id="org4d96d98"><span class="section-number-3">2.12</span> Search form</h3>
<div class="outline-text-3" id="text-2-12">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-search-form()
  "&lt;div&gt;Search &lt;form action=\"http://www.google.com/search\" id=\"searchform\"
method=\"get\"&gt;&lt;div&gt;&lt;input class=\"box\" id=\"s\" name=\"q\" type=\"text\" /&gt;
&lt;input name=\"sitesearch\" type=\"hidden\" value=\"http://MonadicT.github.io\" /&gt;
&lt;/div&gt;&lt;/form&gt;&lt;/div&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org139ddb7" class="outline-3">
<h3 id="org139ddb7"><span class="section-number-3">2.13</span> Social media icons</h3>
<div class="outline-text-3" id="text-2-13">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-social-media-icons()
  (concat
   "&lt;div id=\"social-media-icons\"&gt;"
   (blog-gen-twitter-link)
   (blog-gen-github-link)
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgf7edcc3" class="outline-3">
<h3 id="orgf7edcc3"><span class="section-number-3">2.14</span> Mode implementation</h3>
<div class="outline-text-3" id="text-2-14">
<div class="org-src-container">
<pre><code class="src src-elisp"> ;;; Define backend

(org-export-define-derived-backend 'blog 'html
  :menu-entry
  '(?b "Export to Blog"
       ((?b "As Blog buffer"
            (lambda (a s v b) (blog-gen-export-as-blog a s v)))
        (?f "As Blog file" (lambda (a s v b) (blog-gen-export-to-blog a s v)))
        (?o "As Blog file and open"
            (lambda (a s v b)
              (if a (blog-gen-export-to-blog t s v)
                (org-open-file (blog-gen-export-to-blog nil s v)))))))
  :options-alist
  '((:description "DESCRIPTION" nil nil newline)
    (:keywords "KEYWORDS" nil nil space)
    (:with-toc nil nil nil) ;; Never include HTML's toc
    )
  :filters-alist '((:filter-final-output . blog-gen-final-function))
  :translate-alist '((comment . (lambda (&amp;rest args) ""))
                     (comment-block . (lambda (&amp;rest args) ""))
                     (timestamp . (lambda (&amp;rest args) ""))
                     (inner-template . blog-gen-inner-template)
                     (template . blog-gen-template)))

 ;;; Export functions

 ;;;###autoload
(defun blog-gen-export-as-blog (&amp;optional async subtreep visible-only)
  "Export current buffer to a blog buffer.

 Export is done in a buffer named \"*Org Blog Export*\", which will
 be displayed when `org-export-show-temporary-export-buffer' is
 non-nil."
  (interactive)
  (let ((file (buffer-file-name (buffer-base-buffer)))))
  (org-export-to-buffer 'blog "*Org Blog Export*"
    async subtreep visible-only nil nil (lambda () (text-mode))))

 ;;;###autoload
(defun blog-gen-export-to-blog (&amp;optional async subtreep visible-only)
  "Export current buffer to a Blog file.
 Return output file's name."
  (interactive)
  (let ((file (buffer-file-name (buffer-base-buffer)))))
  (let ((outfile (org-export-output-file-name
                  (concat "." "html") subtreep)))
    (org-export-to-file 'blog outfile async subtreep visible-only)))

 ;;;###autoload
(defun blog-gen-publish-to-blog (plist filename pub-dir)
  "Publish an org file to Blog.

 FILENAME is the filename of the Org file to be published.  PLIST
 is the property list for the given project.  PUB-DIR is the
 publishing directory.

 Return output file name."
  (let ((bf (get-file-buffer filename)))
    (if bf
        (with-current-buffer bf
          (write-file filename))
      (find-file filename)
      (write-file filename) (kill-buffer)))
  (org-publish-org-too
   'log filename (concat "." "html") plist pub-dir))

 ;;; Main transcoding functions

(defun blog-gen-template (contents info)
  "Return complete document string after BLOG conversion.
 CONTENTS is the transcoded contents string.  INFO is a plist
 used as a communication channel."
  (concat
   "&lt;!DOCTYPE html&gt;\n"
   "&lt;html&gt;\n"
   "&lt;head&gt;\n"
   (format "&lt;meta charset=\"%s\"&gt;\n"
     (symbol-name org-html-coding-system))
   (format "&lt;title&gt;%s&lt;/title&gt;\n"
           blog-gen-title)
   (format "&lt;meta name=generator content=\"%s\"&gt;\n"
           (emacs-version))
   (format "&lt;meta name=author content=\"%s\"&gt;\n"
           blog-gen-author)
   (format "&lt;link href=\"blog-style.css\" rel=\"stylesheet\"/&gt;\n")
    "&lt;/head&gt;\n"
   contents
   "&lt;/html&gt;\n"))

 ;;; Filters

(defun blog-gen-final-function (contents backend info)
  "Prettify the Blog output."
  (with-temp-buffer
    (xml-mode)
    (insert contents)
    ;;(indent-region (point-min) (point-max))
    (buffer-substring-no-properties (point-min) (point-max))))

 ;;; Miscellaneous


(provide 'ox-blog)

 ;;; ox-blog.el ends here

</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">(require 'ox-html)
(defun my-html-body-filter(text backend info)
  text)

(add-to-list 'org-export-filter-body-functions
             'my-html-body-filter)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org89a9a5b" class="outline-3">
<h3 id="org89a9a5b"><span class="section-number-3">2.15</span> Org-file analyzer</h3>
<div class="outline-text-3" id="text-2-15">
</div>
<div id="outline-container-org1de9683" class="outline-4">
<h4 id="org1de9683"><span class="section-number-4">2.15.1</span> Return keywords from org-file</h4>
<div class="outline-text-4" id="text-2-15-1">
<p>
Returns list of OrgMode keywords from the current document.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-get-all-keywords()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (lambda (kw)
      (cons (org-element-property :key kw)
            (org-element-property :value kw)))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgf5eebf9" class="outline-4">
<h4 id="orgf5eebf9"><span class="section-number-4">2.15.2</span> Get keyword</h4>
<div class="outline-text-4" id="text-2-15-2">
<p>
Returns value of <code>key</code> or <code>default-value</code> if <code>key</code> doesn't exist in <code>keywords</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-get-keyword-value(keywords key &amp;optional default-value)
  (if-let ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5f8484" class="outline-3">
<h3 id="orge5f8484"><span class="section-number-3">2.16</span> Blog publishing</h3>
<div class="outline-text-3" id="text-2-16">
</div>
<div id="outline-container-orgaa3b2bf" class="outline-4">
<h4 id="orgaa3b2bf"><span class="section-number-4">2.16.1</span> Blog source directory</h4>
<div class="outline-text-4" id="text-2-16-1">
<p>
The root directory where the source for blogs is kept.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defcustom blog-gen-root-dir
  "~/stuff/github/MonadicT.github.io"
  "")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org48b0606" class="outline-4">
<h4 id="org48b0606"><span class="section-number-4">2.16.2</span> Blog posts directory</h4>
<div class="outline-text-4" id="text-2-16-2">
<p>
The subdirectory where <code>.org</code> files are stored.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defcustom blog-gen-posts-dir
  "_resources/posts"
  "")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org6ffd468" class="outline-4">
<h4 id="org6ffd468"><span class="section-number-4">2.16.3</span> Extract post details</h4>
<div class="outline-text-4" id="text-2-16-3">
<p>
Extracts post title, summary and <code>publish-date</code> from the file. Nil is
returned if <code>publish-date</code> is not present.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-post-details (f)
  (with-temp-buffer
    (find-file f)
    (let* ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  :test #'equal)))
      (puthash "title" (blog-gen-get-keyword-value kws "title" "") details)
      (puthash "summary" (blog-gen-get-keyword-value kws "summary" "") details)
      (puthash "publish-date" (blog-gen-get-keyword-value kws "publish-date" nil) details)
      (puthash "export_file_name" (blog-gen-get-keyword-value kws "export_file_name" nil) details)
      (puthash "tags" (blog-gen-get-keyword-value kws "tags" "") details)
      (puthash "target" (blog-gen-get-keyword-value kws "target" "") details)
      (unless (string-match "blog-generator.org" f) (kill-buffer))
      details)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org2bd6e8a" class="outline-4">
<h4 id="org2bd6e8a"><span class="section-number-4">2.16.4</span> Post files</h4>
<div class="outline-text-4" id="text-2-16-4">
<p>
Returns list of posts stored in <code>.org</code> files. <code>.org</code> files such as
<code>index.org</code>, <code>about.org</code> are not returned as posts.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-post-files()
  (let* ((posts-dir (concat blog-gen-root-dir "/" blog-gen-posts-dir))
         (org-files (directory-files posts-dir t "[a-ZA-Z0-9_-]*\\.org$"))
         (org-files
          (seq-remove
           (lambda (f)
             (or (string-match "index.org$" f)
                 (string-match "about.org$" f)
                 (string-match "sitemap.org$" f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org2f1328d" class="outline-4">
<h4 id="org2f1328d"><span class="section-number-4">2.16.5</span> Published post files</h4>
<div class="outline-text-4" id="text-2-16-5">
<p>
Returns published posts (posts which have <code>publish-date</code> keyword).
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-published-posts (posts)
  (seq-filter (lambda (p) (gethash "publish-date" p)) posts))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org00e9f38" class="outline-4">
<h4 id="org00e9f38"><span class="section-number-4">2.16.6</span> Order post files</h4>
<div class="outline-text-4" id="text-2-16-6">
<p>
Orders posts by <code>publish-date</code> descending.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-order-posts(posts)
  (seq-sort (lambda (a b) (string&gt; (gethash "publish-date" a) (gethash "publish-date" b))) posts))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org5110bef" class="outline-4">
<h4 id="org5110bef"><span class="section-number-4">2.16.7</span> Macro to generate <code>html_export</code> blocks</h4>
<div class="outline-text-4" id="text-2-16-7">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro html-export(&amp;rest content)
  `(progn (insert "#+BEGIN_EXPORT html\n")
          (insert ,@content)
          (insert "\n#+END_EXPORT\n\n")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgad84dd2" class="outline-4">
<h4 id="orgad84dd2"><span class="section-number-4">2.16.8</span> Articles generation</h4>
<div class="outline-text-4" id="text-2-16-8">
<p>
Exports all <code>.org</code> post files to <code>.html</code> files.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-posts()
  (let ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (lambda (post)
       (let ((export-file-name (gethash "export_file_name" post)))
         (when export-file-name
           (message export-file-name)
           (org-export-to-file 'blog export-file-name))))
     posts)))
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org6ff21ee" class="outline-4">
<h4 id="org6ff21ee"><span class="section-number-4">2.16.9</span> Articles page generation</h4>
<div class="outline-text-4" id="text-2-16-9">
<p>
Generates list of articles.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-articles()
  (with-temp-buffer
    (find-file "index.org")
    (erase-buffer)
    (insert "#+title: MonadictT\n")
    (insert "#+options: num:nil html-style:nil\n")
    (insert "* Posts\n")
    (let ((posts (blog-gen-order-posts
                  (blog-gen-published-posts
                   (blog-gen-post-files)))))
      (mapcar
       (lambda (post)
         (let* ((title (gethash "title" post))
                (summary (gethash "summary"  post))
                (export-file-name (gethash "export_file_name"  post))
                (export-file-name
                 (let ((href export-file-name))
                   (while (string-match "^\\.\\./" href)
                     (setq href (substring href 3)))
                   href))
                (publish-date (gethash "publish-date" post))
                (l (list (make-symbol (format "a@href=\"/%s\"" export-file-name)) title)))
           (html-export
            (yatl-html-frag
             (div.post-title
              (eval (yatl-compile-fn l)))))
           (html-export
            (yatl-html-frag
             (div.post-summary summary)) "\n\n")
           (html-export
            (yatl-html-frag
             (div.post-publish-date "Published: " publish-date)) "\n")))
       posts))
    (save-buffer)
    (org-export-to-file 'blog "../../articles.html")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgc00c990" class="outline-4">
<h4 id="orgc00c990"><span class="section-number-4">2.16.10</span> About page generation.</h4>
<div class="outline-text-4" id="text-2-16-10">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-about()
  (with-temp-buffer
    (find-file "about.org")
    (org-export-to-file 'blog "../../about.html")
    (kill-buffer)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org3cece45" class="outline-4">
<h4 id="org3cece45"><span class="section-number-4">2.16.11</span> Home page generation</h4>
<div class="outline-text-4" id="text-2-16-11">
<p>
For now, <i>Home</i> points to <i>Articles</i>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-home()
  (copy-file "../../articles.html" "../../index.html" t))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org014c004" class="outline-4">
<h4 id="org014c004"><span class="section-number-4">2.16.12</span> Generates blog,</h4>
<div class="outline-text-4" id="text-2-16-12">
<p>
Function to regenerate the full site. This is bound to <code>C-c C-g</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-publish()
  (interactive)
  (blog-gen-create-posts)
  (blog-gen-create-articles)
  (blog-gen-create-about)
  (blog-gen-create-home))
(global-set-key (kbd "C-c C-g") #'blog-gen-publish)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org5a9f900" class="outline-4">
<h4 id="org5a9f900"><span class="section-number-4">2.16.13</span> Blog template</h4>
<div class="outline-text-4" id="text-2-16-13">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-new-post()
  (interactive)
  (insert "#+title: TBD\n
#+options: toc:nil num: nil\n"))

</code></pre>
</div>
</div>
</div>
</div>
</div>

</div>
 <div id="blog-content-right"/>

</div>
 <div class=" blog-footer">
Copyright &copy; 2014-2018, Praki Prakash
</div>

</body>
</html>
