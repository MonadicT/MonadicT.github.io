<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8>"/>
 <title>
MonadicT
</title>
 <base href="https://MonadicT.github.io/"/>
 <meta name="generator" content="GNU Emacs 26.1 (build 1, x86_64-apple-darwin14.5.0, NS appkit-1348.17 Version 10.10.5 (Build 14F2511))
 of 2018-05-28>"/>
 <meta name="author" content="Praki Prakash"/>
 <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|EB+Garamond:800|Roboto:100,300,400,400i,700" rel="stylesheet"> <link href="blog-style.css" rel="stylesheet"/>

</head>
<body>
<div style="display:flex">
<div style="flex:2">

</div>
 <div style="flex:6">
<div>
<div class=" blog-nav">
<div id="blog-title">
MonadicT <div id="tagline">
I see dead objects!
</div>

</div>
 <div>Search <form action="http://www.google.com/search" id="searchform"
method="get"><div><input class="box" id="s" name="q" type="text" />
<input name="sitesearch" type="hidden" value="http://MonadicT.github.io" />
</div></form></div>
</div>
<div class=" blog-nav">
<div  id="site-links"><a href="/index.html">Home</a><a href="/articles.html">Articles</a><a href="/tags.html">Tags</a><a href="/about.html">About</a></div> <div id="social-media-icons"><a target="_new" href="https://twitter.com/MonadicT">
  <span style={background-color: white; height:2em;width:2em;border-radius:24px}></span>
  <img height="48px" width="48px"
     title="Visit my Twitter page"
     src="/images/twitter.png"/></a><a id="github-link" target="_new"
  href="https://github.com/MonadicT"><img id="github-logo"
  src="/images/github-logo.png"/></a></div>
</div>
<div style="border:1px">

</div>
 
<div id="outline-container-org46e6fde" class="outline-2">
<h2 id="org46e6fde">Blog site generator</h2>
<div class="outline-text-2" id="text-org46e6fde">
</div>
<div id="outline-container-org0ddd89c" class="outline-3">
<h3 id="org0ddd89c">Overview</h3>
<div class="outline-text-3" id="text-org0ddd89c">
<p>
Org-mode has a flexible export framework which can be leveraged to
generate Html content suitable for publishing with Jekyll, a static
site generator. This post describes the elisp package which is used to
maintain my blog at <a href="https://monadict.github.io">MonadicT.github.io</a>.
</p>

<p>
Blog entries are written as a regular <code>.org</code> file. A post should have
a <code>#+title</code>, <code>#+summary</code>, <code>#+publish_date</code>, <code>#+tags</code> and
<code>#+export_file_name</code> for proper formatting and structure. The
<code>export_file_name</code> header is used by Org-mode to create the generated
Html file.
</p>

<p>
The entire site with Home, About, Tags, RSS and all the posts can be
regenerated by <code>Meta blog-gen-publish</code>, also bound to <code>C-c C-g</code>. An
individual post can be quickly examined by invoking Org export menu
(<code>C-c C-e</code>) which shows the options for processing the buffer. <code>C-c
C-e</code> C-f will generate a HTML file.
</p>

<p>
If there is no <code>#+publish-date</code> header, the post will be skipped when
the site is regenerated.
</p>

<p>
A new blog entry with all the required headers can be created by
executing <code>blog-gen-new-post</code>.
</p>
</div>
</div>

<div id="outline-container-org7f31eaf" class="outline-3">
<h3 id="org7f31eaf">Design description</h3>
<div class="outline-text-3" id="text-org7f31eaf">
<ul class="org-ul">
<li>Customizable variables describe</li>
</ul>
</div>
</div>
<div id="outline-container-org91eb8ee" class="outline-3">
<h3 id="org91eb8ee">Implementation</h3>
<div class="outline-text-3" id="text-org91eb8ee">
</div>
<div id="outline-container-org4254240" class="outline-4">
<h4 id="org4254240">Dependencies</h4>
<div class="outline-text-4" id="text-org4254240">
<p>
Not many! <code>yatl</code> is my Elisp package for generating Html fragments
from s-expressions.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">require</span> '<span class="org-constant">cl</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">subr-x</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">s</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">yatl</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f8f239" class="outline-4">
<h4 id="org3f8f239">Useful macros/functions</h4>
</div>
<div id="outline-container-org4dae495" class="outline-4">
<h4 id="org4dae495">Assert utility</h4>
<div class="outline-text-4" id="text-org4dae495">
<p>
A quick little macro to write assertions.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">assert-equal</span> (actual expected)
  `(<span class="org-keyword">when</span> (not (equal ,actual ,expected))
     (<span class="org-warning">error</span> <span class="org-string">"Actual: %s expected: %s"</span>
            (format <span class="org-string">"%s"</span> ',actual)
            (format <span class="org-string">"%s"</span> ',expected))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb732665" class="outline-4">
<h4 id="orgb732665">Key-value string parser</h4>
<div class="outline-text-4" id="text-orgb732665">
<p>
Parses key-value string of form <i>@key=val@key=val</i>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-parse-kvp</span>(s)
  (<span class="org-keyword">let</span> (res)
    (mapconcat
     (<span class="org-keyword">lambda</span> (kv-str)
       (<span class="org-keyword">let*</span> ((kv (split-string kv-str <span class="org-string">"="</span>))
              (key (car kv))
              (val (cadr kv))
              (val (<span class="org-keyword">if</span> (string-match <span class="org-string">"^\".*\"$"</span> val)
                       val
                     (format <span class="org-string">"\"%s\""</span> val))))
         (concat key <span class="org-string">"="</span> val)))
     (split-string s <span class="org-string">"@"</span> t)
     <span class="org-string">" "</span>)))

(<span class="org-keyword">assert-equal</span> (blog-gen-parse-kvp <span class="org-string">""</span>) <span class="org-string">""</span>)
(<span class="org-keyword">assert-equal</span> (blog-gen-parse-kvp <span class="org-string">"@"</span>) <span class="org-string">""</span>)
(<span class="org-keyword">assert-equal</span> (blog-gen-parse-kvp <span class="org-string">"@a=b"</span>) <span class="org-string">"a=\"b\""</span>)
(<span class="org-keyword">assert-equal</span> (blog-gen-parse-kvp <span class="org-string">"@a=b@c=d"</span>) <span class="org-string">"a=\"b\" c=\"d\""</span>)

</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp">  (<span class="org-keyword">defmacro</span> <span class="org-function-name">lisp</span> (<span class="org-type">&amp;rest</span> forms)
    `(<span class="org-keyword">let</span> ((res ,@forms))
       res))

(<span class="org-keyword">assert-equal</span> (<span class="org-keyword">lisp</span> 1) 1)
(<span class="org-keyword">assert-equal</span> (<span class="org-keyword">lisp</span> (+ 1 2 3)) 6)
(<span class="org-keyword">assert-equal</span> (<span class="org-keyword">lisp</span> (concat <span class="org-string">"a"</span> <span class="org-string">"n"</span>)) <span class="org-string">"an"</span>)
(<span class="org-keyword">assert-equal</span> (<span class="org-keyword">lisp</span> (list 1 2 3)) '(1 2 3))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgffff876" class="outline-4">
<h4 id="orgffff876">Parse element name</h4>
<div class="outline-text-4" id="text-orgffff876">
<p>
Parses element name and returns the list of element name, id, class
and attributes. Multiple class names but id must be unique. Id is
introduced by <code>?</code>, class name with <code>.</code> and attribute with <code>@</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">Exanple names: div, div?id, div.cls1.clas2, div!k=v!k=v</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-parse-elem-name</span>(s)
  (<span class="org-keyword">let</span> ((nm-id-cls (list '() '() '() '()))
        attrs idx buf)
    (<span class="org-keyword">setq</span>  idx 0)
    (mapcar
     (<span class="org-keyword">lambda</span> (c)
       (<span class="org-keyword">cond</span>
        ((eq c ?.) (<span class="org-keyword">progn</span>
                     (<span class="org-keyword">setq</span> idx 2)
                     (<span class="org-keyword">push</span> c (nth idx nm-id-cls))))
        ((eq c ??) (<span class="org-keyword">progn</span>
                     (<span class="org-keyword">if</span> (null (cadr nm-id-cls))
                         (<span class="org-keyword">setq</span> idx 1)
                       (<span class="org-warning">error</span> <span class="org-string">"ID specified again!"</span>))))
        ((eq c ?@) (<span class="org-keyword">progn</span>
                     (<span class="org-keyword">setq</span> idx 3)
                     (<span class="org-keyword">push</span> c (nth idx nm-id-cls))))
        ((eq idx -1) (<span class="org-warning">error</span> <span class="org-string">"Expect one of \".,+,#'"</span>))
        (t (<span class="org-keyword">push</span> c (nth idx nm-id-cls)))))
     s)
    (list (concat (reverse (car nm-id-cls)))
          (concat (reverse (cadr nm-id-cls)))
          (concat (reverse (caddr nm-id-cls)))
          (blog-gen-parse-kvp (concat (reverse (nth 3 nm-id-cls)))))))

(<span class="org-keyword">assert-equal</span> (blog-gen-parse-elem-name <span class="org-string">"div"</span>)
             '(<span class="org-string">"div"</span> <span class="org-string">""</span> <span class="org-string">""</span> <span class="org-string">""</span>))
(<span class="org-keyword">assert-equal</span> (blog-gen-parse-elem-name <span class="org-string">"div?id"</span>)
             '(<span class="org-string">"div"</span> <span class="org-string">"id"</span> <span class="org-string">""</span> <span class="org-string">""</span>))
(<span class="org-keyword">assert-equal</span> (blog-gen-parse-elem-name <span class="org-string">"div?id.c1.c2"</span>)
             '(<span class="org-string">"div"</span> <span class="org-string">"id"</span> <span class="org-string">".c1.c2"</span> <span class="org-string">""</span>))
(<span class="org-keyword">assert-equal</span> (blog-gen-parse-elem-name <span class="org-string">"div?id.c1.c2@foo=bar@baz=qux"</span>)
               '(<span class="org-string">"div"</span> <span class="org-string">"id"</span> <span class="org-string">".c1.c2"</span> <span class="org-string">"foo=\"bar\" baz=\"qux\""</span>))

</pre>
</div>
</div>
</div>

<div id="outline-container-org59adc65" class="outline-4">
<h4 id="org59adc65">Custom Variables</h4>
<div class="outline-text-4" id="text-org59adc65">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">require</span> '<span class="org-constant">ox-html</span>)

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">Variables and options</span>

(<span class="org-keyword">defgroup</span> <span class="org-type">org-export-blog</span> nil
  <span class="org-doc">"Options specific to RSS export back-end."</span>
  <span class="org-builtin">:tag</span> <span class="org-string">"Org Blog"</span>
  <span class="org-builtin">:group</span> 'org-export
  <span class="org-builtin">:version</span> <span class="org-string">"24.4"</span>
  <span class="org-builtin">:package-version</span> '(Org . <span class="org-string">"9.0"</span>))

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-publish-url</span> <span class="org-string">"https://MonadicT.github.io"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-title</span> <span class="org-string">"MonadicT"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-tagline</span> <span class="org-string">"I see dead objects!"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-author</span> <span class="org-string">"Praki Prakash"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-copyright-message</span> <span class="org-string">"Copyright &amp;copy; 2014-%s, Praki Prakash"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-style-file</span> <span class="org-string">"blog-style.css"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-banner-file</span> <span class="org-string">"banner.org"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-footer-file</span> <span class="org-string">"footer.org"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

</pre>
</div>
</div>
</div>

<div id="outline-container-org538cff3" class="outline-4">
<h4 id="org538cff3">Inner template generator</h4>
<div class="outline-text-4" id="text-org538cff3">
<p>
This function is called from Org-export machinery. The main content of
the article is wrapped up as a full blog page.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-inner-template</span> (contents info)
   (<span class="org-keyword">yatl-html-frag</span>
    (body
     (div@style=display:flex
      (div@style=flex:2 <span class="org-string">""</span>)
      (div@style=flex:6
       (div
        (blog-gen-top-matter)
        contents))
      (div@style=flex:2 <span class="org-string">""</span>)
      (div.blog-footer
       (format blog-gen-copyright-message
               (format-time-string <span class="org-string">"%Y"</span>)))))))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgb73d74b" class="outline-4">
<h4 id="orgb73d74b">Twitter link</h4>
<div class="outline-text-4" id="text-orgb73d74b">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-twitter-link</span>()
  <span class="org-doc">"&lt;a target=\"_new\" href=\"https://twitter.com/MonadicT\"&gt;</span>
<span class="org-doc">&lt;span style={background-color: white; height:48px;width:48px;border-radius:24px}&gt;&lt;/span&gt;</span>
<span class="org-doc">&lt;img height=\"48px\" width=\"48px\"</span>
<span class="org-doc">   title=\"Visit my Twitter page\"</span>
<span class="org-doc">   src=\"/images/twitter.png\"/&gt;&lt;/a&gt;"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e2c346" class="outline-4">
<h4 id="org9e2c346">Github link</h4>
<div class="outline-text-4" id="text-org9e2c346">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-github-link</span>()
  <span class="org-doc">"&lt;a id=\"github-link\" target=\"_new\"</span>
<span class="org-doc">  href=\"https://github.com/MonadicT\"&gt;&lt;img id=\"github-logo\"</span>
<span class="org-doc">  src=\"/images/github-logo.png\"/&gt;&lt;/a&gt;"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgede6583" class="outline-4">
<h4 id="orgede6583">Home link</h4>
<div class="outline-text-4" id="text-orgede6583">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-home-link</span>()
  <span class="org-doc">"&lt;a href=\"/index.html\"&gt;Home&lt;/a&gt;"</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-orgaada027" class="outline-4">
<h4 id="orgaada027">Articles link</h4>
<div class="outline-text-4" id="text-orgaada027">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-articles-link</span>()
  <span class="org-doc">"&lt;a href=\"/articles.html\"&gt;Articles&lt;/a&gt;"</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-orga64532d" class="outline-4">
<h4 id="orga64532d">About link</h4>
<div class="outline-text-4" id="text-orga64532d">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-about-link</span>()
  <span class="org-doc">"&lt;a href=\"/about.html\"&gt;About&lt;/a&gt;"</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-org0510b5f" class="outline-4">
<h4 id="org0510b5f">Tags link</h4>
<div class="outline-text-4" id="text-org0510b5f">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-tags-link</span>()
  <span class="org-doc">"&lt;a href=\"/tags.html\"&gt;Tags&lt;/a&gt;"</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-org495a26f" class="outline-4">
<h4 id="org495a26f">Site links</h4>
<div class="outline-text-4" id="text-org495a26f">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-site-links</span>()
  (concat
   <span class="org-string">"&lt;div  id=\"site-links\"&gt;"</span>
   (blog-gen-home-link)
   (blog-gen-articles-link)
   (blog-gen-tags-link)
   (blog-gen-about-link)
   <span class="org-string">"&lt;/div&gt;"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org11d3f45" class="outline-4">
<h4 id="org11d3f45">Top matter</h4>
<div class="outline-text-4" id="text-org11d3f45">
<p>
Generates the header and the banner. Here is one limitation of
<code>yatl-compile-string</code> which can generate a single element with dynamic
content but not nested elements as needed here.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-top-matter</span>()
  (<span class="org-keyword">yatl-html-frag</span>
   (div.blog-nav
    (div?blog-title
     blog-gen-title
     (div?tagline blog-gen-tagline))
    (blog-gen-search-form))
   (div.blog-nav
    (blog-gen-site-links)
    (blog-gen-social-media-icons))
   (div@style=border:1px <span class="org-string">""</span>)))

</pre>
</div>
</div>
</div>

<div id="outline-container-org39e82de" class="outline-4">
<h4 id="org39e82de">Search form</h4>
<div class="outline-text-4" id="text-org39e82de">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-search-form</span>()
  <span class="org-doc">"&lt;div&gt;Search &lt;form action=\"http://www.google.com/search\" id=\"searchform\"</span>
<span class="org-doc">method=\"get\"&gt;&lt;div&gt;&lt;input class=\"box\" id=\"s\" name=\"q\" type=\"text\" /&gt;</span>
<span class="org-doc">&lt;input name=\"sitesearch\" type=\"hidden\" value=\"http://MonadicT.github.io\" /&gt;</span>
<span class="org-doc">&lt;/div&gt;&lt;/form&gt;&lt;/div&gt;"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6212ce6" class="outline-4">
<h4 id="org6212ce6">Social media icons</h4>
<div class="outline-text-4" id="text-org6212ce6">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-social-media-icons</span>()
  (concat
   <span class="org-string">"&lt;div id=\"social-media-icons\"&gt;"</span>
   (blog-gen-twitter-link)
   (blog-gen-github-link)
   <span class="org-string">"&lt;/div&gt;"</span>))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1515ca6" class="outline-3">
<h3 id="org1515ca6">Mode implementation</h3>
<div class="outline-text-3" id="text-org1515ca6">
<div class="org-src-container">
<pre class="src src-elisp"> <span class="org-comment-delimiter">;;; </span><span class="org-comment">Define backend</span>

(org-export-define-derived-backend 'blog 'html
  <span class="org-builtin">:menu-entry</span>
  '(?b <span class="org-string">"Export to Blog"</span>
       ((?b <span class="org-string">"As Blog buffer"</span>
            (<span class="org-keyword">lambda</span> (a s v b) (blog-gen-export-as-blog a s v)))
        (?f <span class="org-string">"As Blog file"</span> (<span class="org-keyword">lambda</span> (a s v b) (blog-gen-export-to-blog a s v)))
        (?o <span class="org-string">"As Blog file and open"</span>
            (<span class="org-keyword">lambda</span> (a s v b)
              (<span class="org-keyword">if</span> a (blog-gen-export-to-blog t s v)
                (org-open-file (blog-gen-export-to-blog nil s v)))))))
  <span class="org-builtin">:options-alist</span>
  '((<span class="org-builtin">:description</span> <span class="org-string">"DESCRIPTION"</span> nil nil newline)
    (<span class="org-builtin">:keywords</span> <span class="org-string">"KEYWORDS"</span> nil nil space)
    (<span class="org-builtin">:with-toc</span> nil nil nil) <span class="org-comment-delimiter">;; </span><span class="org-comment">Never include HTML's toc</span>
    )
  <span class="org-builtin">:filters-alist</span> '((<span class="org-builtin">:filter-final-output</span> . blog-gen-final-function))
  <span class="org-builtin">:translate-alist</span> '((comment . (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> args) <span class="org-doc">""</span>))
                     (comment-block . (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> args) <span class="org-doc">""</span>))
                     (timestamp . (<span class="org-keyword">lambda</span> (<span class="org-type">&amp;rest</span> args) <span class="org-doc">""</span>))
                     (inner-template . blog-gen-inner-template)
                     (template . blog-gen-template)))

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">Export functions</span>

 <span class="org-comment-delimiter">;;;</span><span class="org-comment">###autoload</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-export-as-blog</span> (<span class="org-type">&amp;optional</span> async subtreep visible-only)
  <span class="org-doc">"Export current buffer to a blog buffer.</span>

<span class="org-doc"> Export is done in a buffer named \"*Org Blog Export*\", which will</span>
<span class="org-doc"> be displayed when `</span><span class="org-doc"><span class="org-constant">org-export-show-temporary-export-buffer</span></span><span class="org-doc">' is</span>
<span class="org-doc"> non-nil."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((file (buffer-file-name (buffer-base-buffer)))))
  (org-export-to-buffer 'blog <span class="org-string">"*Org Blog Export*"</span>
    async subtreep visible-only nil nil (<span class="org-keyword">lambda</span> () (text-mode))))

 <span class="org-comment-delimiter">;;;</span><span class="org-comment">###autoload</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-export-to-blog</span> (<span class="org-type">&amp;optional</span> async subtreep visible-only)
  <span class="org-doc">"Export current buffer to a Blog file.</span>
<span class="org-doc"> Return output file's name."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((file (buffer-file-name (buffer-base-buffer)))))
  (<span class="org-keyword">let</span> ((outfile (org-export-output-file-name
                  (concat <span class="org-string">"."</span> <span class="org-string">"html"</span>) subtreep)))
    (org-export-to-file 'blog outfile async subtreep visible-only)))

 <span class="org-comment-delimiter">;;;</span><span class="org-comment">###autoload</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-publish-to-blog</span> (plist filename pub-dir)
  <span class="org-doc">"Publish an org file to Blog.</span>

<span class="org-doc"> FILENAME is the filename of the Org file to be published.  PLIST</span>
<span class="org-doc"> is the property list for the given project.  PUB-DIR is the</span>
<span class="org-doc"> publishing directory.</span>

<span class="org-doc"> Return output file name."</span>
  (<span class="org-keyword">let</span> ((bf (get-file-buffer filename)))
    (<span class="org-keyword">if</span> bf
        (<span class="org-keyword">with-current-buffer</span> bf
          (write-file filename))
      (find-file filename)
      (write-file filename) (kill-buffer)))
  (org-publish-org-too
   'log filename (concat <span class="org-string">"."</span> <span class="org-string">"html"</span>) plist pub-dir))

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">Main transcoding functions</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-template</span> (contents info)
  <span class="org-doc">"Return complete document string after BLOG conversion.</span>
<span class="org-doc"> CONTENTS is the transcoded contents string.  INFO is a plist</span>
<span class="org-doc"> used as a communication channel."</span>
  (<span class="org-keyword">yatl-html5</span>
   (head
    (yatl-compile-string <span class="org-string">"meta@charset=\"%s\"&gt;"</span>
            (symbol-name org-html-coding-system))
    (title blog-gen-title)
    (yatl-compile-string
     <span class="org-string">"base@href=\"%s\""</span>
     (blog-gen-base-url))
    (yatl-compile-string <span class="org-string">"meta@name=generator@content=\"%s\"&gt;"</span> (emacs-version))
    (yatl-compile-string <span class="org-string">"meta@name=author@content=\"%s\""</span> blog-gen-author)
    <span class="org-string">"&lt;link href=\"https://fonts.googleapis.com/css?family=Source+Code+Pro|EB+Garamond:800|Roboto:100,300,400,400i,700\" rel=\"stylesheet\"&gt;"</span>
    (link@href=\"blog-style.css\"@rel=\"stylesheet\"))
   contents))

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">Filters</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-final-function</span> (contents backend info)
  <span class="org-doc">"Prettify the Blog output."</span>
  (<span class="org-keyword">with-temp-buffer</span>
    (xml-mode)
    (insert contents)
    <span class="org-comment-delimiter">;;</span><span class="org-comment">(indent-region (point-min) (point-max))</span>
    (buffer-substring-no-properties (point-min) (point-max))))

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">Miscellaneous</span>


(<span class="org-keyword">provide</span> '<span class="org-constant">ox-blog</span>)

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">ox-blog.el ends here</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">require</span> '<span class="org-constant">ox-html</span>)
(<span class="org-keyword">defun</span> <span class="org-function-name">my-html-body-filter</span>(text backend info)
  text)

(add-to-list 'org-export-filter-body-functions
             'my-html-body-filter)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgadd0335" class="outline-3">
<h3 id="orgadd0335">Styles</h3>
<div class="outline-text-3" id="text-orgadd0335">
<p>
CSS Styles used in this blog are managed using interpolated
strings. The code below is an association list which is used to build
CSS string later.
</p>

<p>
Font sizes are specified in <i>percent</i> units which makes the content scalable.
</p>
</div>

<div id="outline-container-org2e0fd4c" class="outline-4">
<h4 id="org2e0fd4c">Color definitions</h4>
<div class="outline-text-4" id="text-org2e0fd4c">
<p>
CSS color definitions.
</p>

<ul class="org-ul">
<li>Dark primary color.</li>
</ul>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#616161</span>
</pre>
</div>

<ul class="org-ul">
<li>Default primary color</li>
</ul>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#9E9E9E</span>
</pre>
</div>

<ul class="org-ul">
<li>Light primary color</li>
</ul>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#d3d3d3</span>
</pre>
</div>

<ul class="org-ul">
<li>Text primary color</li>
</ul>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#545454</span>
</pre>
</div>

<ul class="org-ul">
<li>Accent color</li>
</ul>
<p>
Previous color was <code>#ff5722</code>.
</p>

<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#51c0ae</span>
</pre>
</div>

<ul class="org-ul">
<li>Primary text color</li>
</ul>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#545454</span>
</pre>
</div>

<ul class="org-ul">
<li>Secondary text color</li>
</ul>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#757575</span>
</pre>
</div>

<ul class="org-ul">
<li>Accent text color</li>
</ul>
<p>
#FF5722
</p>
<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#51c0ae</span>
</pre>
</div>

<ul class="org-ul">
<li>Source code background color</li>
</ul>
<p>
Source code is rendered against this background color for readbility.
</p>

<div class="org-src-container">
<pre class="src src-css"><span class="ATTRLIST">#f2f2f2</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e9c936" class="outline-4">
<h4 id="org6e9c936">HTML element styling</h4>
<div class="outline-text-4" id="text-org6e9c936">
<p>
Style definitions for general html elements.
</p>

<p>
/Setting body.height to 100% paints background to visible portion of
blog content and leaving it empty results in left and right borders at
zero height. The only reasonable fix is to be able to specify heights
for all layout divs to be in resolution independent units/
</p>

<div class="org-src-container">
<pre class="src src-css"> <span class="org-css-selector">* </span>{ <span class="org-css-property">font-family</span>: <span class="org-string">"Roboto"</span>; }
 <span class="org-css-selector">html </span>{
     <span class="org-css-property">clear</span>: both;
     <span class="org-css-property">Height</span>: 100%;
     <span class="org-css-property">width</span>: 100%
 }

 <span class="org-css-selector">body </span>{
     <span class="org-css-property">margin</span>: 0; 
     <span class="org-css-property">padding</span>: 0;
     <span class="org-css-property">width</span>: 100%;
     <span class="org-css-property">display</span>: flex;
     <span class="org-css-property">flex-direction</span>: column;
     <span class="org-css-property">color</span>: <span class="ATTRLIST-2">#545454</span>;
     <span class="org-css-property">background-color</span>: <span class="ATTRLIST-1">#fffffd</span>;
     <span class="org-css-property">line-height</span>: 1.35;
     <span class="org-css-property">padding</span>: 1em;
 }

<span class="org-css-selector">a </span>{ <span class="org-css-property">color</span>: <span class="ATTRLIST">#51c0ae</span>; <span class="org-css-property">text-decoration</span>: none}
<span class="org-css-selector">a:visited </span>{ <span class="org-css-property">color</span>: <span class="ATTRLIST">#51c0ae</span>; <span class="org-css-property">text-decoration</span>: none}

<span class="org-css-selector">a:hover </span>{  <span class="org-css-property">color</span>: <span class="ATTRLIST">#51c0ae</span>; <span class="org-css-property">opacity</span>: 0.5; }
</pre>
</div>
</div>
</div>

<div id="outline-container-org05f5cb6" class="outline-4">
<h4 id="org05f5cb6">Page layout styling</h4>
<div class="outline-text-4" id="text-org05f5cb6">
<div class="org-src-container">
<pre class="src src-css"><span class="org-css-selector">h2 </span>{
    <span class="org-css-property">color</span>: <span class="ATTRLIST-1">#51c0ae</span>;
}

<span class="org-comment-delimiter">/* */</span>
<span class="org-css-selector">#blog-title </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">'Cormorant Garamond'</span>;
    <span class="org-css-property">font-size</span>: 400%;
    <span class="org-css-property">font-weight</span>: bolder;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-1">#51c0ae</span>;
}

<span class="org-css-selector">#tagline </span>{
    <span class="org-css-property">font-size</span>: 20%;
    <span class="org-css-property">font-weight</span>: lighter;
    <span class="org-css-property">padding-bottom</span>: 1em;
}

<span class="org-css-selector">.blog-nav </span>{
    <span class="org-css-property">display</span>: flex;
    <span class="org-css-property">flex-direction</span>: row;
    <span class="org-css-property">justify-content</span>: space-between;
    <span class="org-css-property">align-items</span>: center;
    <span class="org-css-property">border-bottom</span>: 2px solid <span class="ATTRLIST">#999</span>
}


</pre>
</div>
</div>
</div>

<div id="outline-container-org8471cb0" class="outline-4">
<h4 id="org8471cb0">Site links styling</h4>
<div class="outline-text-4" id="text-org8471cb0">
<div class="org-src-container">
<pre class="src src-css"><span class="org-css-selector">#site-links </span>{
}

<span class="org-css-selector">#site-links a </span>{
    <span class="org-css-property">color</span>: <span class="ATTRLIST">#51c0ae</span>;
    <span class="org-css-property">font-size</span>: 100%;
    <span class="org-css-property">text-decoration</span>: none;
    <span class="org-css-property">padding-right</span>: 1em
}

<span class="org-css-selector">#social-media-icons </span>{
}

<span class="org-css-selector">#github-logo </span>{
    <span class="org-css-property">vertical-align</span>: super
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org3afc77f" class="outline-4">
<h4 id="org3afc77f">Post styling</h4>
<div class="outline-text-4" id="text-org3afc77f">
<div class="org-src-container">
<pre class="src src-css"><span class="org-css-selector">.post-title </span>{
    <span class="org-css-property">font-size</span>: 150%;
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-3">#51c0ae</span>;
    <span class="org-css-property">border-bottom</span>: 2px solid <span class="ATTRLIST-2">#ddd</span>
}

<span class="org-css-selector">.post-summary </span>{
    <span class="org-css-property">font-size</span>: 100%;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-1">#757575</span>;
    <span class="org-css-property">padding-top</span>: 0.5em;
    <span class="org-css-property">padding-left</span>: 1em;
}

<span class="org-css-selector">.post-tags </span>{
    <span class="org-css-property">font-size</span>: 80%;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-1">#757575</span>;
    <span class="org-css-property">padding-top</span>: 1em;
    <span class="org-css-property">padding-left</span>: 1em;
}

<span class="org-css-selector">.pub-date </span>{ 
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-1">#757575</span>;
    <span class="org-css-property">padding-bottom</span>: 2em;
}

<span class="org-css-selector">.post-publish-date </span>{
    <span class="org-css-property">font-size</span>: 80%;
    <span class="org-css-property">color</span>: <span class="ATTRLIST">#777</span>;
    <span class="org-css-property">padding-top</span>: 0.5em;
    <span class="org-css-property">padding-left</span>: 1em;
    <span class="org-css-property">padding-bottom</span>: 1em;
}

</pre>
</div>
</div>
</div>

<div id="outline-container-orgee39795" class="outline-4">
<h4 id="orgee39795">Org style overrides</h4>
<div class="outline-text-4" id="text-orgee39795">
<p>
Here we override style information for elements generated by org-mode.
</p>

<div class="org-src-container">
<pre class="src src-css"><span class="org-css-selector">.org-src-container </span>{
    <span class="org-css-property">border-left</span>: 0.2em solid <span class="ATTRLIST-1">#999</span>;
}

<span class="org-css-selector">.src </span>{
      <span class="org-css-property">font-family</span>: <span class="org-string">'Source Code Pro'</span>;
      <span class="org-css-property">font-size</span>: 110%;
      <span class="org-css-property">background-color</span>: <span class="ATTRLIST">#f2f2f2</span>;
      <span class="org-css-property">padding</span>: 1em;
  }

</pre>
</div>
</div>
</div>
<div id="outline-container-org053fc96" class="outline-4">
<h4 id="org053fc96">Class definitions</h4>
<div class="outline-text-4" id="text-org053fc96">
<div class="org-src-container">
<pre class="src src-css"><span class="org-css-selector">.blog-footer </span>{
    <span class="org-css-property">display</span>: flex;
    <span class="org-css-property">position</span>: fixed;
    <span class="org-css-property">bottom</span>: 0;
    <span class="org-css-property">width</span>: 100%;
    <span class="org-css-property">height</span>: 1em;
    <span class="org-css-property">font-size</span>: 50%;
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">padding</span>: 5px;
    <span class="org-css-property">flex-direction</span>: row;
    <span class="org-css-property">justify-content</span>: center;
    <span class="org-css-property">border-top</span>: solid 1px <span class="ATTRLIST-2">#dfe3ee</span>;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-1">#51c0ae</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">#3b5998, #dfe3ee, #8b9dc3</span><span class="org-comment-delimiter">*/</span>
    <span class="org-css-property">background-color</span>: <span class="ATTRLIST">#d3d3d3</span>; <span class="org-comment-delimiter">/*</span><span class="org-comment">#dfe3ee;</span><span class="org-comment-delimiter">*/</span>
}
<span class="org-comment-delimiter">/* </span><span class="org-comment">, #8b9dc3 </span><span class="org-comment-delimiter">*/</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8329a9" class="outline-4">
<h4 id="orgd8329a9">Tangling Style sheet</h4>
<div class="outline-text-4" id="text-orgd8329a9">
<div class="org-src-container">
<pre class="src src-css"><span class="org-css-selector">.org-src-container </span>{
    <span class="org-css-property">border-left</span>: 0.2em solid <span class="ATTRLIST-9">#999</span>;
}

<span class="org-css-selector">.src </span>{
      <span class="org-css-property">font-family</span>: <span class="org-string">'Source Code Pro'</span>;
      <span class="org-css-property">font-size</span>: 110%;
      <span class="org-css-property">background-color</span>: <span class="ATTRLIST-8">#f2f2f2</span>;
      <span class="org-css-property">padding</span>: 1em;
  }

 <span class="org-css-selector">* </span>{ <span class="org-css-property">font-family</span>: <span class="org-string">"Roboto"</span>; }
 <span class="org-css-selector">html </span>{
     <span class="org-css-property">clear</span>: both;
     <span class="org-css-property">Height</span>: 100%;
     <span class="org-css-property">width</span>: 100%
 }

 <span class="org-css-selector">body </span>{
     <span class="org-css-property">margin</span>: 0; 
     <span class="org-css-property">padding</span>: 0;
     <span class="org-css-property">width</span>: 100%;
     <span class="org-css-property">display</span>: flex;
     <span class="org-css-property">flex-direction</span>: column;
     <span class="org-css-property">color</span>: <span class="ATTRLIST-7">#545454</span>;
     <span class="org-css-property">background-color</span>: <span class="ATTRLIST-6">#fffffd</span>;
     <span class="org-css-property">line-height</span>: 1.35;
     <span class="org-css-property">padding</span>: 1em;
 }

<span class="org-css-selector">a </span>{ <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>; <span class="org-css-property">text-decoration</span>: none}
<span class="org-css-selector">a:visited </span>{ <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>; <span class="org-css-property">text-decoration</span>: none}

<span class="org-css-selector">a:hover </span>{  <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>; <span class="org-css-property">opacity</span>: 0.5; }
<span class="org-css-selector">h2 </span>{
    <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>;
}

<span class="org-comment-delimiter">/* */</span>
<span class="org-css-selector">#blog-title </span>{
    <span class="org-css-property">font-family</span>: <span class="org-string">'Cormorant Garamond'</span>;
    <span class="org-css-property">font-size</span>: 400%;
    <span class="org-css-property">font-weight</span>: bolder;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>;
}

<span class="org-css-selector">#tagline </span>{
    <span class="org-css-property">font-size</span>: 20%;
    <span class="org-css-property">font-weight</span>: lighter;
    <span class="org-css-property">padding-bottom</span>: 1em;
}

<span class="org-css-selector">.blog-nav </span>{
    <span class="org-css-property">display</span>: flex;
    <span class="org-css-property">flex-direction</span>: row;
    <span class="org-css-property">justify-content</span>: space-between;
    <span class="org-css-property">align-items</span>: center;
    <span class="org-css-property">border-bottom</span>: 2px solid <span class="ATTRLIST-9">#999</span>
}


<span class="org-css-selector">.post-title </span>{
    <span class="org-css-property">font-size</span>: 150%;
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>;
    <span class="org-css-property">border-bottom</span>: 2px solid <span class="ATTRLIST-4">#ddd</span>
}

<span class="org-css-selector">.post-summary </span>{
    <span class="org-css-property">font-size</span>: 100%;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-3">#757575</span>;
    <span class="org-css-property">padding-top</span>: 0.5em;
    <span class="org-css-property">padding-left</span>: 1em;
}

<span class="org-css-selector">.post-tags </span>{
    <span class="org-css-property">font-size</span>: 80%;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-3">#757575</span>;
    <span class="org-css-property">padding-top</span>: 1em;
    <span class="org-css-property">padding-left</span>: 1em;
}

<span class="org-css-selector">.pub-date </span>{ 
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-3">#757575</span>;
    <span class="org-css-property">padding-bottom</span>: 2em;
}

<span class="org-css-selector">.post-publish-date </span>{
    <span class="org-css-property">font-size</span>: 80%;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-2">#777</span>;
    <span class="org-css-property">padding-top</span>: 0.5em;
    <span class="org-css-property">padding-left</span>: 1em;
    <span class="org-css-property">padding-bottom</span>: 1em;
}

<span class="org-css-selector">.blog-footer </span>{
    <span class="org-css-property">display</span>: flex;
    <span class="org-css-property">position</span>: fixed;
    <span class="org-css-property">bottom</span>: 0;
    <span class="org-css-property">width</span>: 100%;
    <span class="org-css-property">height</span>: 1em;
    <span class="org-css-property">font-size</span>: 50%;
    <span class="org-css-property">font-weight</span>: bold;
    <span class="org-css-property">padding</span>: 5px;
    <span class="org-css-property">flex-direction</span>: row;
    <span class="org-css-property">justify-content</span>: center;
    <span class="org-css-property">border-top</span>: solid 1px <span class="ATTRLIST-1">#dfe3ee</span>;
    <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>; <span class="org-comment-delimiter">/* </span><span class="org-comment">#3b5998, #dfe3ee, #8b9dc3</span><span class="org-comment-delimiter">*/</span>
    <span class="org-css-property">background-color</span>: <span class="ATTRLIST">#d3d3d3</span>; <span class="org-comment-delimiter">/*</span><span class="org-comment">#dfe3ee;</span><span class="org-comment-delimiter">*/</span>
}
<span class="org-comment-delimiter">/* </span><span class="org-comment">, #8b9dc3 </span><span class="org-comment-delimiter">*/</span>
<span class="org-css-selector">#site-links </span>{
}

<span class="org-css-selector">#site-links a </span>{
    <span class="org-css-property">color</span>: <span class="ATTRLIST-5">#51c0ae</span>;
    <span class="org-css-property">font-size</span>: 100%;
    <span class="org-css-property">text-decoration</span>: none;
    <span class="org-css-property">padding-right</span>: 1em
}

<span class="org-css-selector">#social-media-icons </span>{
}

<span class="org-css-selector">#github-logo </span>{
    <span class="org-css-property">vertical-align</span>: super
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdadc65f" class="outline-3">
<h3 id="orgdadc65f">Org-file analyzer</h3>
<div class="outline-text-3" id="text-orgdadc65f">
</div>
<div id="outline-container-org8492110" class="outline-4">
<h4 id="org8492110">Return keywords from org-file</h4>
<div class="outline-text-4" id="text-org8492110">
<p>
Returns list of OrgMode keywords from the current document.
</p>
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-get-all-keywords</span>()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (<span class="org-keyword">lambda</span> (kw)
      (cons (org-element-property <span class="org-builtin">:key</span> kw)
            (org-element-property <span class="org-builtin">:value</span> kw)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc19f79e" class="outline-4">
<h4 id="orgc19f79e">Get keyword</h4>
<div class="outline-text-4" id="text-orgc19f79e">
<p>
Returns value of <code>key</code> or <code>default-value</code> if <code>key</code> doesn't exist in <code>keywords</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-get-keyword-value</span>(keywords key <span class="org-type">&amp;optional</span> default-value)
  (<span class="org-keyword">if-let</span> ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb027ea0" class="outline-3">
<h3 id="orgb027ea0">Blog publishing</h3>
<div class="outline-text-3" id="text-orgb027ea0">
<p>
To make any changes to blog generation, this file should be
tangled. Tangling this file generates <code>~/.emacs.d/lisp/blog-gen.el</code>
and <code>blog-style.css</code>. <code>blog-gen-publish</code> bound to <code>C-c C-g</code>, processes
all org files and generates HTML suitable for publishing as a static
web site on a local server. With a prefix argument, the generated HTML
will have s different <code>base url</code> suotable for publishing to <code>github.io</code>.
</p>

<p>
A local server for serving HTML can be run by <code>python -m http.server
8000</code> command.
</p>
</div>

<div id="outline-container-org22ced0e" class="outline-4">
<h4 id="org22ced0e">Blog source directory</h4>
<div class="outline-text-4" id="text-org22ced0e">
<p>
The root directory where the source for blogs is kept.
</p>
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-root-dir</span>
  <span class="org-string">"~/projects/MonadicT.github.io/"</span>
  <span class="org-doc">""</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d41bbf" class="outline-4">
<h4 id="org7d41bbf">Blog posts directory</h4>
<div class="outline-text-4" id="text-org7d41bbf">
<p>
The subdirectory where <code>.org</code> files are stored.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-posts-dir</span>
  <span class="org-string">"_resources/posts/"</span>
  <span class="org-doc">""</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c8e2ee" class="outline-4">
<h4 id="org8c8e2ee">Publishing locally</h4>
<div class="outline-text-4" id="text-org8c8e2ee">
<p>
This is a Boolean flag set to use <code>base</code> url for generated html files.
</p>
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">setq</span> blog-gen-local t)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-base-url</span>()
  (<span class="org-keyword">if</span> blog-gen-local <span class="org-string">"http://localhost:8000/"</span> <span class="org-string">"https://MonadicT.github.io/"</span>))

</pre>
</div>
</div>
</div>
<div id="outline-container-org0a40bfd" class="outline-4">
<h4 id="org0a40bfd">Extract post details</h4>
<div class="outline-text-4" id="text-org0a40bfd">
<p>
Extracts post title, summary and <code>publish-date</code> from the file. Nil is
returned if <code>publish-date</code> is not present.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-post-details</span> (f)
  (<span class="org-keyword">with-temp-buffer</span>
    (find-file f)
    (<span class="org-keyword">let*</span> ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  <span class="org-builtin">:test</span> #'equal))
           (export-file-name (blog-gen-get-keyword-value kws <span class="org-string">"export_file_name"</span> nil))
           (href (<span class="org-keyword">or</span> export-file-name <span class="org-string">""</span>)))
      (<span class="org-keyword">while</span> (string-match <span class="org-string">"^\\.\\./"</span> href)
        (<span class="org-keyword">setq</span> href (substring href 3)))
      (puthash <span class="org-string">"post-file"</span> f details)
      (puthash <span class="org-string">"title"</span> (blog-gen-get-keyword-value kws <span class="org-string">"title"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"summary"</span> (blog-gen-get-keyword-value kws <span class="org-string">"summary"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"publish-date"</span> (blog-gen-get-keyword-value kws <span class="org-string">"publish-date"</span> nil) details)
      (puthash <span class="org-string">"export_file_name"</span> export-file-name details)
      (puthash <span class="org-string">"tags"</span> (blog-gen-get-keyword-value kws <span class="org-string">"tags"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"target"</span> (blog-gen-get-keyword-value kws <span class="org-string">"target"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"href"</span> (concat (blog-gen-base-url) href) details)
      (<span class="org-keyword">unless</span> (string-match <span class="org-string">"blog-generator.org"</span> f) (kill-buffer))
      details)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd479514" class="outline-4">
<h4 id="orgd479514">Post files</h4>
<div class="outline-text-4" id="text-orgd479514">
<p>
Returns list of posts stored in <code>.org</code> files. <code>.org</code> files such as
<code>index.org</code>, <code>about.org</code> are not returned as posts.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-post-files</span>()
  (<span class="org-keyword">let*</span> ((posts-dir (concat blog-gen-root-dir <span class="org-string">"/"</span> blog-gen-posts-dir))
         (org-files (directory-files posts-dir t <span class="org-string">"[a-ZA-Z0-9_-]*\\.org$"</span>))
         (org-files
          (seq-remove
           (<span class="org-keyword">lambda</span> (f)
             (<span class="org-keyword">or</span> (string-match <span class="org-string">"index.org$"</span> f)
                 (string-match <span class="org-string">"about.org$"</span> f)
                 (string-match <span class="org-string">"sitemap.org$"</span> f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaabd63f" class="outline-4">
<h4 id="orgaabd63f">Published post files</h4>
<div class="outline-text-4" id="text-orgaabd63f">
<p>
Returns published posts (posts which have <code>export_file_name</code> keyword).
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-published-posts</span> (posts)
  (seq-filter (<span class="org-keyword">lambda</span> (p) (gethash <span class="org-string">"export_file_name"</span> p)) posts))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb6515c6" class="outline-4">
<h4 id="orgb6515c6">Order post files</h4>
<div class="outline-text-4" id="text-orgb6515c6">
<p>
Orders posts by <code>publish-date</code> descending.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-order-posts</span>(posts)
  (seq-sort (<span class="org-keyword">lambda</span> (a b) (string&gt; (gethash <span class="org-string">"publish-date"</span> a) (gethash <span class="org-string">"publish-date"</span> b))) posts))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4143da8" class="outline-4">
<h4 id="org4143da8">Macro to generate <code>html_export</code> blocks</h4>
<div class="outline-text-4" id="text-org4143da8">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defmacro</span> <span class="org-function-name">html-export</span>(<span class="org-type">&amp;rest</span> content)
  `(<span class="org-keyword">progn</span> (insert <span class="org-string">"#+BEGIN_EXPORT html\n"</span>)
          (insert ,@content)
          (insert <span class="org-string">"\n#+END_EXPORT\n\n"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org035ed69" class="outline-4">
<h4 id="org035ed69">Articles generation</h4>
<div class="outline-text-4" id="text-org035ed69">
<p>
Exports all <code>.org</code> post files to <code>.html</code> files.
</p>
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-posts</span>()
  (<span class="org-keyword">let</span> ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (<span class="org-keyword">lambda</span> (post)
       (<span class="org-keyword">let</span> ((post-file (gethash <span class="org-string">"post-file"</span> post))
             (export-file-name (gethash <span class="org-string">"export_file_name"</span> post)))
         (message (concat <span class="org-string">"exporting"</span> post-file <span class="org-string">"to"</span> export-file-name))
         (<span class="org-keyword">when</span> export-file-name
           (<span class="org-keyword">with-temp-buffer</span>
             (find-file post-file)
             (org-export-to-file 'blog export-file-name)
             (kill-buffer)))))
     posts)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org78b5d14" class="outline-4">
<h4 id="org78b5d14">Articles page generation</h4>
<div class="outline-text-4" id="text-org78b5d14">
<p>
Generates list of articles.
</p>

<div class="org-src-container">
<pre class="src src-elisp">  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-articles</span>()
    (<span class="org-keyword">with-temp-buffer</span>
      (find-file (concat blog-gen-root-dir <span class="org-string">"index.org"</span>))
      (erase-buffer)
      (insert <span class="org-string">"#+title: MonadictT\n"</span>)
      (insert <span class="org-string">"#+options: num:nil html-style:nil\n"</span>)
      (insert <span class="org-string">"#+HTML_HEAD: &lt;link href=\"https://fonts.googleapis.com/css?family=Cormorant+Garamond|Roboto\" rel=\"stylesheet\"&gt;\n"</span>)
      (insert <span class="org-string">"#+HTML_HEAD_EXTRA: &lt;style&gt;* {font-family: 'Roboto';}&lt;/style&gt;\n"</span>)
      (insert <span class="org-string">"#+HTML_HEAD_EXTRA: &lt;style&gt;pre {font-family: 'Segoe Print';}&lt;/style&gt;\n"</span>)

      (insert <span class="org-string">"* Posts\n"</span>)
      (<span class="org-keyword">let</span> ((posts (blog-gen-order-posts
                    (blog-gen-published-posts
                     (blog-gen-post-files)))))
        (mapcar
         (<span class="org-keyword">lambda</span> (post)
           (<span class="org-keyword">let*</span> ((title (gethash <span class="org-string">"title"</span> post))
                  (summary (gethash <span class="org-string">"summary"</span>  post))
                  (export-file-name (gethash <span class="org-string">"export_file_name"</span>  post))
                  (export-file-name
                   (<span class="org-keyword">let</span> ((href export-file-name))
                     (<span class="org-keyword">while</span> (string-match <span class="org-string">"^\\.\\./"</span> href)
                       (<span class="org-keyword">setq</span> href (substring href 3)))
                     href))
                  (publish-date (gethash <span class="org-string">"publish-date"</span> post))
                  (l (list (make-symbol (format <span class="org-string">"a@href=\"/%s\""</span> export-file-name)) title)))
             (<span class="org-keyword">html-export</span>
              (<span class="org-keyword">yatl-html-frag</span>
               (div.post-title
                (eval (yatl-compile-fn l)))))
             (<span class="org-keyword">html-export</span>
              (<span class="org-keyword">yatl-html-frag</span>
               (div.post-summary summary)) <span class="org-string">"\n\n"</span>)
             (<span class="org-keyword">html-export</span>
              (<span class="org-keyword">yatl-html-frag</span>
               (div.post-publish-date <span class="org-string">"Published: "</span> publish-date)) <span class="org-string">"\n"</span>)))
         posts))
      (save-buffer)
      (<span class="org-keyword">let</span> ((out-file (concat blog-gen-root-dir <span class="org-string">"articles.html"</span>)))
        (<span class="org-keyword">when</span> (file-exists-p out-file)
          (delete-file out-file))
        (org-export-to-file 'blog out-file))
      (delete-file (concat blog-gen-root-dir <span class="org-string">"index.org"</span>))))
<span class="org-comment-delimiter">;;</span><span class="org-comment">(blog-gen-create-articles)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd373dd2" class="outline-4">
<h4 id="orgd373dd2">Tags generation</h4>
<div class="outline-text-4" id="text-orgd373dd2">
<p>
Posts have a <code>#+tags</code> header and tags are separated by <code>,</code>. This
function builds a hashtable of tags to a list posts from <code>posts</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">create-tag-post-map</span>(posts)
  (<span class="org-keyword">let</span> ((tag-post-map (make-hash-table <span class="org-builtin">:test</span> 'equal)))
    (mapcar
     (<span class="org-keyword">lambda</span>(post)
       (<span class="org-keyword">let</span> ((title (gethash <span class="org-string">"title"</span> post))
             (tags (mapcar #'s-trim (split-string (gethash <span class="org-string">"tags"</span> post) <span class="org-string">"[,]+"</span>))))
         (mapcar
          (<span class="org-keyword">lambda</span> (tag)
            (<span class="org-keyword">when</span> (not (string-empty-p tag))
              (puthash tag (cons post (gethash tag tag-post-map '())) tag-post-map)))
          tags)))
     posts)
    tag-post-map))
</pre>
</div>

<p>
Tags should be ordered in lexicographic order. This function returns
tags in ascending order.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">sorted-keys</span>(tag-post-map)
  (<span class="org-keyword">let</span> ((keys '()))
    (maphash
     (<span class="org-keyword">lambda</span> (k v) (<span class="org-keyword">setq</span> keys (cons k keys)))
     tag-post-map)
    (seq-sort (<span class="org-keyword">lambda</span> (a b) (string-lessp (upcase a) (upcase b))) keys)))
</pre>
</div>

<p>
Once we have the <code>tag-post-map</code>, we can generate an <code>org-mode</code>
representation of it. The tag is listed as second-level header with a
bullet list of anchors to posts.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-tags</span>(posts)
  (<span class="org-keyword">let*</span> ((tag-post-map (create-tag-post-map posts))
         (tags  (sorted-keys tag-post-map)))
    (<span class="org-keyword">with-temp-buffer</span>
      (find-file <span class="org-string">"tags.org"</span>)
      (erase-buffer)
      (insert <span class="org-string">"#+title: Tags\n"</span>)
      (insert <span class="org-string">"#+options: num:nil\n"</span>)
      (insert <span class="org-string">"* Tags\n"</span>)
      (mapcar
       (<span class="org-keyword">lambda</span> (tag)
         (<span class="org-keyword">let</span> ((post-list (gethash tag tag-post-map)))
           (insert <span class="org-string">"** "</span> tag <span class="org-string">"\n"</span>)
           (mapcar
            (<span class="org-keyword">lambda</span> (post)
              (princ post)
              (<span class="org-keyword">let</span> ((title (gethash <span class="org-string">"title"</span> post))
                    (href  (gethash <span class="org-string">"href"</span> post)))
                (insert <span class="org-string">"- [["</span> href <span class="org-string">"]["</span> title <span class="org-string">"]]\n"</span>)))
            post-list)))
       tags)
      (write-file <span class="org-string">"tags.org"</span>)
      (<span class="org-keyword">let</span> ((out-file (concat blog-gen-root-dir <span class="org-string">"tags.html"</span>)))
        (org-export-to-file 'blog out-file))
      (kill-buffer))))


<span class="org-comment-delimiter">;;  </span><span class="org-comment">(setq x (blog-gen-post-files))</span>

<span class="org-comment-delimiter">;;  </span><span class="org-comment">(blog-gen-create-tags x)</span>

<span class="org-comment-delimiter">;;  </span><span class="org-comment">(require 'blog-gen)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org807c120" class="outline-4">
<h4 id="org807c120">About page generation.</h4>
<div class="outline-text-4" id="text-org807c120">
<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-about</span>()
  (<span class="org-keyword">with-temp-buffer</span>
    (find-file (concat
                blog-gen-root-dir
                blog-gen-posts-dir
                <span class="org-string">"about.org"</span>))
    (next-line) <span class="org-comment-delimiter">;; </span><span class="org-comment">When on line 1, org export throws a weird error</span>
    (org-export-to-file 'blog (concat blog-gen-root-dir <span class="org-string">"about.html"</span>) nil )
    (kill-buffer)))

(blog-gen-create-about)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgabe98bf" class="outline-4">
<h4 id="orgabe98bf">Home page generation</h4>
<div class="outline-text-4" id="text-orgabe98bf">
<p>
For now, <i>Home</i> points to <i>Articles</i>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-home</span>()
  (copy-file
   (concat blog-gen-root-dir <span class="org-string">"articles.html"</span>)
   (concat blog-gen-root-dir <span class="org-string">"index.html"</span>) t))
</pre>
</div>
</div>
</div>

<div id="outline-container-org562df7c" class="outline-4">
<h4 id="org562df7c">Generates blog,</h4>
<div class="outline-text-4" id="text-org562df7c">
<p>
Function to regenerate the full site. This is bound to <code>C-c C-g</code>.
</p>

<div class="org-src-container">
<pre class="src src-elisp">  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-publish</span>(prod)
    (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
(message <span class="org-string">"Blog generattion started"</span>)
    (<span class="org-keyword">if</span> prod (<span class="org-keyword">setq</span> blog-gen-local nil) (<span class="org-keyword">setq</span> blog-gen-local t))
    (message (format <span class="org-string">"Local Gen %S"</span> blog-gen-local))
    (<span class="org-keyword">let</span> ((posts (blog-gen-post-files)))
      (blog-gen-create-posts)
      (message <span class="org-string">"Created posts"</span>)
      (blog-gen-create-articles)
      (message <span class="org-string">"Created articles page"</span>)
      (blog-gen-create-tags posts)
      (message <span class="org-string">"Created tags page"</span>)
      (blog-gen-create-about)
      (message <span class="org-string">"Created about page"</span>)
      (blog-gen-create-home)
      (message <span class="org-string">"Created home page"</span>))
    (<span class="org-keyword">when</span> prod
      (<span class="org-keyword">when</span> (blog-gen-file-contains-p <span class="org-string">"localhost"</span>)
        (<span class="org-warning">error</span> <span class="org-string">"localhost references in file"</span>))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-file-contains-p</span>(s) nil)
  (global-set-key (kbd <span class="org-string">"C-c C-g"</span>) #'blog-gen-publish)
</pre>
</div>
</div>
</div>

<div id="outline-container-org8153dc9" class="outline-4">
<h4 id="org8153dc9">Create new blog post</h4>
<div class="outline-text-4" id="text-org8153dc9">
<p>
A template for creating a new blog post.
</p>

<div class="org-src-container">
<pre class="src src-elisp">  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-new-post</span>()
    (<span class="org-keyword">interactive</span>)
    (insert <span class="org-string">"#+title: TBD</span>
<span class="org-string">#+summary: TBD</span>
<span class="org-string">#+publish-date: 2018-01-31</span>
<span class="org-string">#+export_file_name: ../../yyyy/TBD</span>
<span class="org-string">#+tags: TBD</span>
<span class="org-string">#+option: num:nil"</span>))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgadedefb" class="outline-4">
<h4 id="orgadedefb">Tangled elisp file</h4>
<div class="outline-text-4" id="text-orgadedefb">
<p>
All the functions described above are tangled into
~/.emacs.d/lisp/blog-gen.el. A <code>require</code> in <code>.emacs</code> will make this
available for use.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">blog-gen.el --- Static site generator in emacs and org-mode</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Copyright (C) 2017-2018 Praki Prakash</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Author: Praki Prakash</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Maintainer: Praki Prakash</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Created: 2017-12-31</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Keywords: languages</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Homepage: https://MonadicT.gihub.io</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">This file is not part of GNU Emacs.</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-elisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">blog-gen.el --- Static site generator in emacs and org-mode</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Copyright (C) 2017-2018 Praki Prakash</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Author: Praki Prakash</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Maintainer: Praki Prakash</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Created: 2017-12-31</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Keywords: languages</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Homepage: https://MonadicT.gihub.io</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">This file is not part of GNU Emacs.</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Dependencies ----------------------</span>
(<span class="org-keyword">require</span> '<span class="org-constant">cl</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">subr-x</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">s</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">yatl</span>)

<span class="org-comment-delimiter">;;; </span><span class="org-comment">Variables</span>
(<span class="org-keyword">require</span> '<span class="org-constant">ox-html</span>)

 <span class="org-comment-delimiter">;;; </span><span class="org-comment">Variables and options</span>

(<span class="org-keyword">defgroup</span> <span class="org-type">org-export-blog</span> nil
  <span class="org-doc">"Options specific to RSS export back-end."</span>
  <span class="org-builtin">:tag</span> <span class="org-string">"Org Blog"</span>
  <span class="org-builtin">:group</span> 'org-export
  <span class="org-builtin">:version</span> <span class="org-string">"24.4"</span>
  <span class="org-builtin">:package-version</span> '(Org . <span class="org-string">"9.0"</span>))

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-publish-url</span> <span class="org-string">"https://MonadicT.github.io"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-title</span> <span class="org-string">"MonadicT"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-tagline</span> <span class="org-string">"I see dead objects!"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-author</span> <span class="org-string">"Praki Prakash"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-copyright-message</span> <span class="org-string">"Copyright &amp;copy; 2014-%s, Praki Prakash"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-style-file</span> <span class="org-string">"blog-style.css"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-banner-file</span> <span class="org-string">"banner.org"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-footer-file</span> <span class="org-string">"footer.org"</span>
  <span class="org-doc">"???"</span>
  <span class="org-builtin">:group</span> 'org-export-blog
  <span class="org-builtin">:type</span> 'string)

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-root-dir</span>
  <span class="org-string">"~/projects/MonadicT.github.io/"</span>
  <span class="org-doc">""</span>)
(<span class="org-keyword">defcustom</span> <span class="org-variable-name">blog-gen-posts-dir</span>
  <span class="org-string">"_resources/posts/"</span>
  <span class="org-doc">""</span>)
(<span class="org-keyword">setq</span> blog-gen-local t)

<span class="org-comment-delimiter">;;; </span><span class="org-comment">Functions ------------------------</span>
(<span class="org-keyword">defmacro</span> <span class="org-function-name">assert-equal</span> (actual expected)
  `(<span class="org-keyword">when</span> (not (equal ,actual ,expected))
     (<span class="org-warning">error</span> <span class="org-string">"Actual: %s expected: %s"</span>
            (format <span class="org-string">"%s"</span> ',actual)
            (format <span class="org-string">"%s"</span> ',expected))))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-get-all-keywords</span>()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (<span class="org-keyword">lambda</span> (kw)
      (cons (org-element-property <span class="org-builtin">:key</span> kw)
            (org-element-property <span class="org-builtin">:value</span> kw)))))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-get-keyword-value</span>(keywords key <span class="org-type">&amp;optional</span> default-value)
  (<span class="org-keyword">if-let</span> ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-post-details</span> (f)
  (<span class="org-keyword">with-temp-buffer</span>
    (find-file f)
    (<span class="org-keyword">let*</span> ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  <span class="org-builtin">:test</span> #'equal))
           (export-file-name (blog-gen-get-keyword-value kws <span class="org-string">"export_file_name"</span> nil))
           (href (<span class="org-keyword">or</span> export-file-name <span class="org-string">""</span>)))
      (<span class="org-keyword">while</span> (string-match <span class="org-string">"^\\.\\./"</span> href)
        (<span class="org-keyword">setq</span> href (substring href 3)))
      (puthash <span class="org-string">"post-file"</span> f details)
      (puthash <span class="org-string">"title"</span> (blog-gen-get-keyword-value kws <span class="org-string">"title"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"summary"</span> (blog-gen-get-keyword-value kws <span class="org-string">"summary"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"publish-date"</span> (blog-gen-get-keyword-value kws <span class="org-string">"publish-date"</span> nil) details)
      (puthash <span class="org-string">"export_file_name"</span> export-file-name details)
      (puthash <span class="org-string">"tags"</span> (blog-gen-get-keyword-value kws <span class="org-string">"tags"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"target"</span> (blog-gen-get-keyword-value kws <span class="org-string">"target"</span> <span class="org-string">""</span>) details)
      (puthash <span class="org-string">"href"</span> (concat (blog-gen-base-url) href) details)
      (<span class="org-keyword">unless</span> (string-match <span class="org-string">"blog-generator.org"</span> f) (kill-buffer))
      details)))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-post-files</span>()
  (<span class="org-keyword">let*</span> ((posts-dir (concat blog-gen-root-dir <span class="org-string">"/"</span> blog-gen-posts-dir))
         (org-files (directory-files posts-dir t <span class="org-string">"[a-ZA-Z0-9_-]*\\.org$"</span>))
         (org-files
          (seq-remove
           (<span class="org-keyword">lambda</span> (f)
             (<span class="org-keyword">or</span> (string-match <span class="org-string">"index.org$"</span> f)
                 (string-match <span class="org-string">"about.org$"</span> f)
                 (string-match <span class="org-string">"sitemap.org$"</span> f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-published-posts</span> (posts)
  (seq-filter (<span class="org-keyword">lambda</span> (p) (gethash <span class="org-string">"export_file_name"</span> p)) posts))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-order-posts</span>(posts)
  (seq-sort (<span class="org-keyword">lambda</span> (a b) (string&gt; (gethash <span class="org-string">"publish-date"</span> a) (gethash <span class="org-string">"publish-date"</span> b))) posts))
(<span class="org-keyword">defmacro</span> <span class="org-function-name">html-export</span>(<span class="org-type">&amp;rest</span> content)
  `(<span class="org-keyword">progn</span> (insert <span class="org-string">"#+BEGIN_EXPORT html\n"</span>)
          (insert ,@content)
          (insert <span class="org-string">"\n#+END_EXPORT\n\n"</span>)))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-posts</span>()
  (<span class="org-keyword">let</span> ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (<span class="org-keyword">lambda</span> (post)
       (<span class="org-keyword">let</span> ((post-file (gethash <span class="org-string">"post-file"</span> post))
             (export-file-name (gethash <span class="org-string">"export_file_name"</span> post)))
         (message (concat <span class="org-string">"exporting"</span> post-file <span class="org-string">"to"</span> export-file-name))
         (<span class="org-keyword">when</span> export-file-name
           (<span class="org-keyword">with-temp-buffer</span>
             (find-file post-file)
             (org-export-to-file 'blog export-file-name)
             (kill-buffer)))))
     posts)))
  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-articles</span>()
    (<span class="org-keyword">with-temp-buffer</span>
      (find-file (concat blog-gen-root-dir <span class="org-string">"index.org"</span>))
      (erase-buffer)
      (insert <span class="org-string">"#+title: MonadictT\n"</span>)
      (insert <span class="org-string">"#+options: num:nil html-style:nil\n"</span>)
      (insert <span class="org-string">"#+HTML_HEAD: &lt;link href=\"https://fonts.googleapis.com/css?family=Cormorant+Garamond|Roboto\" rel=\"stylesheet\"&gt;\n"</span>)
      (insert <span class="org-string">"#+HTML_HEAD_EXTRA: &lt;style&gt;* {font-family: 'Roboto';}&lt;/style&gt;\n"</span>)
      (insert <span class="org-string">"#+HTML_HEAD_EXTRA: &lt;style&gt;pre {font-family: 'Segoe Print';}&lt;/style&gt;\n"</span>)

      (insert <span class="org-string">"* Posts\n"</span>)
      (<span class="org-keyword">let</span> ((posts (blog-gen-order-posts
                    (blog-gen-published-posts
                     (blog-gen-post-files)))))
        (mapcar
         (<span class="org-keyword">lambda</span> (post)
           (<span class="org-keyword">let*</span> ((title (gethash <span class="org-string">"title"</span> post))
                  (summary (gethash <span class="org-string">"summary"</span>  post))
                  (export-file-name (gethash <span class="org-string">"export_file_name"</span>  post))
                  (export-file-name
                   (<span class="org-keyword">let</span> ((href export-file-name))
                     (<span class="org-keyword">while</span> (string-match <span class="org-string">"^\\.\\./"</span> href)
                       (<span class="org-keyword">setq</span> href (substring href 3)))
                     href))
                  (publish-date (gethash <span class="org-string">"publish-date"</span> post))
                  (l (list (make-symbol (format <span class="org-string">"a@href=\"/%s\""</span> export-file-name)) title)))
             (<span class="org-keyword">html-export</span>
              (<span class="org-keyword">yatl-html-frag</span>
               (div.post-title
                (eval (yatl-compile-fn l)))))
             (<span class="org-keyword">html-export</span>
              (<span class="org-keyword">yatl-html-frag</span>
               (div.post-summary summary)) <span class="org-string">"\n\n"</span>)
             (<span class="org-keyword">html-export</span>
              (<span class="org-keyword">yatl-html-frag</span>
               (div.post-publish-date <span class="org-string">"Published: "</span> publish-date)) <span class="org-string">"\n"</span>)))
         posts))
      (save-buffer)
      (<span class="org-keyword">let</span> ((out-file (concat blog-gen-root-dir <span class="org-string">"articles.html"</span>)))
        (<span class="org-keyword">when</span> (file-exists-p out-file)
          (delete-file out-file))
        (org-export-to-file 'blog out-file))
      (delete-file (concat blog-gen-root-dir <span class="org-string">"index.org"</span>))))
<span class="org-comment-delimiter">;;</span><span class="org-comment">(blog-gen-create-articles)</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">create-tag-post-map</span>(posts)
  (<span class="org-keyword">let</span> ((tag-post-map (make-hash-table <span class="org-builtin">:test</span> 'equal)))
    (mapcar
     (<span class="org-keyword">lambda</span>(post)
       (<span class="org-keyword">let</span> ((title (gethash <span class="org-string">"title"</span> post))
             (tags (mapcar #'s-trim (split-string (gethash <span class="org-string">"tags"</span> post) <span class="org-string">"[,]+"</span>))))
         (mapcar
          (<span class="org-keyword">lambda</span> (tag)
            (<span class="org-keyword">when</span> (not (string-empty-p tag))
              (puthash tag (cons post (gethash tag tag-post-map '())) tag-post-map)))
          tags)))
     posts)
    tag-post-map))
(<span class="org-keyword">defun</span> <span class="org-function-name">sorted-keys</span>(tag-post-map)
  (<span class="org-keyword">let</span> ((keys '()))
    (maphash
     (<span class="org-keyword">lambda</span> (k v) (<span class="org-keyword">setq</span> keys (cons k keys)))
     tag-post-map)
    (seq-sort (<span class="org-keyword">lambda</span> (a b) (string-lessp (upcase a) (upcase b))) keys)))
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-tags</span>(posts)
  (<span class="org-keyword">let*</span> ((tag-post-map (create-tag-post-map posts))
         (tags  (sorted-keys tag-post-map)))
    (<span class="org-keyword">with-temp-buffer</span>
      (find-file <span class="org-string">"tags.org"</span>)
      (erase-buffer)
      (insert <span class="org-string">"#+title: Tags\n"</span>)
      (insert <span class="org-string">"#+options: num:nil\n"</span>)
      (insert <span class="org-string">"* Tags\n"</span>)
      (mapcar
       (<span class="org-keyword">lambda</span> (tag)
         (<span class="org-keyword">let</span> ((post-list (gethash tag tag-post-map)))
           (insert <span class="org-string">"** "</span> tag <span class="org-string">"\n"</span>)
           (mapcar
            (<span class="org-keyword">lambda</span> (post)
              (princ post)
              (<span class="org-keyword">let</span> ((title (gethash <span class="org-string">"title"</span> post))
                    (href  (gethash <span class="org-string">"href"</span> post)))
                (insert <span class="org-string">"- [["</span> href <span class="org-string">"]["</span> title <span class="org-string">"]]\n"</span>)))
            post-list)))
       tags)
      (write-file <span class="org-string">"tags.org"</span>)
      (<span class="org-keyword">let</span> ((out-file (concat blog-gen-root-dir <span class="org-string">"tags.html"</span>)))
        (org-export-to-file 'blog out-file))
      (kill-buffer))))


<span class="org-comment-delimiter">;;  </span><span class="org-comment">(setq x (blog-gen-post-files))</span>

<span class="org-comment-delimiter">;;  </span><span class="org-comment">(blog-gen-create-tags x)</span>

<span class="org-comment-delimiter">;;  </span><span class="org-comment">(require 'blog-gen)</span>
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-about</span>()
  (<span class="org-keyword">with-temp-buffer</span>
    (find-file (concat
                blog-gen-root-dir
                blog-gen-posts-dir
                <span class="org-string">"about.org"</span>))
    (next-line) <span class="org-comment-delimiter">;; </span><span class="org-comment">When on line 1, org export throws a weird error</span>
    (org-export-to-file 'blog (concat blog-gen-root-dir <span class="org-string">"about.html"</span>) nil )
    (kill-buffer)))

(blog-gen-create-about)
(<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-create-home</span>()
  (copy-file
   (concat blog-gen-root-dir <span class="org-string">"articles.html"</span>)
   (concat blog-gen-root-dir <span class="org-string">"index.html"</span>) t))
  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-publish</span>(prod)
    (<span class="org-keyword">interactive</span> <span class="org-string">"P"</span>)
(message <span class="org-string">"Blog generattion started"</span>)
    (<span class="org-keyword">if</span> prod (<span class="org-keyword">setq</span> blog-gen-local nil) (<span class="org-keyword">setq</span> blog-gen-local t))
    (message (format <span class="org-string">"Local Gen %S"</span> blog-gen-local))
    (<span class="org-keyword">let</span> ((posts (blog-gen-post-files)))
      (blog-gen-create-posts)
      (message <span class="org-string">"Created posts"</span>)
      (blog-gen-create-articles)
      (message <span class="org-string">"Created articles page"</span>)
      (blog-gen-create-tags posts)
      (message <span class="org-string">"Created tags page"</span>)
      (blog-gen-create-about)
      (message <span class="org-string">"Created about page"</span>)
      (blog-gen-create-home)
      (message <span class="org-string">"Created home page"</span>))
    (<span class="org-keyword">when</span> prod
      (<span class="org-keyword">when</span> (blog-gen-file-contains-p <span class="org-string">"localhost"</span>)
        (<span class="org-warning">error</span> <span class="org-string">"localhost references in file"</span>))))
  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-file-contains-p</span>(s) nil)
  (global-set-key (kbd <span class="org-string">"C-c C-g"</span>) #'blog-gen-publish)
  (<span class="org-keyword">defun</span> <span class="org-function-name">blog-gen-new-post</span>()
    (<span class="org-keyword">interactive</span>)
    (insert <span class="org-string">"#+title: TBD</span>
<span class="org-string">#+summary: TBD</span>
<span class="org-string">#+publish-date: 2018-01-31</span>
<span class="org-string">#+export_file_name: ../../yyyy/TBD</span>
<span class="org-string">#+tags: TBD</span>
<span class="org-string">#+option: num:nil"</span>))

(<span class="org-keyword">provide</span> '<span class="org-constant">blog-gen</span>)
<span class="org-comment-delimiter">;;; </span><span class="org-comment">blog-gen.el ends here</span>
</pre>
</div>
</div>
</div>
</div>
</div>

</div>

</div>
 <div style="flex:2">

</div>
 <div class=" blog-footer">
Copyright &copy; 2014-2018, Praki Prakash
</div>

</div>

</body>
</html>
