<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8>"/>
 <title>
MonadicT
</title>
 <base href="https://MonadicT.github.io/"/>
 <meta name="generator" content="GNU Emacs 25.3.1 (aarch64-unknown-linux-gnu, GTK+ Version 3.22.26)
 of 2017-12-09>"/>
 <meta name="author" content="Praki Prakash"/>
 <link href="blog-style.css" rel="stylesheet"/>

</head>
<body>
<div style="display:flex">
<div style="flex:2">

</div>
 <div style="flex:6">
<div>
<div class=" blog-nav">
<div id="blog-title">
MonadicT
</div>
 <div>Search <form action="http://www.google.com/search" id="searchform"
method="get"><div><input class="box" id="s" name="q" type="text" />
<input name="sitesearch" type="hidden" value="http://MonadicT.github.io" />
</div></form></div>
</div>
<div class=" blog-nav">
<div  id="site-links"><a href="/index.html">Home</a><a href="/articles.html">Articles</a><a href="/tags.html">Tags</a><a href="/about.html">About</a></div> <div id="social-media-icons"><a target="_new" href="https://twitter.com/MonadicT">
<span style={background-color: white; height:48px;width:48px;border-radius:24px}></span>
<img height="48px" width="48px"
   title="Visit my Twitter page"
   src="/images/twitter.png"/></a><a id="github-link" target="_new"
  href="https://github.com/MonadicT"><img id="github-logo"
  src="/images/github-logo.png"/></a></div>
</div>
<div style="border:1px">

</div>

<div id="outline-container-org10ecdf7" class="outline-2">
<h2 id="org10ecdf7">Blog site generator</h2>
<div class="outline-text-2" id="text-org10ecdf7">
</div>
<div id="outline-container-orgf6e13b8" class="outline-3">
<h3 id="orgf6e13b8">Overview</h3>
<div class="outline-text-3" id="text-orgf6e13b8">
<p>
Org-mode has a flexible export framework which can be leveraged to
generate Html content suitable for publishing with Jekyll, a static
site generator. This post describes the elisp package which is used to
maintain my blog at <a href="https://monadict.github.io">MonadicT.github.io</a>.
</p>

<p>
Blog entries are written as a regular <code>.org</code> file. A post should have
a <code>#+title</code>, <code>#+summary</code>, <code>#+publish_date</code>, <code>#+tags</code> and
<code>#+export_file_name</code> for proper formatting and structure. The
<code>export_file_name</code> header is used by Org-mode to create the generated
Html file.
</p>

<p>
The entire site with Home, About, Tags, RSS and all the posts can be
regenerated by <code>Meta blog-gen-publish</code>, also bound to <code>C-c C-g</code>. An
individual post can be quickly examined by invoking Org export menu
(<code>C-c C-e</code>) which shows the options for processing the buffer. <code>C-c
C-e</code> C-f will generate a HTML file.
</p>

<p>
If there is no <code>#+publish-data</code> header, the post will be skipped when
the site is regenerated.
</p>

<p>
A new blog entry with all the required headers can be created by
executing <code>blog-gen-new-post</code>.
</p>
</div>
</div>

<div id="outline-container-org24bfca3" class="outline-3">
<h3 id="org24bfca3">Design description</h3>
<div class="outline-text-3" id="text-org24bfca3">
<ul class="org-ul">
<li>Customizable variables describe</li>
</ul>
</div>
</div>
<div id="outline-container-org73abda1" class="outline-3">
<h3 id="org73abda1">Implementation</h3>
<div class="outline-text-3" id="text-org73abda1">
</div>
<div id="outline-container-org5b35958" class="outline-4">
<h4 id="org5b35958">Dependencies</h4>
<div class="outline-text-4" id="text-org5b35958">
<p>
Not many! <code>yatl</code> is my Elisp package for generating Html fragments
from s-expressions.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(require 'cl)
(require 'yatl)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgfe8bb2f" class="outline-4">
<h4 id="orgfe8bb2f">Useful macros/functions</h4>
</div>
<div id="outline-container-org269ae65" class="outline-4">
<h4 id="org269ae65">Assert utlity</h4>
<div class="outline-text-4" id="text-org269ae65">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro assert-equal (actual expected)
  `(when (not (equal ,actual ,expected))
     (error "Actual: %s expected: %s"
            (format "%s" ',actual)
            (format "%s" ',expected))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgcd528c4" class="outline-4">
<h4 id="orgcd528c4">Key-value string parser</h4>
<div class="outline-text-4" id="text-orgcd528c4">
<p>
Parses key-value string of form <i>@key=val@key=val</i>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-parse-kvp(s)
  (let (res)
    (mapconcat
     (lambda (kv-str)
       (let* ((kv (split-string kv-str "="))
              (key (car kv))
              (val (cadr kv))
              (val (if (string-match "^\".*\"$" val)
                       val
                     (format "\"%s\"" val))))
         (concat key "=" val)))
     (split-string s "@" t)
     " ")))

(assert-equal (blog-gen-parse-kvp "") "")
(assert-equal (blog-gen-parse-kvp "@") "")
(assert-equal (blog-gen-parse-kvp "@a=b") "a=\"b\"")
(assert-equal (blog-gen-parse-kvp "@a=b@c=d") "a=\"b\" c=\"d\"")

</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defmacro lisp (&amp;rest forms)
    `(let ((res ,@forms))
       res))

(assert-equal (lisp 1) 1)
(assert-equal (lisp (+ 1 2 3)) 6)
(assert-equal (lisp (concat "a" "n")) "an")
(assert-equal (lisp (list 1 2 3)) '(1 2 3))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org7ab0057" class="outline-4">
<h4 id="org7ab0057">Parse element name</h4>
<div class="outline-text-4" id="text-org7ab0057">
<p>
Parses element name and returns the list of element name, id, class
and attributes. Multiple class names but id must be unique. Id is
introdued by |?|, class name with |.| and attribute with |!|.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">;; Exanple names: div, div?id, div.cls1.clas2, div!k=v!k=v
(defun blog-gen-parse-elem-name(s)
  (let ((nm-id-cls (list '() '() '() '()))
        attrs idx buf)
    (setq  idx 0)
    (mapcar
     (lambda (c)
       (cond
        ((eq c ?.) (progn
                     (setq idx 2)
                     (push c (nth idx nm-id-cls))))
        ((eq c ??) (progn
                     (if (null (cadr nm-id-cls))
                         (setq idx 1)
                       (error "ID specified again!"))))
        ((eq c ?@) (progn
                     (setq idx 3)
                     (push c (nth idx nm-id-cls))))
        ((eq idx -1) (error "Expect one of \".,+,#'"))
        (t (push c (nth idx nm-id-cls)))))
     s)
    (list (concat (reverse (car nm-id-cls)))
          (concat (reverse (cadr nm-id-cls)))
          (concat (reverse (caddr nm-id-cls)))
          (blog-gen-parse-kvp (concat (reverse (nth 3 nm-id-cls)))))))

(assert-equal (blog-gen-parse-elem-name "div")
             '("div" "" "" ""))
(assert-equal (blog-gen-parse-elem-name "div?id")
             '("div" "id" "" ""))
(assert-equal (blog-gen-parse-elem-name "div?id.c1.c2")
             '("div" "id" ".c1.c2" ""))
(assert-equal (blog-gen-parse-elem-name "div?id.c1.c2@foo=bar@baz=qux")
               '("div" "id" ".c1.c2" "foo=\"bar\" baz=\"qux\""))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org6a79386" class="outline-4">
<h4 id="org6a79386">Return string representation</h4>
<div class="outline-text-4" id="text-org6a79386">
<div class="org-src-container">
<pre><code class="src src-elisp"> (defun blog-gen-as-string(o)
   (cond
    ((stringp o) o)
    ((numberp o) (number-to-string o))
    (t (symbol-name o))))

(as-string 1)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga7652c6" class="outline-4">
<h4 id="orga7652c6">Custom Variables</h4>
<div class="outline-text-4" id="text-orga7652c6">
<div class="org-src-container">
<pre><code class="src src-elisp">(require 'ox-html)

 ;;; Variables and options

(defgroup org-export-blog nil
  "Options specific to RSS export back-end."
  :tag "Org Blog"
  :group 'org-export
  :version "24.4"
  :package-version '(Org . "9.0"))

(defcustom blog-gen-publish-url "https://MonadicT.github.io"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-title "MonadicT"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-author "Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-copyright-message "Copyright &amp;copy; 2014-%s, Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-style-file "blog-style.css"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-banner-file "banner.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-footer-file "footer.org"
  "???"
  :group 'org-export-blog
  :type 'string)

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org2be1597" class="outline-4">
<h4 id="org2be1597">Inner template generator</h4>
<div class="outline-text-4" id="text-org2be1597">
<p>
This function is called from Org-export machinery.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-inner-template (contents info)
  (mapconcat
   (lambda (x) (format "%s" x))
   (yatl-compile
    (body
     (div@style=display:flex
      (div@style=flex:2 "")
      (div@style=flex:6
       (div
        (blog-gen-top-matter)
        contents))
      (div@style=flex:2 "")
      (div.blog-footer
       (format blog-gen-copyright-message
               (format-time-string "%Y"))))))
  ""))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgec4c526" class="outline-4">
<h4 id="orgec4c526">twitter-link</h4>
<div class="outline-text-4" id="text-orgec4c526">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-twitter-link()
  "&lt;a target=\"_new\" href=\"https://twitter.com/MonadicT\"&gt;
&lt;span style={background-color: white; height:48px;width:48px;border-radius:24px}&gt;&lt;/span&gt;
&lt;img height=\"48px\" width=\"48px\"
   title=\"Visit my Twitter page\"
   src=\"/images/twitter.png\"/&gt;&lt;/a&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgffe33d3" class="outline-4">
<h4 id="orgffe33d3">github-link</h4>
<div class="outline-text-4" id="text-orgffe33d3">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-github-link()
  "&lt;a id=\"github-link\" target=\"_new\"
  href=\"https://github.com/MonadicT\"&gt;&lt;img id=\"github-logo\"
  src=\"/images/github-logo.png\"/&gt;&lt;/a&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgc710008" class="outline-4">
<h4 id="orgc710008">Home link</h4>
<div class="outline-text-4" id="text-orgc710008">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-home-link()
  "&lt;a href=\"/index.html\"&gt;Home&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org3d372f5" class="outline-4">
<h4 id="org3d372f5">Articles link</h4>
<div class="outline-text-4" id="text-org3d372f5">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-articles-link()
  "&lt;a href=\"/articles.html\"&gt;Articles&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org6fbb328" class="outline-4">
<h4 id="org6fbb328">About link</h4>
<div class="outline-text-4" id="text-org6fbb328">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-about-link()
  "&lt;a href=\"/about.html\"&gt;About&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org64d1b86" class="outline-4">
<h4 id="org64d1b86">Tags link</h4>
<div class="outline-text-4" id="text-org64d1b86">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-tags-link()
  "&lt;a href=\"/tags.html\"&gt;Tags&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org33d39fc" class="outline-4">
<h4 id="org33d39fc">Site links</h4>
<div class="outline-text-4" id="text-org33d39fc">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-site-links()
  (concat
   "&lt;div  id=\"site-links\"&gt;"
   (blog-gen-home-link)
   (blog-gen-articles-link)
   (blog-gen-tags-link)
   (blog-gen-about-link)
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orge8f4d96" class="outline-4">
<h4 id="orge8f4d96">Top matter</h4>
<div class="outline-text-4" id="text-orge8f4d96">
<p>
Generates the header and the banner. Here is one limitation of
<code>yatl-compile-string</code> which can generate a single element with dynamic
content but not nested elements as needed here.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-top-matter()
  (yatl-html-frag
   (div.blog-nav
    (div?blog-title
     blog-gen-title)
    (blog-gen-search-form))
   (div.blog-nav
    (blog-gen-site-links)
    (blog-gen-social-media-icons))
   (div@style=border:1px "")))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga6650aa" class="outline-4">
<h4 id="orga6650aa">Search form</h4>
<div class="outline-text-4" id="text-orga6650aa">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-search-form()
  "&lt;div&gt;Search &lt;form action=\"http://www.google.com/search\" id=\"searchform\"
method=\"get\"&gt;&lt;div&gt;&lt;input class=\"box\" id=\"s\" name=\"q\" type=\"text\" /&gt;
&lt;input name=\"sitesearch\" type=\"hidden\" value=\"http://MonadicT.github.io\" /&gt;
&lt;/div&gt;&lt;/form&gt;&lt;/div&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org12d8bdd" class="outline-4">
<h4 id="org12d8bdd">Social media icons</h4>
<div class="outline-text-4" id="text-org12d8bdd">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-social-media-icons()
  (concat
   "&lt;div id=\"social-media-icons\"&gt;"
   (blog-gen-twitter-link)
   (blog-gen-github-link)
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb7208b8" class="outline-3">
<h3 id="orgb7208b8">Mode implementation</h3>
<div class="outline-text-3" id="text-orgb7208b8">
<div class="org-src-container">
<pre><code class="src src-elisp"> ;;; Define backend

(org-export-define-derived-backend 'blog 'html
  :menu-entry
  '(?b "Export to Blog"
       ((?b "As Blog buffer"
            (lambda (a s v b) (blog-gen-export-as-blog a s v)))
        (?f "As Blog file" (lambda (a s v b) (blog-gen-export-to-blog a s v)))
        (?o "As Blog file and open"
            (lambda (a s v b)
              (if a (blog-gen-export-to-blog t s v)
                (org-open-file (blog-gen-export-to-blog nil s v)))))))
  :options-alist
  '((:description "DESCRIPTION" nil nil newline)
    (:keywords "KEYWORDS" nil nil space)
    (:with-toc nil nil nil) ;; Never include HTML's toc
    )
  :filters-alist '((:filter-final-output . blog-gen-final-function))
  :translate-alist '((comment . (lambda (&amp;rest args) ""))
                     (comment-block . (lambda (&amp;rest args) ""))
                     (timestamp . (lambda (&amp;rest args) ""))
                     (inner-template . blog-gen-inner-template)
                     (template . blog-gen-template)))

 ;;; Export functions

 ;;;###autoload
(defun blog-gen-export-as-blog (&amp;optional async subtreep visible-only)
  "Export current buffer to a blog buffer.

 Export is done in a buffer named \"*Org Blog Export*\", which will
 be displayed when `org-export-show-temporary-export-buffer' is
 non-nil."
  (interactive)
  (let ((file (buffer-file-name (buffer-base-buffer)))))
  (org-export-to-buffer 'blog "*Org Blog Export*"
    async subtreep visible-only nil nil (lambda () (text-mode))))

 ;;;###autoload
(defun blog-gen-export-to-blog (&amp;optional async subtreep visible-only)
  "Export current buffer to a Blog file.
 Return output file's name."
  (interactive)
  (let ((file (buffer-file-name (buffer-base-buffer)))))
  (let ((outfile (org-export-output-file-name
                  (concat "." "html") subtreep)))
    (org-export-to-file 'blog outfile async subtreep visible-only)))

 ;;;###autoload
(defun blog-gen-publish-to-blog (plist filename pub-dir)
  "Publish an org file to Blog.

 FILENAME is the filename of the Org file to be published.  PLIST
 is the property list for the given project.  PUB-DIR is the
 publishing directory.

 Return output file name."
  (let ((bf (get-file-buffer filename)))
    (if bf
        (with-current-buffer bf
          (write-file filename))
      (find-file filename)
      (write-file filename) (kill-buffer)))
  (org-publish-org-too
   'log filename (concat "." "html") plist pub-dir))

 ;;; Main transcoding functions

(defun blog-gen-template (contents info)
  "Return complete document string after BLOG conversion.
 CONTENTS is the transcoded contents string.  INFO is a plist
 used as a communication channel."
  (yatl-html5
   (head
    (yatl-compile-string "meta@charset=\"%s\"&gt;"
            (symbol-name org-html-coding-system))
    (title blog-gen-title)
    (yatl-compile-string
     "base@href=\"%s\""
     (blog-gen-base-url))
    (yatl-compile-string "meta@name=generator@content=\"%s\"&gt;" (emacs-version))
    (yatl-compile-string "meta@name=author@content=\"%s\"" blog-gen-author)
    (link@href=\"blog-style.css\"@rel=\"stylesheet\"))
   contents))

 ;;; Filters

(defun blog-gen-final-function (contents backend info)
  "Prettify the Blog output."
  (with-temp-buffer
    (xml-mode)
    (insert contents)
    ;;(indent-region (point-min) (point-max))
    (buffer-substring-no-properties (point-min) (point-max))))

 ;;; Miscellaneous


(provide 'ox-blog)

 ;;; ox-blog.el ends here

</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">(require 'ox-html)
(defun my-html-body-filter(text backend info)
  text)

(add-to-list 'org-export-filter-body-functions
             'my-html-body-filter)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org7151ba1" class="outline-3">
<h3 id="org7151ba1">Styles</h3>
<div class="outline-text-3" id="text-org7151ba1">
<p>
CSS Styles used in this blog are managed using interpolated
strings. The code below is an association list which is used to build
CSS string later.
</p>
</div>

<div id="outline-container-org534fc1e" class="outline-4">
<h4 id="org534fc1e">Color definitions</h4>
<div class="outline-text-4" id="text-org534fc1e">
<p>
CSS color definitions.
</p>

<ul class="org-ul">
<li>Dark primary color.</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#616161
</code></pre>
</div>

<ul class="org-ul">
<li>Default primary color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#9E9E9E
</code></pre>
</div>

<ul class="org-ul">
<li>Light primary color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#d3d3d3
</code></pre>
</div>

<ul class="org-ul">
<li>Text primary color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#212121
</code></pre>
</div>

<ul class="org-ul">
<li>Accent color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#ff5722
</code></pre>
</div>

<ul class="org-ul">
<li>Primary text color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#212121
</code></pre>
</div>

<ul class="org-ul">
<li>Secondary text color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#757575
</code></pre>
</div>

<ul class="org-ul">
<li>Accent text color</li>
</ul>
<div class="org-src-container">
<pre><code class="src src-elisp">#FF5722
</code></pre>
</div>
</div>
</div>


<div id="outline-container-org913829b" class="outline-4">
<h4 id="org913829b">HTML element styling</h4>
<div class="outline-text-4" id="text-org913829b">
<p>
Style definitions for general html elements.
</p>

<p>
/Setting body.height to 100% paints background to visible portion of
blog content and leaving it empty results in left and right borders at
zero height. The only reasonable fix is to be able to specify heights
for all layout divs to be in resolution independent units/
</p>

<div class="org-src-container">
<pre><code class="src src-elisp"> * { font-family: "Merriweather", Georgia, serif; }
html { clear: both; Height: 100%; width: 100% }
body { margin: 0; padding: 0; width: 100%; display: flex; flex-direction: column }
body {
    background-color: #dfe3ee
}

a { color: &lt;&lt;accent-text-color&gt;&gt;; text-decoration: none}

a:hover {  color: &lt;&lt;accent-color&gt;&gt;; opacity: 0.5; }
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga2933ee" class="outline-4">
<h4 id="orga2933ee">Page layout styling</h4>
<div class="outline-text-4" id="text-orga2933ee">
<div class="org-src-container">
<pre><code class="src src-css">h2 {
    color: &lt;&lt;accent-text-color&gt;&gt;;
}

#blog-title {
    font-size: 3em;
    font-weight: bolder;
    color: &lt;&lt;accent-text-color&gt;&gt;;
}

.blog-nav {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #999
}


</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgeda729d" class="outline-4">
<h4 id="orgeda729d">Site links styling</h4>
<div class="outline-text-4" id="text-orgeda729d">
<div class="org-src-container">
<pre><code class="src src-elisp">#site-links {
}

#site-links a {
    color: &lt;&lt;accent-text-color&gt;&gt;;
    font-size: 1em;
    font-style: italic;
    text-decoration: none;
    padding-right: 1em
}

#social-media-icons {
}

#github-logo {
    vertical-align: super
}
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgee2d124" class="outline-4">
<h4 id="orgee2d124">Post styling</h4>
<div class="outline-text-4" id="text-orgee2d124">
<div class="org-src-container">
<pre><code class="src src-elisp">.post-title {
    font-size: 1.25em;
    font-weight: bold;
    color: &lt;&lt;accent-text-color&gt;&gt;;
    border-bottom: 2px solid #ddd
}

.post-summary {
    font-size: small;
    color: &lt;&lt;secondary-text-color&gt;&gt;;
    padding-top: 0.5em;
    padding-left: 1em;
}

.post-tags {
    font-size: small;
    color: &lt;&lt;secondary-text-color&gt;&gt;;
    padding-top: 1em;
    padding-left: 1em;
}

.pub-date { font-weight: bold; color: &lt;&lt;secondary-text-color&gt;&gt;; padding-bottom: 2em; }

.post-publish-date {
    font-size: 0.75em;
    color: #777;
    padding-top: 0.5em;
    padding-left: 1em;
    padding-bottom: 1em;
}
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org41b7e22" class="outline-4">
<h4 id="org41b7e22">Class definitions</h4>
<div class="outline-text-4" id="text-org41b7e22">
<div class="org-src-container">
<pre><code class="src src-elisp">.margin-row {
    display: flex;
    flex-direction: row;
    width: 100%;
    justify-content: space-between;
    align-items: center;
}

.blog-margin-left, .blog-margin-right {
    flex: 2;
    width: 100px;
}

.blog-margin-middle {
    flex: 6;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.blog-footer {
    display: flex;
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 1em;
    font-size: 0.5em;
    font-weight: bold;
    padding: 5px;
    flex-direction: row;
    justify-content: center;
    border-top: solid 1px #dfe3ee;
    color: &lt;&lt;accent-text-color&gt;&gt;; /* #3b5998, #dfe3ee, #8b9dc3*/
    background-color: &lt;&lt;light-primary-color&gt;&gt;; /*#dfe3ee;*/
}
/* , #8b9dc3 */
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org1edaf72" class="outline-4">
<h4 id="org1edaf72">Tangling Stylesheet</h4>
<div class="outline-text-4" id="text-org1edaf72">
<div class="org-src-container">
<pre><code class="src src-css"> * { font-family: "Merriweather", Georgia, serif; }
html { clear: both; Height: 100%; width: 100% }
body { margin: 0; padding: 0; width: 100%; display: flex; flex-direction: column }
body {
    background-color: #dfe3ee
}

a { color: #FF5722; text-decoration: none}

a:hover {  color: #ff5722; opacity: 0.5; }
h2 {
    color: #FF5722;
}

#blog-title {
    font-size: 3em;
    font-weight: bolder;
    color: #FF5722;
}

.blog-nav {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #999
}


.post-title {
    font-size: 1.25em;
    font-weight: bold;
    color: #FF5722;
    border-bottom: 2px solid #ddd
}

.post-summary {
    font-size: small;
    color: #757575;
    padding-top: 0.5em;
    padding-left: 1em;
}

.post-tags {
    font-size: small;
    color: #757575;
    padding-top: 1em;
    padding-left: 1em;
}

.pub-date { font-weight: bold; color: #757575; padding-bottom: 2em; }

.post-publish-date {
    font-size: 0.75em;
    color: #777;
    padding-top: 0.5em;
    padding-left: 1em;
    padding-bottom: 1em;
}
.margin-row {
    display: flex;
    flex-direction: row;
    width: 100%;
    justify-content: space-between;
    align-items: center;
}

.blog-margin-left, .blog-margin-right {
    flex: 2;
    width: 100px;
}

.blog-margin-middle {
    flex: 6;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.blog-footer {
    display: flex;
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 1em;
    font-size: 0.5em;
    font-weight: bold;
    padding: 5px;
    flex-direction: row;
    justify-content: center;
    border-top: solid 1px #dfe3ee;
    color: #FF5722; /* #3b5998, #dfe3ee, #8b9dc3*/
    background-color: #d3d3d3; /*#dfe3ee;*/
}
/* , #8b9dc3 */
#site-links {
}

#site-links a {
    color: #FF5722;
    font-size: 1em;
    font-style: italic;
    text-decoration: none;
    padding-right: 1em
}

#social-media-icons {
}

#github-logo {
    vertical-align: super
}
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org66c6900" class="outline-3">
<h3 id="org66c6900">Org-file analyzer</h3>
<div class="outline-text-3" id="text-org66c6900">
</div>
<div id="outline-container-org4a95f78" class="outline-4">
<h4 id="org4a95f78">Return keywords from org-file</h4>
<div class="outline-text-4" id="text-org4a95f78">
<p>
Returns list of OrgMode keywords from the current document.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-get-all-keywords()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (lambda (kw)
      (cons (org-element-property :key kw)
            (org-element-property :value kw)))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org41022c6" class="outline-4">
<h4 id="org41022c6">Get keyword</h4>
<div class="outline-text-4" id="text-org41022c6">
<p>
Returns value of <code>key</code> or <code>default-value</code> if <code>key</code> doesn't exist in <code>keywords</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-get-keyword-value(keywords key &amp;optional default-value)
  (if-let ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org07d6c75" class="outline-3">
<h3 id="org07d6c75">Blog publishing</h3>
<div class="outline-text-3" id="text-org07d6c75">
</div>
<div id="outline-container-org7c3f995" class="outline-4">
<h4 id="org7c3f995">Blog source directory</h4>
<div class="outline-text-4" id="text-org7c3f995">
<p>
The root directory where the source for blogs is kept.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defcustom blog-gen-root-dir
  "~/stuff/github/MonadicT.github.io/"
  "")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org095d2c7" class="outline-4">
<h4 id="org095d2c7">Blog posts directory</h4>
<div class="outline-text-4" id="text-org095d2c7">
<p>
The subdirectory where <code>.org</code> files are stored.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defcustom blog-gen-posts-dir
  "_resources/posts"
  "")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgf263a4f" class="outline-4">
<h4 id="orgf263a4f">Publishing locally</h4>
<div class="outline-text-4" id="text-orgf263a4f">
<p>
This is a Boolean flag set to use <code>base</code> url for generated html files.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(setq blog-gen-local t)
</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-base-url()
  (if blog-gen-local "http://localhost:8000/" "https://MonadicT.github.io/"))

</code></pre>
</div>
</div>
</div>
<div id="outline-container-orgc2ac8e0" class="outline-4">
<h4 id="orgc2ac8e0">Extract post details</h4>
<div class="outline-text-4" id="text-orgc2ac8e0">
<p>
Extracts post title, summary and <code>publish-date</code> from the file. Nil is
returned if <code>publish-date</code> is not present.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-post-details (f)
  (with-temp-buffer
    (find-file f)
    (let* ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  :test #'equal))
           (export-file-name (blog-gen-get-keyword-value kws "export_file_name" nil))
           (href (or export-file-name "")))
      (while (string-match "^\\.\\./" href)
        (setq href (substring href 3)))
      (puthash "post-file" f details)
      (puthash "title" (blog-gen-get-keyword-value kws "title" "") details)
      (puthash "summary" (blog-gen-get-keyword-value kws "summary" "") details)
      (puthash "publish-date" (blog-gen-get-keyword-value kws "publish-date" nil) details)
      (puthash "export_file_name" export-file-name details)
      (puthash "tags" (blog-gen-get-keyword-value kws "tags" "") details)
      (puthash "target" (blog-gen-get-keyword-value kws "target" "") details)
      (puthash "href" (concat (blog-gen-base-url) href) details)
      (unless (string-match "blog-generator.org" f) (kill-buffer))
      details)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org02c7aa2" class="outline-4">
<h4 id="org02c7aa2">Post files</h4>
<div class="outline-text-4" id="text-org02c7aa2">
<p>
Returns list of posts stored in <code>.org</code> files. <code>.org</code> files such as
<code>index.org</code>, <code>about.org</code> are not returned as posts.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-post-files()
  (let* ((posts-dir (concat blog-gen-root-dir "/" blog-gen-posts-dir))
         (org-files (directory-files posts-dir t "[a-ZA-Z0-9_-]*\\.org$"))
         (org-files
          (seq-remove
           (lambda (f)
             (or (string-match "index.org$" f)
                 (string-match "about.org$" f)
                 (string-match "sitemap.org$" f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org0341df7" class="outline-4">
<h4 id="org0341df7">Published post files</h4>
<div class="outline-text-4" id="text-org0341df7">
<p>
Returns published posts (posts which have <code>export_file_name</code> keyword).
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-published-posts (posts)
  (seq-filter (lambda (p) (gethash "export_file_name" p)) posts))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org65fa4a2" class="outline-4">
<h4 id="org65fa4a2">Order post files</h4>
<div class="outline-text-4" id="text-org65fa4a2">
<p>
Orders posts by <code>publish-date</code> descending.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-order-posts(posts)
  (seq-sort (lambda (a b) (string&gt; (gethash "publish-date" a) (gethash "publish-date" b))) posts))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgfd38ebd" class="outline-4">
<h4 id="orgfd38ebd">Macro to generate <code>html_export</code> blocks</h4>
<div class="outline-text-4" id="text-orgfd38ebd">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro html-export(&amp;rest content)
  `(progn (insert "#+BEGIN_EXPORT html\n")
          (insert ,@content)
          (insert "\n#+END_EXPORT\n\n")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgcad5e6f" class="outline-4">
<h4 id="orgcad5e6f">Articles generation</h4>
<div class="outline-text-4" id="text-orgcad5e6f">
<p>
Exports all <code>.org</code> post files to <code>.html</code> files.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-posts()
  (let ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (lambda (post)
       (let ((post-file (gethash "post-file" post))
             (export-file-name (gethash "export_file_name" post)))
         (message (concat "exporting" post-file "to" export-file-name))
         (when export-file-name
           (with-temp-buffer
             (find-file post-file)
             (org-export-to-file 'blog export-file-name)
             (kill-buffer)))))
     posts)))
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org20fe98c" class="outline-4">
<h4 id="org20fe98c">Articles page generation</h4>
<div class="outline-text-4" id="text-org20fe98c">
<p>
Generates list of articles.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-articles()
  (with-temp-buffer
    (find-file "index.org")
    (erase-buffer)
    (insert "#+title: MonadictT\n")
    (insert "#+options: num:nil html-style:nil\n")
    (insert "* Posts\n")
    (let ((posts (blog-gen-order-posts
                  (blog-gen-published-posts
                   (blog-gen-post-files)))))
      (mapcar
       (lambda (post)
         (let* ((title (gethash "title" post))
                (summary (gethash "summary"  post))
                (export-file-name (gethash "export_file_name"  post))
                (export-file-name
                 (let ((href export-file-name))
                   (while (string-match "^\\.\\./" href)
                     (setq href (substring href 3)))
                   href))
                (publish-date (gethash "publish-date" post))
                (l (list (make-symbol (format "a@href=\"/%s\"" export-file-name)) title)))
           (html-export
            (yatl-html-frag
             (div.post-title
              (eval (yatl-compile-fn l)))))
           (html-export
            (yatl-html-frag
             (div.post-summary summary)) "\n\n")
           (html-export
            (yatl-html-frag
             (div.post-publish-date "Published: " publish-date)) "\n")))
       posts))
    (save-buffer)
    (let ((out-file (concat blog-gen-root-dir "articles.html")))
      (when (file-exists-p out-file)
        (delete-file out-file))
      (org-export-to-file 'blog out-file))
    (delete-file "index.org")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgbda408f" class="outline-4">
<h4 id="orgbda408f">Tags generation</h4>
<div class="outline-text-4" id="text-orgbda408f">
<p>
Posts have a <code>#+tags</code> header and tags are separated by <code>,</code>. This
function builds a hashtable of tags to a list posts from <code>posts</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun create-tag-post-map(posts)
  (let ((tag-post-map (make-hash-table :test 'equal)))
    (mapcar
     (lambda(post)
       (let ((title (gethash "title" post))
             (tags (mapcar #'s-trim (split-string (gethash "tags" post) "[,]+"))))
         (mapcar
          (lambda (tag)
            (when (not (string-empty-p tag))
              (puthash tag (cons post (gethash tag tag-post-map '())) tag-post-map)))
          tags)))
     posts)
    tag-post-map))
</code></pre>
</div>

<p>
Tags should be ordered in lexicographic order. This function returns
tags in ascending order.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun sorted-keys(tag-post-map)
  (let ((keys '()))
    (maphash
     (lambda (k v) (setq keys (cons k keys)))
     tag-post-map)
    (seq-sort (lambda (a b) (string-lessp (upcase a) (upcase b))) keys)))
</code></pre>
</div>

<p>
Once we have the <code>tag-post-map</code>, we can generate an <code>org-mode</code>
representation of it. The tag is listed as second-level header with a
bullet list of anchors to posts.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-tags(posts)
  (let* ((tag-post-map (create-tag-post-map posts))
         (tags  (sorted-keys tag-post-map)))
    (with-temp-buffer
      (find-file "tags.org")
      (erase-buffer)
      (insert "#+title: Tags\n")
      (insert "#+options: num:nil\n")
      (insert "* Tags\n")
      (mapcar
       (lambda (tag)
         (let ((post-list (gethash tag tag-post-map)))
           (insert "** " tag "\n")
           (mapcar
            (lambda (post)
              (princ post)
              (let ((title (gethash "title" post))
                    (href  (gethash "href" post)))
                (insert "- [[" href "][" title "]]\n")))
            post-list)))
       tags)
      (write-file "tags.org")
      (let ((out-file (concat blog-gen-root-dir "tags.html")))
      (message out-file)
        (org-export-to-file 'blog out-file))
      (kill-buffer))))


;;  (setq x (blog-gen-post-files))

;;  (blog-gen-create-tags x)

;;  (require 'blog-gen)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org2b7b708" class="outline-4">
<h4 id="org2b7b708">About page generation.</h4>
<div class="outline-text-4" id="text-org2b7b708">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-about()
  (with-temp-buffer
    (find-file "about.org")
    (org-export-to-file 'blog (concat blog-gen-root-dir "about.html"))
    (kill-buffer)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgffd919b" class="outline-4">
<h4 id="orgffd919b">Home page generation</h4>
<div class="outline-text-4" id="text-orgffd919b">
<p>
For now, <i>Home</i> points to <i>Articles</i>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-home()
  (copy-file
   (concat blog-gen-root-dir "articles.html")
   (concat blog-gen-root-dir "index.html") t))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org2edf58b" class="outline-4">
<h4 id="org2edf58b">Generates blog,</h4>
<div class="outline-text-4" id="text-org2edf58b">
<p>
Function to regenerate the full site. This is bound to <code>C-c C-g</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defun blog-gen-publish(prod)
    (interactive "P")
    (if prod (setq blog-gen-local nil) (setq blog-gen-local t))
    (let ((posts (blog-gen-post-files)))
      (blog-gen-create-posts)
      (blog-gen-create-articles)
      (blog-gen-create-tags posts)
      (blog-gen-create-about)
      (blog-gen-create-home))
    (when prod
      (when (blog-gen-file-contains-p "localhost")
        (error "localhost references in file"))))
(defun blog-gen-file-contains-p(s) nil)
  (global-set-key (kbd "C-c C-g") #'blog-gen-publish)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org4facbcb" class="outline-4">
<h4 id="org4facbcb">Create new blog post</h4>
<div class="outline-text-4" id="text-org4facbcb">
<p>
A template for creating a new blog post.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defun blog-gen-new-post()
    (interactive)
    (insert "#+title: TBD
#+summary: TBD
#+publish-date: 2018-01-31
#+export_file_name: ../../yyyy/TBD
#+tags: TBD
#+option: num:nil"))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga784841" class="outline-4">
<h4 id="orga784841">Tangled elisp file</h4>
<div class="outline-text-4" id="text-orga784841">
<p>
All the functions described above are tangled into
~/.emacs.d/lisp/blog-gen.el. A <code>require</code> in <code>.emacs</code> will make this
available for use.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">;;; blog-gen.el --- Static site generator in emacs and org-mode

;; Copyright (C) 2017-2018 Praki Prakash

;; Author: Praki Prakash
;; Maintainer: Praki Prakash
;; Created: 2017-12-31
;; Keywords: languages
;; Homepage: https://MonadicT.gihub.io

;; This file is not part of GNU Emacs.
</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">;;; blog-gen.el --- Static site generator in emacs and org-mode

;; Copyright (C) 2017-2018 Praki Prakash

;; Author: Praki Prakash
;; Maintainer: Praki Prakash
;; Created: 2017-12-31
;; Keywords: languages
;; Homepage: https://MonadicT.gihub.io

;; This file is not part of GNU Emacs.
;;; Dependencies ----------------------
(require 'cl)
(require 'yatl)

;;; Variables
(require 'ox-html)

 ;;; Variables and options

(defgroup org-export-blog nil
  "Options specific to RSS export back-end."
  :tag "Org Blog"
  :group 'org-export
  :version "24.4"
  :package-version '(Org . "9.0"))

(defcustom blog-gen-publish-url "https://MonadicT.github.io"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-title "MonadicT"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-author "Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-copyright-message "Copyright &amp;copy; 2014-%s, Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-style-file "blog-style.css"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-banner-file "banner.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-footer-file "footer.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-root-dir
  "~/stuff/github/MonadicT.github.io/"
  "")
(defcustom blog-gen-posts-dir
  "_resources/posts"
  "")
(setq blog-gen-local t)

;;; Functions ------------------------
(defmacro assert-equal (actual expected)
  `(when (not (equal ,actual ,expected))
     (error "Actual: %s expected: %s"
            (format "%s" ',actual)
            (format "%s" ',expected))))
(defun blog-gen-get-all-keywords()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (lambda (kw)
      (cons (org-element-property :key kw)
            (org-element-property :value kw)))))
(defun blog-gen-get-keyword-value(keywords key &amp;optional default-value)
  (if-let ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
(defun blog-gen-post-details (f)
  (with-temp-buffer
    (find-file f)
    (let* ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  :test #'equal))
           (export-file-name (blog-gen-get-keyword-value kws "export_file_name" nil))
           (href (or export-file-name "")))
      (while (string-match "^\\.\\./" href)
        (setq href (substring href 3)))
      (puthash "post-file" f details)
      (puthash "title" (blog-gen-get-keyword-value kws "title" "") details)
      (puthash "summary" (blog-gen-get-keyword-value kws "summary" "") details)
      (puthash "publish-date" (blog-gen-get-keyword-value kws "publish-date" nil) details)
      (puthash "export_file_name" export-file-name details)
      (puthash "tags" (blog-gen-get-keyword-value kws "tags" "") details)
      (puthash "target" (blog-gen-get-keyword-value kws "target" "") details)
      (puthash "href" (concat (blog-gen-base-url) href) details)
      (unless (string-match "blog-generator.org" f) (kill-buffer))
      details)))
(defun blog-gen-post-files()
  (let* ((posts-dir (concat blog-gen-root-dir "/" blog-gen-posts-dir))
         (org-files (directory-files posts-dir t "[a-ZA-Z0-9_-]*\\.org$"))
         (org-files
          (seq-remove
           (lambda (f)
             (or (string-match "index.org$" f)
                 (string-match "about.org$" f)
                 (string-match "sitemap.org$" f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
(defun blog-gen-published-posts (posts)
  (seq-filter (lambda (p) (gethash "export_file_name" p)) posts))
(defun blog-gen-order-posts(posts)
  (seq-sort (lambda (a b) (string&gt; (gethash "publish-date" a) (gethash "publish-date" b))) posts))
(defmacro html-export(&amp;rest content)
  `(progn (insert "#+BEGIN_EXPORT html\n")
          (insert ,@content)
          (insert "\n#+END_EXPORT\n\n")))
(defun blog-gen-create-posts()
  (let ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (lambda (post)
       (let ((post-file (gethash "post-file" post))
             (export-file-name (gethash "export_file_name" post)))
         (message (concat "exporting" post-file "to" export-file-name))
         (when export-file-name
           (with-temp-buffer
             (find-file post-file)
             (org-export-to-file 'blog export-file-name)
             (kill-buffer)))))
     posts)))
(defun blog-gen-create-articles()
  (with-temp-buffer
    (find-file "index.org")
    (erase-buffer)
    (insert "#+title: MonadictT\n")
    (insert "#+options: num:nil html-style:nil\n")
    (insert "* Posts\n")
    (let ((posts (blog-gen-order-posts
                  (blog-gen-published-posts
                   (blog-gen-post-files)))))
      (mapcar
       (lambda (post)
         (let* ((title (gethash "title" post))
                (summary (gethash "summary"  post))
                (export-file-name (gethash "export_file_name"  post))
                (export-file-name
                 (let ((href export-file-name))
                   (while (string-match "^\\.\\./" href)
                     (setq href (substring href 3)))
                   href))
                (publish-date (gethash "publish-date" post))
                (l (list (make-symbol (format "a@href=\"/%s\"" export-file-name)) title)))
           (html-export
            (yatl-html-frag
             (div.post-title
              (eval (yatl-compile-fn l)))))
           (html-export
            (yatl-html-frag
             (div.post-summary summary)) "\n\n")
           (html-export
            (yatl-html-frag
             (div.post-publish-date "Published: " publish-date)) "\n")))
       posts))
    (save-buffer)
    (let ((out-file (concat blog-gen-root-dir "articles.html")))
      (when (file-exists-p out-file)
        (delete-file out-file))
      (org-export-to-file 'blog out-file))
    (delete-file "index.org")))
(defun create-tag-post-map(posts)
  (let ((tag-post-map (make-hash-table :test 'equal)))
    (mapcar
     (lambda(post)
       (let ((title (gethash "title" post))
             (tags (mapcar #'s-trim (split-string (gethash "tags" post) "[,]+"))))
         (mapcar
          (lambda (tag)
            (when (not (string-empty-p tag))
              (puthash tag (cons post (gethash tag tag-post-map '())) tag-post-map)))
          tags)))
     posts)
    tag-post-map))
(defun sorted-keys(tag-post-map)
  (let ((keys '()))
    (maphash
     (lambda (k v) (setq keys (cons k keys)))
     tag-post-map)
    (seq-sort (lambda (a b) (string-lessp (upcase a) (upcase b))) keys)))
(defun blog-gen-create-tags(posts)
  (let* ((tag-post-map (create-tag-post-map posts))
         (tags  (sorted-keys tag-post-map)))
    (with-temp-buffer
      (find-file "tags.org")
      (erase-buffer)
      (insert "#+title: Tags\n")
      (insert "#+options: num:nil\n")
      (insert "* Tags\n")
      (mapcar
       (lambda (tag)
         (let ((post-list (gethash tag tag-post-map)))
           (insert "** " tag "\n")
           (mapcar
            (lambda (post)
              (princ post)
              (let ((title (gethash "title" post))
                    (href  (gethash "href" post)))
                (insert "- [[" href "][" title "]]\n")))
            post-list)))
       tags)
      (write-file "tags.org")
      (let ((out-file (concat blog-gen-root-dir "tags.html")))
      (message out-file)
        (org-export-to-file 'blog out-file))
      (kill-buffer))))


;;  (setq x (blog-gen-post-files))

;;  (blog-gen-create-tags x)

;;  (require 'blog-gen)
(defun blog-gen-create-about()
  (with-temp-buffer
    (find-file "about.org")
    (org-export-to-file 'blog (concat blog-gen-root-dir "about.html"))
    (kill-buffer)))
(defun blog-gen-create-home()
  (copy-file
   (concat blog-gen-root-dir "articles.html")
   (concat blog-gen-root-dir "index.html") t))
  (defun blog-gen-publish(prod)
    (interactive "P")
    (if prod (setq blog-gen-local nil) (setq blog-gen-local t))
    (let ((posts (blog-gen-post-files)))
      (blog-gen-create-posts)
      (blog-gen-create-articles)
      (blog-gen-create-tags posts)
      (blog-gen-create-about)
      (blog-gen-create-home))
    (when prod
      (when (blog-gen-file-contains-p "localhost")
        (error "localhost references in file"))))
(defun blog-gen-file-contains-p(s) nil)
  (global-set-key (kbd "C-c C-g") #'blog-gen-publish)
  (defun blog-gen-new-post()
    (interactive)
    (insert "#+title: TBD
#+summary: TBD
#+publish-date: 2018-01-31
#+export_file_name: ../../yyyy/TBD
#+tags: TBD
#+option: num:nil"))

(provide 'blog-gen)
;;; blog-gen.el ends here
</code></pre>
</div>
</div>
</div>
</div>
</div>

</div>

</div>
 <div style="flex:2">

</div>
 <div class=" blog-footer">
Copyright &copy; 2014-2018, Praki Prakash
</div>

</div>

</body>
</html>
