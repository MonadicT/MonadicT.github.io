<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8>"/>
 <title>
MonadicT
</title>
 <base href="https://MonadicT.github.io/"/>
 <meta name="generator" content="GNU Emacs 25.3.1 (aarch64-unknown-linux-gnu, GTK+ Version 3.22.26)
 of 2017-12-09>"/>
 <meta name="author" content="Praki Prakash"/>
 <link href="blog-style.css" rel="stylesheet"/>

</head>
<body>
<div id="blog-header" class="margin-row"><div class="blog-margin-left"></div><div class="blog-margin-middle" id="xblog-header"><h1><div id="blog-title">MonadicT</div></h1><div>Search <form action="http://www.google.com/search" id="searchform"
method="get"><div><input class="box" id="s" name="q" type="text" />
<input name="sitesearch" type="hidden" value="http://MonadicT.github.io" />
</div></form></div></div><div class="blog-margin-right"></div></div>
<div id="blog-banner" class="margin-row"><div class="blog-margin-left"></div><div class="blog-margin-middle"><div  id="site-links"><a href="/index.html">Home</a><a href="/articles.html">Articles</a><a href="/tags.html">Tags</a><a href="/about.html">About</a></div><div id="social-media-icons"><a target="_new" href="https://twitter.com/MonadicT">
<span style={background-color: white; height:48px;width:48px;border-radius:24px}></span>
<img height="48px" width="48px"
   title="Visit my Twitter page"
   src="/images/twitter.png"/></a><a id="github-link" target="_new"
  href="https://github.com/MonadicT"><img id="github-logo"
  height="48" width="48" src="/images/github.png"/></a></div></div><div class="blog-margin-right"></div></div> <div id="blog-content">
<div id="blog-content-left">

</div>
 <div id="blog-content-middle">

<div id="outline-container-orgebb881e" class="outline-2">
<h2 id="orgebb881e">Blog site generator</h2>
<div class="outline-text-2" id="text-orgebb881e">
</div>
<div id="outline-container-orgfbcb636" class="outline-3">
<h3 id="orgfbcb636">Overview</h3>
<div class="outline-text-3" id="text-orgfbcb636">
<p>
Org-mode has a flexible export framework which can be leveraged to
generate Html content suitable for publishing with Jekyll, a static
site generator. This post describes the elisp package I use to
maintain my blog at <a href="https://monadict.github.io">https://monadict.github.io</a>.
</p>

<p>
Blog entries are written as a regular <code>.org</code> file. A post should have
a <code>#+title</code>, <code>#+summary</code>, <code>#+publish_date</code>, <code>#+tags</code> and
<code>#+export_file_name</code> for proper formatting and structure. The
<code>export_file_name</code> header is used by Org-mode to create the generated
Html file.
</p>

<p>
The entire site with Home, About, Tags, RSS and all the posts can be
regenerated by <code>Meta blog-gen-publish</code>, also bound to <code>C-c C-g</code>. An
individual post can be quickly examined by invoking Org export menu
(<code>C-c C-e</code>) which shows the options for processing the buffer. <code>C-c
C-e</code> C-f will generate a HTML file.
</p>

<p>
If there is <code>#+publish-data</code> header, the post will be skipped when the
site is regenerated.
</p>

<p>
A new blog entry with all the required headers can be created by
executing <code>blog-gen-new-post</code>.
</p>
</div>
</div>

<div id="outline-container-orgcbe6cb7" class="outline-3">
<h3 id="orgcbe6cb7">Design description</h3>
<div class="outline-text-3" id="text-orgcbe6cb7">
<ul class="org-ul">
<li>Customizable variables describe</li>
</ul>
</div>
</div>
<div id="outline-container-org2983f3a" class="outline-3">
<h3 id="org2983f3a">Implementation</h3>
<div class="outline-text-3" id="text-org2983f3a">
</div>
<div id="outline-container-org1e0f8d7" class="outline-4">
<h4 id="org1e0f8d7">Dependencies</h4>
<div class="outline-text-4" id="text-org1e0f8d7">
<p>
Not many! <code>yatl</code> is my Elisp package for generating Html fragments
from s-expressions.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(require 'cl)
(require 'yatl)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org9bea88b" class="outline-4">
<h4 id="org9bea88b">Useful macros/functions</h4>
</div>
<div id="outline-container-org332f5bc" class="outline-4">
<h4 id="org332f5bc">Assert utlity</h4>
<div class="outline-text-4" id="text-org332f5bc">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro assert-equal (actual expected)
  `(when (not (equal ,actual ,expected))
     (error "Actual: %s expected: %s"
            (format "%s" ',actual)
            (format "%s" ',expected))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgb01823e" class="outline-4">
<h4 id="orgb01823e">Key-value string parser</h4>
<div class="outline-text-4" id="text-orgb01823e">
<p>
Parses key-value string of form <i>@key=val@key=val</i>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-parse-kvp(s)
  (let (res)
    (mapconcat
     (lambda (kv-str)
       (let* ((kv (split-string kv-str "="))
              (key (car kv))
              (val (cadr kv))
              (val (if (string-match "^\".*\"$" val)
                       val
                     (format "\"%s\"" val))))
         (concat key "=" val)))
     (split-string s "@" t)
     " ")))

(assert-equal (blog-gen-parse-kvp "") "")
(assert-equal (blog-gen-parse-kvp "@") "")
(assert-equal (blog-gen-parse-kvp "@a=b") "a=\"b\"")
(assert-equal (blog-gen-parse-kvp "@a=b@c=d") "a=\"b\" c=\"d\"")

</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defmacro lisp (&amp;rest forms)
    `(let ((res ,@forms))
       res))

(assert-equal (lisp 1) 1)
(assert-equal (lisp (+ 1 2 3)) 6)
(assert-equal (lisp (concat "a" "n")) "an")
(assert-equal (lisp (list 1 2 3)) '(1 2 3))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org064776a" class="outline-4">
<h4 id="org064776a">Parse element name</h4>
<div class="outline-text-4" id="text-org064776a">
<p>
Parses element name and returns the list of element name, id, class
and attributes. Multiple class names but id must be unique. Id is
introdued by |?|, class name with |.| and attribute with |!|.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">;; Exanple names: div, div?id, div.cls1.clas2, div!k=v!k=v
(defun blog-gen-parse-elem-name(s)
  (let ((nm-id-cls (list '() '() '() '()))
        attrs idx buf)
    (setq  idx 0)
    (mapcar
     (lambda (c)
       (cond
        ((eq c ?.) (progn
                     (setq idx 2)
                     (push c (nth idx nm-id-cls))))
        ((eq c ??) (progn
                     (if (null (cadr nm-id-cls))
                         (setq idx 1)
                       (error "ID specified again!"))))
        ((eq c ?@) (progn
                     (setq idx 3)
                     (push c (nth idx nm-id-cls))))
        ((eq idx -1) (error "Expect one of \".,+,#'"))
        (t (push c (nth idx nm-id-cls)))))
     s)
    (list (concat (reverse (car nm-id-cls)))
          (concat (reverse (cadr nm-id-cls)))
          (concat (reverse (caddr nm-id-cls)))
          (blog-gen-parse-kvp (concat (reverse (nth 3 nm-id-cls)))))))

(assert-equal (blog-gen-parse-elem-name "div")
             '("div" "" "" ""))
(assert-equal (blog-gen-parse-elem-name "div?id")
             '("div" "id" "" ""))
(assert-equal (blog-gen-parse-elem-name "div?id.c1.c2")
             '("div" "id" ".c1.c2" ""))
(assert-equal (blog-gen-parse-elem-name "div?id.c1.c2@foo=bar@baz=qux")
               '("div" "id" ".c1.c2" "foo=\"bar\" baz=\"qux\""))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgaa4645b" class="outline-4">
<h4 id="orgaa4645b">Return string representation</h4>
<div class="outline-text-4" id="text-orgaa4645b">
<div class="org-src-container">
<pre><code class="src src-elisp"> (defun blog-gen-as-string(o)
   (cond
    ((stringp o) o)
    ((numberp o) (number-to-string o))
    (t (symbol-name o))))

(as-string 1)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org3d20ce2" class="outline-4">
<h4 id="org3d20ce2">Convert a list to HTML element</h4>
<div class="outline-text-4" id="text-org3d20ce2">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-mk-elem(o)
  (cond
   ((and (listp o) (equal (car o) 'lisp))
    (let ((res (eval (cadr o))))
      res))
   ((listp o)
    (multiple-value-bind (nm id cls attrs) (blog-gen-parse-elem-name (symbol-name (car o)))
      (let* ((attrs (seq-filter
                     (lambda (s)
                       (and (symbolp s)
                            (s-starts-with? "@" (as-string s))))
                     (cdr o)))
             (children (seq-filter
                        (lambda (s)
                          (or (listp s)
                              (not (s-starts-with? "@" (as-string s)))))
                        (cdr o)))
             (attrs-s (mapconcat #'blog-gen-parse-kvp (mapcar #'symbol-name attrs) " "))
             (children-s (mapconcat #'blog-gen-mk-elem children " ")))
        (concat
         (format "&lt;%s" nm)
         (unless (string-empty-p id) (format " id=\"%s\"" id))
         (unless (string-empty-p cls) (format " class=\"%s\"" cls))
         (unless (string-empty-p attrs-s) (format " %s" attrs-s))
         (if (string-empty-p children-s)
             (format "/&gt;\n")
           (format "&gt;\n%s\n&lt;/%s&gt;\n" children-s nm))))))
   ((symbolp o) (symbol-name o))
   ((stringp o) o)
   (t (format "%S" o))))

(assert (string-equal (blog-gen-mk-elem "a")
                      "a"))

(assert (string-equal (blog-gen-mk-elem '(div))
                      "&lt;div/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(div?id))
                      "&lt;div id=\"id\"/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(div?id.c1.c2))
                      "&lt;div id=\"id\" class=\".c1.c2\"/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(div?id.c1 @foo=bar@fit=bit))
                      "&lt;div id=\"id\" class=\".c1\" foo=\"bar\" fit=\"bit\"/&gt;\n"))

(assert (string-equal (blog-gen-mk-elem '(lisp ))
                     nil))

(assert (string-equal (blog-gen-mk-elem (lisp 1)) "1"))

(let ((foo "BAR"))
  (assert (string-equal (blog-gen-mk-elem '(lisp foo))
                        "BAR")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga2e7c6f" class="outline-4">
<h4 id="orga2e7c6f">Generate HTML from list</h4>
<div class="outline-text-4" id="text-orga2e7c6f">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro html(&amp;rest forms)
  `(concat
    "&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n"
    ,(mapconcat
      #'blog-gen-mk-elem
      forms
      "\n")
    "&lt;/html&gt;"))

(html
 (head
  (script @type=javascript @src=foo.js)
  (link @rel=stylesheet @href=https://www.w3schools.com/html/styles.css))
 (body
  "a,b"))

(html
 (lisp (format "%S" (+ 40 2))))

(html
 (body
  (div)
  (lisp (concat  "Hello," "world! " (current-time-string)))))
</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defmacro flex-row(&amp;rest forms)
    `(concat
      "&lt;div class={display:flex;flex-direction:row;width:100}&gt;"
      ,@forms
      "&lt;/div&gt;"))

  (defmacro flex-cell(flex-by &amp;rest forms)
    `(concat
      (format "&lt;div style={flex: %s}" ,flex-by)
      ,@forms
      "&lt;/div&gt;"))

  (flex-row (flex-cell 1) (flex-cell 2 org-version) (flex-cell 1))


(defmacro html-gen(&amp;rest forms)
  `(concat
    "&lt;html&gt;\n"
    ,@(mapconcat
      #'car
      forms
      "\n")
    "&lt;/html&gt;"))

(blog-gen-mk-elem '(html
           (head
            (script src=foo))
           (body)))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org8f3b80f" class="outline-4">
<h4 id="org8f3b80f">Variables</h4>
<div class="outline-text-4" id="text-org8f3b80f">
<div class="org-src-container">
<pre><code class="src src-elisp">(require 'ox-html)

 ;;; Variables and options

(defgroup org-export-blog nil
  "Options specific to RSS export back-end."
  :tag "Org Blog"
  :group 'org-export
  :version "24.4"
  :package-version '(Org . "9.0"))

(defcustom blog-gen-publish-url "https://MonadicT.github.io"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-title "MonadicT"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-author "Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-copyright-message "Copyright &amp;copy; 2014-%s, Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-style-file "blog-style.css"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-banner-file "banner.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-footer-file "footer.org"
  "???"
  :group 'org-export-blog
  :type 'string)

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org1d16a08" class="outline-4">
<h4 id="org1d16a08">Inner template generator</h4>
<div class="outline-text-4" id="text-org1d16a08">
<p>
This function is called from Org-export machinery.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">
(defun blog-gen-inner-template (contents info)
  (mapconcat
   (lambda (x) (format "%s" x))
   (yatl-compile
    (body
     (blog-gen-top-matter)
     (div?blog-content
      (div?blog-content-left " ")
      (div?blog-content-middle
       contents)
      (div?blog-content-right))
     (div.blog-footer
      (format blog-gen-copyright-message
              (format-time-string "%Y")))))
   ""))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org64805f5" class="outline-4">
<h4 id="org64805f5">twitter-link</h4>
<div class="outline-text-4" id="text-org64805f5">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-twitter-link()
  "&lt;a target=\"_new\" href=\"https://twitter.com/MonadicT\"&gt;
&lt;span style={background-color: white; height:48px;width:48px;border-radius:24px}&gt;&lt;/span&gt;
&lt;img height=\"48px\" width=\"48px\"
   title=\"Visit my Twitter page\"
   src=\"/images/twitter.png\"/&gt;&lt;/a&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgd52759f" class="outline-4">
<h4 id="orgd52759f">github-link</h4>
<div class="outline-text-4" id="text-orgd52759f">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-github-link()
  "&lt;a id=\"github-link\" target=\"_new\"
  href=\"https://github.com/MonadicT\"&gt;&lt;img id=\"github-logo\"
  height=\"48\" width=\"48\" src=\"/images/github.png\"/&gt;&lt;/a&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga4c2dfa" class="outline-4">
<h4 id="orga4c2dfa">Home link</h4>
<div class="outline-text-4" id="text-orga4c2dfa">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-home-link()
  "&lt;a href=\"/index.html\"&gt;Home&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgd311f66" class="outline-4">
<h4 id="orgd311f66">Articles link</h4>
<div class="outline-text-4" id="text-orgd311f66">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-articles-link()
  "&lt;a href=\"/articles.html\"&gt;Articles&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org393bdfc" class="outline-4">
<h4 id="org393bdfc">About link</h4>
<div class="outline-text-4" id="text-org393bdfc">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-about-link()
  "&lt;a href=\"/about.html\"&gt;About&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org5ce2912" class="outline-4">
<h4 id="org5ce2912">Tags link</h4>
<div class="outline-text-4" id="text-org5ce2912">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-tags-link()
  "&lt;a href=\"/tags.html\"&gt;Tags&lt;/a&gt;")

</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgd146857" class="outline-4">
<h4 id="orgd146857">Site links</h4>
<div class="outline-text-4" id="text-orgd146857">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-site-links()
  (concat
   "&lt;div  id=\"site-links\"&gt;"
   (blog-gen-home-link)
   (blog-gen-articles-link)
   (blog-gen-tags-link)
   (blog-gen-about-link)
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org14bb50b" class="outline-4">
<h4 id="org14bb50b">top-matter</h4>
<div class="outline-text-4" id="text-org14bb50b">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-top-matter()
  (concat
   "&lt;div id=\"blog-header\" class=\"margin-row\"&gt;"
   "&lt;div class=\"blog-margin-left\"&gt;&lt;/div&gt;"
   (format
    "&lt;div class=\"blog-margin-middle\" id=\"xblog-header\"&gt;&lt;h1&gt;&lt;div id=\"blog-title\"&gt;%s&lt;/div&gt;&lt;/h1&gt;%s&lt;/div&gt;"
    blog-gen-title
   (blog-gen-search-form))
   "&lt;div class=\"blog-margin-right\"&gt;"
   "&lt;/div&gt;"
    "&lt;/div&gt;\n"
    "&lt;div id=\"blog-banner\" class=\"margin-row\"&gt;"
    "&lt;div class=\"blog-margin-left\"&gt;"
    "&lt;/div&gt;"
    "&lt;div class=\"blog-margin-middle\"&gt;"
    (blog-gen-site-links)
    (blog-gen-social-media-icons)
    "&lt;/div&gt;"
    "&lt;div class=\"blog-margin-right\"&gt;&lt;/div&gt;"
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgba89606" class="outline-4">
<h4 id="orgba89606">Search form</h4>
<div class="outline-text-4" id="text-orgba89606">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-search-form()
  "&lt;div&gt;Search &lt;form action=\"http://www.google.com/search\" id=\"searchform\"
method=\"get\"&gt;&lt;div&gt;&lt;input class=\"box\" id=\"s\" name=\"q\" type=\"text\" /&gt;
&lt;input name=\"sitesearch\" type=\"hidden\" value=\"http://MonadicT.github.io\" /&gt;
&lt;/div&gt;&lt;/form&gt;&lt;/div&gt;")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org7f85eda" class="outline-4">
<h4 id="org7f85eda">Social media icons</h4>
<div class="outline-text-4" id="text-org7f85eda">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-social-media-icons()
  (concat
   "&lt;div id=\"social-media-icons\"&gt;"
   (blog-gen-twitter-link)
   (blog-gen-github-link)
   "&lt;/div&gt;"))
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0771b9e" class="outline-3">
<h3 id="org0771b9e">Mode implementation</h3>
<div class="outline-text-3" id="text-org0771b9e">
<div class="org-src-container">
<pre><code class="src src-elisp"> ;;; Define backend

(org-export-define-derived-backend 'blog 'html
  :menu-entry
  '(?b "Export to Blog"
       ((?b "As Blog buffer"
            (lambda (a s v b) (blog-gen-export-as-blog a s v)))
        (?f "As Blog file" (lambda (a s v b) (blog-gen-export-to-blog a s v)))
        (?o "As Blog file and open"
            (lambda (a s v b)
              (if a (blog-gen-export-to-blog t s v)
                (org-open-file (blog-gen-export-to-blog nil s v)))))))
  :options-alist
  '((:description "DESCRIPTION" nil nil newline)
    (:keywords "KEYWORDS" nil nil space)
    (:with-toc nil nil nil) ;; Never include HTML's toc
    )
  :filters-alist '((:filter-final-output . blog-gen-final-function))
  :translate-alist '((comment . (lambda (&amp;rest args) ""))
                     (comment-block . (lambda (&amp;rest args) ""))
                     (timestamp . (lambda (&amp;rest args) ""))
                     (inner-template . blog-gen-inner-template)
                     (template . blog-gen-template)))

 ;;; Export functions

 ;;;###autoload
(defun blog-gen-export-as-blog (&amp;optional async subtreep visible-only)
  "Export current buffer to a blog buffer.

 Export is done in a buffer named \"*Org Blog Export*\", which will
 be displayed when `org-export-show-temporary-export-buffer' is
 non-nil."
  (interactive)
  (let ((file (buffer-file-name (buffer-base-buffer)))))
  (org-export-to-buffer 'blog "*Org Blog Export*"
    async subtreep visible-only nil nil (lambda () (text-mode))))

 ;;;###autoload
(defun blog-gen-export-to-blog (&amp;optional async subtreep visible-only)
  "Export current buffer to a Blog file.
 Return output file's name."
  (interactive)
  (let ((file (buffer-file-name (buffer-base-buffer)))))
  (let ((outfile (org-export-output-file-name
                  (concat "." "html") subtreep)))
    (org-export-to-file 'blog outfile async subtreep visible-only)))

 ;;;###autoload
(defun blog-gen-publish-to-blog (plist filename pub-dir)
  "Publish an org file to Blog.

 FILENAME is the filename of the Org file to be published.  PLIST
 is the property list for the given project.  PUB-DIR is the
 publishing directory.

 Return output file name."
  (let ((bf (get-file-buffer filename)))
    (if bf
        (with-current-buffer bf
          (write-file filename))
      (find-file filename)
      (write-file filename) (kill-buffer)))
  (org-publish-org-too
   'log filename (concat "." "html") plist pub-dir))

 ;;; Main transcoding functions

(defun blog-gen-template (contents info)
  "Return complete document string after BLOG conversion.
 CONTENTS is the transcoded contents string.  INFO is a plist
 used as a communication channel."
  (yatl-html5
   (head
    (yatl-compile-string "meta@charset=\"%s\"&gt;"
            (symbol-name org-html-coding-system))
    (title blog-gen-title)
    (yatl-compile-string
     "base@href=\"%s\""
     (if blog-gen-local "http://localhost:8000/" "https://MonadicT.github.io/"))
    (yatl-compile-string "meta@name=generator@content=\"%s\"&gt;" (emacs-version))
    (yatl-compile-string "meta@name=author@content=\"%s\"" blog-gen-author)
    (link@href=\"blog-style.css\"@rel=\"stylesheet\"))
   contents))

 ;;; Filters

(defun blog-gen-final-function (contents backend info)
  "Prettify the Blog output."
  (with-temp-buffer
    (xml-mode)
    (insert contents)
    ;;(indent-region (point-min) (point-max))
    (buffer-substring-no-properties (point-min) (point-max))))

 ;;; Miscellaneous


(provide 'ox-blog)

 ;;; ox-blog.el ends here

</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">(require 'ox-html)
(defun my-html-body-filter(text backend info)
  text)

(add-to-list 'org-export-filter-body-functions
             'my-html-body-filter)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orge0129b9" class="outline-3">
<h3 id="orge0129b9">Org-file analyzer</h3>
<div class="outline-text-3" id="text-orge0129b9">
</div>
<div id="outline-container-org53ef087" class="outline-4">
<h4 id="org53ef087">Return keywords from org-file</h4>
<div class="outline-text-4" id="text-org53ef087">
<p>
Returns list of OrgMode keywords from the current document.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-get-all-keywords()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (lambda (kw)
      (cons (org-element-property :key kw)
            (org-element-property :value kw)))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgb4d3606" class="outline-4">
<h4 id="orgb4d3606">Get keyword</h4>
<div class="outline-text-4" id="text-orgb4d3606">
<p>
Returns value of <code>key</code> or <code>default-value</code> if <code>key</code> doesn't exist in <code>keywords</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-get-keyword-value(keywords key &amp;optional default-value)
  (if-let ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2187110" class="outline-3">
<h3 id="org2187110">Blog publishing</h3>
<div class="outline-text-3" id="text-org2187110">
</div>
<div id="outline-container-org0a54d93" class="outline-4">
<h4 id="org0a54d93">Blog source directory</h4>
<div class="outline-text-4" id="text-org0a54d93">
<p>
The root directory where the source for blogs is kept.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defcustom blog-gen-root-dir
  "~/stuff/github/MonadicT.github.io"
  "")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgb853e83" class="outline-4">
<h4 id="orgb853e83">Blog posts directory</h4>
<div class="outline-text-4" id="text-orgb853e83">
<p>
The subdirectory where <code>.org</code> files are stored.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defcustom blog-gen-posts-dir
  "_resources/posts"
  "")
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org566fd4e" class="outline-4">
<h4 id="org566fd4e">Publishing locally</h4>
<div class="outline-text-4" id="text-org566fd4e">
<p>
This is a Boolean flag set to use <code>base</code> url for generated html files.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(setq blog-gen-local t)
</code></pre>
</div>
</div>
</div>
<div id="outline-container-orgc579409" class="outline-4">
<h4 id="orgc579409">Extract post details</h4>
<div class="outline-text-4" id="text-orgc579409">
<p>
Extracts post title, summary and <code>publish-date</code> from the file. Nil is
returned if <code>publish-date</code> is not present.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-post-details (f)
  (with-temp-buffer
    (find-file f)
    (let* ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  :test #'equal))
           (export-file-name (blog-gen-get-keyword-value kws "export_file_name" nil))
           (href (or export-file-name "")))
      (while (string-match "^\\.\\./" href)
        (setq href (substring href 3)))
      (puthash "post-file" f details)
      (puthash "title" (blog-gen-get-keyword-value kws "title" "") details)
      (puthash "summary" (blog-gen-get-keyword-value kws "summary" "") details)
      (puthash "publish-date" (blog-gen-get-keyword-value kws "publish-date" nil) details)
      (puthash "export_file_name" export-file-name details)
      (puthash "tags" (blog-gen-get-keyword-value kws "tags" "") details)
      (puthash "target" (blog-gen-get-keyword-value kws "target" "") details)
      (puthash "href" (concat "http:" href) details)
      (unless (string-match "blog-generator.org" f) (kill-buffer))
      details)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org67d383d" class="outline-4">
<h4 id="org67d383d">Post files</h4>
<div class="outline-text-4" id="text-org67d383d">
<p>
Returns list of posts stored in <code>.org</code> files. <code>.org</code> files such as
<code>index.org</code>, <code>about.org</code> are not returned as posts.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-post-files()
  (let* ((posts-dir (concat blog-gen-root-dir "/" blog-gen-posts-dir))
         (org-files (directory-files posts-dir t "[a-ZA-Z0-9_-]*\\.org$"))
         (org-files
          (seq-remove
           (lambda (f)
             (or (string-match "index.org$" f)
                 (string-match "about.org$" f)
                 (string-match "sitemap.org$" f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org127ac27" class="outline-4">
<h4 id="org127ac27">Published post files</h4>
<div class="outline-text-4" id="text-org127ac27">
<p>
Returns published posts (posts which have <code>export_file_name</code> keyword).
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-published-posts (posts)
  (seq-filter (lambda (p) (gethash "export_file_name" p)) posts))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgc951548" class="outline-4">
<h4 id="orgc951548">Order post files</h4>
<div class="outline-text-4" id="text-orgc951548">
<p>
Orders posts by <code>publish-date</code> descending.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-order-posts(posts)
  (seq-sort (lambda (a b) (string&gt; (gethash "publish-date" a) (gethash "publish-date" b))) posts))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org35a9438" class="outline-4">
<h4 id="org35a9438">Macro to generate <code>html_export</code> blocks</h4>
<div class="outline-text-4" id="text-org35a9438">
<div class="org-src-container">
<pre><code class="src src-elisp">(defmacro html-export(&amp;rest content)
  `(progn (insert "#+BEGIN_EXPORT html\n")
          (insert ,@content)
          (insert "\n#+END_EXPORT\n\n")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org9b2b055" class="outline-4">
<h4 id="org9b2b055">Articles generation</h4>
<div class="outline-text-4" id="text-org9b2b055">
<p>
Exports all <code>.org</code> post files to <code>.html</code> files.
</p>
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-posts()
  (let ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (lambda (post)
       (let ((post-file (gethash "post-file" post))
             (export-file-name (gethash "export_file_name" post)))
         (message (concat "exporting" post-file "to" export-file-name))
         (when export-file-name
           (with-temp-buffer
             (find-file post-file)
             (org-export-to-file 'blog export-file-name)
             (kill-buffer)))))
     posts)))
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org0fdd112" class="outline-4">
<h4 id="org0fdd112">Articles page generation</h4>
<div class="outline-text-4" id="text-org0fdd112">
<p>
Generates list of articles.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-articles()
  (with-temp-buffer
    (find-file "index.org")
    (erase-buffer)
    (insert "#+title: MonadictT\n")
    (insert "#+options: num:nil html-style:nil\n")
    (insert "* Posts\n")
    (let ((posts (blog-gen-order-posts
                  (blog-gen-published-posts
                   (blog-gen-post-files)))))
      (mapcar
       (lambda (post)
         (let* ((title (gethash "title" post))
                (summary (gethash "summary"  post))
                (export-file-name (gethash "export_file_name"  post))
                (export-file-name
                 (let ((href export-file-name))
                   (while (string-match "^\\.\\./" href)
                     (setq href (substring href 3)))
                   href))
                (publish-date (gethash "publish-date" post))
                (l (list (make-symbol (format "a@href=\"/%s\"" export-file-name)) title)))
           (html-export
            (yatl-html-frag
             (div.post-title
              (eval (yatl-compile-fn l)))))
           (html-export
            (yatl-html-frag
             (div.post-summary summary)) "\n\n")
           (html-export
            (yatl-html-frag
             (div.post-publish-date "Published: " publish-date)) "\n")))
       posts))
    (save-buffer)
    (when (file-exists-p "../../articles.html")
      (delete-file "../../articles.html"))
    (org-export-to-file 'blog "../../articles.html")))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orgffa1035" class="outline-4">
<h4 id="orgffa1035">Tags generation</h4>
<div class="outline-text-4" id="text-orgffa1035">
<p>
Posts have a <code>#+tags</code> header and tags are separated by <code>,</code>. This
function builds a hashtable of tags to a list posts from <code>posts</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun create-tag-post-map(posts)
  (let ((tag-post-map (make-hash-table :test 'equal)))
    (mapcar
     (lambda(post)
       (let ((title (gethash "title" post))
             (tags (mapcar #'s-trim (split-string (gethash "tags" post) "[,]+"))))
         (mapcar
          (lambda (tag)
            (when (not (string-empty-p tag))
              (puthash tag (cons post (gethash tag tag-post-map '())) tag-post-map)))
          tags)))
     posts)
    tag-post-map))
</code></pre>
</div>

<p>
Tags should be ordered in lexicographic order. This function returns
tags in ascending order.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun sorted-keys(tag-post-map)
  (let ((keys '()))
    (maphash
     (lambda (k v) (setq keys (cons k keys)))
     tag-post-map)
    (seq-sort (lambda (a b) (string-lessp (upcase a) (upcase b))) keys)))
</code></pre>
</div>

<p>
Once we have the <code>tag-post-map</code>, we can generate an <code>org-mode</code>
representation of it. The tag is listed as second-level header with a
bullet list of anchors to posts.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-tags(posts)
  (let* ((tag-post-map (create-tag-post-map posts))
         (tags  (sorted-keys tag-post-map)))
    (with-temp-buffer
      (find-file "tags.org")
      (erase-buffer)
      (insert "#+title: Tags\n")
      (insert "#+options: num:nil\n")
      (insert "* Tags\n")
      (mapcar
       (lambda (tag)
         (let ((post-list (gethash tag tag-post-map)))
           (insert "** " tag "\n")
           (mapcar
            (lambda (post)
              (princ post)
              (let ((title (gethash "title" post))
                    (href  (gethash "href" post)))
                (insert "- [[" href "][" title "]]\n")))
            post-list)))
       tags)
      (write-file "tags.org")
      (org-export-to-file 'blog "../../tags.html")
      (kill-buffer))))


;;  (setq x (blog-gen-post-files))

;;  (blog-gen-create-tags x)

;;  (require 'blog-gen)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga9a6278" class="outline-4">
<h4 id="orga9a6278">About page generation.</h4>
<div class="outline-text-4" id="text-orga9a6278">
<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-about()
  (with-temp-buffer
    (find-file "about.org")
    (org-export-to-file 'blog "../../about.html")
    (kill-buffer)))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orge4118ea" class="outline-4">
<h4 id="orge4118ea">Home page generation</h4>
<div class="outline-text-4" id="text-orge4118ea">
<p>
For now, <i>Home</i> points to <i>Articles</i>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-create-home()
  (copy-file "../../articles.html" "../../index.html" t))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org9091077" class="outline-4">
<h4 id="org9091077">Generates blog,</h4>
<div class="outline-text-4" id="text-org9091077">
<p>
Function to regenerate the full site. This is bound to <code>C-c C-g</code>.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">(defun blog-gen-publish(prod)
  (interactive "P")
  (if prod (setq blog-gen-local nil) (setq local t))
  (let ((posts (blog-gen-post-files)))
    (blog-gen-create-posts)
    (blog-gen-create-articles)
    (blog-gen-create-tags posts)
    (blog-gen-create-about)
    (blog-gen-create-home)))
(global-set-key (kbd "C-c C-g") #'blog-gen-publish)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org519e245" class="outline-4">
<h4 id="org519e245">Create new blog post</h4>
<div class="outline-text-4" id="text-org519e245">
<p>
A template for creating a new blog post.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">  (defun blog-gen-new-post()
    (interactive)
    (insert "#+title: TBD
#+summary: TBD
#+publish-date: 2018-01-31
#+export_file_name: ../../yyyy/TBD
#+tags: TBD
#+option: num:nil"))

</code></pre>
</div>
</div>
</div>

<div id="outline-container-org0e811e4" class="outline-4">
<h4 id="org0e811e4">Tangled elisp file</h4>
<div class="outline-text-4" id="text-org0e811e4">
<p>
All the functions described above are tangled into
~/.emacs.d/lisp/blog-gen.el. A <code>require</code> in <code>.emacs</code> will make this
available for use.
</p>

<div class="org-src-container">
<pre><code class="src src-elisp">;;; blog-gen.el --- Static site generator in emacs and org-mode

;; Copyright (C) 2017-2018 Praki Prakash

;; Author: Praki Prakash
;; Maintainer: Praki Prakash
;; Created: 2017-12-31
;; Keywords: languages
;; Homepage: https://MonadicT.gihub.io

;; This file is not part of GNU Emacs.
</code></pre>
</div>

<div class="org-src-container">
<pre><code class="src src-elisp">;;; blog-gen.el --- Static site generator in emacs and org-mode

;; Copyright (C) 2017-2018 Praki Prakash

;; Author: Praki Prakash
;; Maintainer: Praki Prakash
;; Created: 2017-12-31
;; Keywords: languages
;; Homepage: https://MonadicT.gihub.io

;; This file is not part of GNU Emacs.
;;; Dependencies ----------------------
(require 'cl)
(require 'yatl)

;;; Variables
(require 'ox-html)

 ;;; Variables and options

(defgroup org-export-blog nil
  "Options specific to RSS export back-end."
  :tag "Org Blog"
  :group 'org-export
  :version "24.4"
  :package-version '(Org . "9.0"))

(defcustom blog-gen-publish-url "https://MonadicT.github.io"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-title "MonadicT"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-author "Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-copyright-message "Copyright &amp;copy; 2014-%s, Praki Prakash"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-style-file "blog-style.css"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-banner-file "banner.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-footer-file "footer.org"
  "???"
  :group 'org-export-blog
  :type 'string)

(defcustom blog-gen-root-dir
  "~/stuff/github/MonadicT.github.io"
  "")
(defcustom blog-gen-posts-dir
  "_resources/posts"
  "")
(setq blog-gen-local t)

;;; Functions ------------------------
(defmacro assert-equal (actual expected)
  `(when (not (equal ,actual ,expected))
     (error "Actual: %s expected: %s"
            (format "%s" ',actual)
            (format "%s" ',expected))))
(defun blog-gen-get-all-keywords()
  (org-element-map
      (org-element-parse-buffer 'element)
      'keyword
    (lambda (kw)
      (cons (org-element-property :key kw)
            (org-element-property :value kw)))))
(defun blog-gen-get-keyword-value(keywords key &amp;optional default-value)
  (if-let ((kw-value (cdr (assoc-ignore-case key keywords))))
      kw-value
    default-value))
(defun blog-gen-post-details (f)
  (with-temp-buffer
    (find-file f)
    (let* ((kws (blog-gen-get-all-keywords))
           (details (make-hash-table  :test #'equal))
           (export-file-name (blog-gen-get-keyword-value kws "export_file_name" nil))
           (href (or export-file-name "")))
      (while (string-match "^\\.\\./" href)
        (setq href (substring href 3)))
      (puthash "post-file" f details)
      (puthash "title" (blog-gen-get-keyword-value kws "title" "") details)
      (puthash "summary" (blog-gen-get-keyword-value kws "summary" "") details)
      (puthash "publish-date" (blog-gen-get-keyword-value kws "publish-date" nil) details)
      (puthash "export_file_name" export-file-name details)
      (puthash "tags" (blog-gen-get-keyword-value kws "tags" "") details)
      (puthash "target" (blog-gen-get-keyword-value kws "target" "") details)
      (puthash "href" (concat "http:" href) details)
      (unless (string-match "blog-generator.org" f) (kill-buffer))
      details)))
(defun blog-gen-post-files()
  (let* ((posts-dir (concat blog-gen-root-dir "/" blog-gen-posts-dir))
         (org-files (directory-files posts-dir t "[a-ZA-Z0-9_-]*\\.org$"))
         (org-files
          (seq-remove
           (lambda (f)
             (or (string-match "index.org$" f)
                 (string-match "about.org$" f)
                 (string-match "sitemap.org$" f)))
           org-files)))
    (mapcar
     #'blog-gen-post-details
     org-files)))
(defun blog-gen-published-posts (posts)
  (seq-filter (lambda (p) (gethash "export_file_name" p)) posts))
(defun blog-gen-order-posts(posts)
  (seq-sort (lambda (a b) (string&gt; (gethash "publish-date" a) (gethash "publish-date" b))) posts))
(defmacro html-export(&amp;rest content)
  `(progn (insert "#+BEGIN_EXPORT html\n")
          (insert ,@content)
          (insert "\n#+END_EXPORT\n\n")))
(defun blog-gen-create-posts()
  (let ((posts (blog-gen-published-posts
                (blog-gen-post-files))))
    (mapcar
     (lambda (post)
       (let ((post-file (gethash "post-file" post))
             (export-file-name (gethash "export_file_name" post)))
         (message (concat "exporting" post-file "to" export-file-name))
         (when export-file-name
           (with-temp-buffer
             (find-file post-file)
             (org-export-to-file 'blog export-file-name)
             (kill-buffer)))))
     posts)))
(defun blog-gen-create-articles()
  (with-temp-buffer
    (find-file "index.org")
    (erase-buffer)
    (insert "#+title: MonadictT\n")
    (insert "#+options: num:nil html-style:nil\n")
    (insert "* Posts\n")
    (let ((posts (blog-gen-order-posts
                  (blog-gen-published-posts
                   (blog-gen-post-files)))))
      (mapcar
       (lambda (post)
         (let* ((title (gethash "title" post))
                (summary (gethash "summary"  post))
                (export-file-name (gethash "export_file_name"  post))
                (export-file-name
                 (let ((href export-file-name))
                   (while (string-match "^\\.\\./" href)
                     (setq href (substring href 3)))
                   href))
                (publish-date (gethash "publish-date" post))
                (l (list (make-symbol (format "a@href=\"/%s\"" export-file-name)) title)))
           (html-export
            (yatl-html-frag
             (div.post-title
              (eval (yatl-compile-fn l)))))
           (html-export
            (yatl-html-frag
             (div.post-summary summary)) "\n\n")
           (html-export
            (yatl-html-frag
             (div.post-publish-date "Published: " publish-date)) "\n")))
       posts))
    (save-buffer)
    (when (file-exists-p "../../articles.html")
      (delete-file "../../articles.html"))
    (org-export-to-file 'blog "../../articles.html")))
(defun create-tag-post-map(posts)
  (let ((tag-post-map (make-hash-table :test 'equal)))
    (mapcar
     (lambda(post)
       (let ((title (gethash "title" post))
             (tags (mapcar #'s-trim (split-string (gethash "tags" post) "[,]+"))))
         (mapcar
          (lambda (tag)
            (when (not (string-empty-p tag))
              (puthash tag (cons post (gethash tag tag-post-map '())) tag-post-map)))
          tags)))
     posts)
    tag-post-map))
(defun sorted-keys(tag-post-map)
  (let ((keys '()))
    (maphash
     (lambda (k v) (setq keys (cons k keys)))
     tag-post-map)
    (seq-sort (lambda (a b) (string-lessp (upcase a) (upcase b))) keys)))
(defun blog-gen-create-tags(posts)
  (let* ((tag-post-map (create-tag-post-map posts))
         (tags  (sorted-keys tag-post-map)))
    (with-temp-buffer
      (find-file "tags.org")
      (erase-buffer)
      (insert "#+title: Tags\n")
      (insert "#+options: num:nil\n")
      (insert "* Tags\n")
      (mapcar
       (lambda (tag)
         (let ((post-list (gethash tag tag-post-map)))
           (insert "** " tag "\n")
           (mapcar
            (lambda (post)
              (princ post)
              (let ((title (gethash "title" post))
                    (href  (gethash "href" post)))
                (insert "- [[" href "][" title "]]\n")))
            post-list)))
       tags)
      (write-file "tags.org")
      (org-export-to-file 'blog "../../tags.html")
      (kill-buffer))))


;;  (setq x (blog-gen-post-files))

;;  (blog-gen-create-tags x)

;;  (require 'blog-gen)
(defun blog-gen-create-about()
  (with-temp-buffer
    (find-file "about.org")
    (org-export-to-file 'blog "../../about.html")
    (kill-buffer)))
(defun blog-gen-create-home()
  (copy-file "../../articles.html" "../../index.html" t))
(defun blog-gen-publish(prod)
  (interactive "P")
  (if prod (setq blog-gen-local nil) (setq local t))
  (let ((posts (blog-gen-post-files)))
    (blog-gen-create-posts)
    (blog-gen-create-articles)
    (blog-gen-create-tags posts)
    (blog-gen-create-about)
    (blog-gen-create-home)))
(global-set-key (kbd "C-c C-g") #'blog-gen-publish)
  (defun blog-gen-new-post()
    (interactive)
    (insert "#+title: TBD
#+summary: TBD
#+publish-date: 2018-01-31
#+export_file_name: ../../yyyy/TBD
#+tags: TBD
#+option: num:nil"))

(provide 'blog-gen)
;;; blog-gen.el ends here
</code></pre>
</div>
</div>
</div>
</div>
</div>

</div>
 <div id="blog-content-right"/>

</div>
 <div class=" blog-footer">
Copyright &copy; 2014-2018, Praki Prakash
</div>

</body>
</html>
