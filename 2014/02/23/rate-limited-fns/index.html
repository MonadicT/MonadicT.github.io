<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><meta name="description" /><meta content="clojure, programming, algorithm" name="keywords" /><meta content="Nurullah Akkaya" name="author" /><link href="/images/favicon.ico" rel="icon" type="image/x-icon" /><link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="/default.css" rel="stylesheet" type="text/css" /><link href="/rss-feed" rel="alternate" title="MonadicT" type="application/rss+xml" /><link href="http://foo.com/2014/02/23/rate-limited-fns/" rel="canonical" /><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><title>core.async for throttling a Clojure function</title></head><body><div id="wrap"><div id="header"><h1><a href="/">MonadicT</a></h1></div><div id="content"><div id="post"><h2 class="page-title">core.async for throttling a Clojure function</h2><h3>Introduction</h3><p>Most of the time, we want our functions to execute as fast as possible. But sometimes, that is not quite what is desirable. For example, if we are interfacing to an external service, we may be expected to be a friendly user of it and not bombard it with requests. While it's reasonable to expect that the service will have its own throttling mechanism, it's still a technique worth knowing.</p><p>Throttling or rate limiting is widely used in network traffic management. <a href="https://en.wikipedia.org/wiki/Token_bucket">Token bucket</a> and <a href="https://en.wikipedia.org/wiki/Leaky_bucket">Leaky bucket</a> are two commonly used algorithms. We will implement a token-based rate limiter using <em>core.async</em>.</p><p>What follows is a simple Clojure macro which defines a self-governing function.</p><h3>How it works</h3><p>The function waits for a token before proceeding and the token is only issued at the specified intervals. The waiting and token granting logic is based on <em>core.async</em> channel constructs. Each throttled function has an associated channel on which it waits to get a token. A token granter waits for an interval of time on a <em>timeout</em> channel and sends the token on the token channel. This ensures that the function will never execute more frequently than the desired interval. The <em>rendezvous</em> model used by <em>core.async</em> channels ensures that the token granter waits until a prior granted token is consumed.</p><p>Note that the body of the function is wrapped in an anonymous function within the generated wrapper function and invoked with an <em>apply</em>.</p><h3>defn-throttled</h3><p>Clojure code for implementing a throttled function. <em>defn-throttled</em> is a macro resembling Clojure's <em>defn</em> but with an additional interval specifier preceding the argument vector.</p><p>{% gist 9182004 %}</p><div class="post-tags">Tags: <a href="/tags/#clojure,">clojure, </a><a href="/tags/#programming,">programming, </a><a href="/tags/#algorithm">algorithm </a></div></div><div id="related"><h3 class="random-posts">Random Posts</h3><ul class="posts"><li><span>26 Feb 2014</span><a href="/2014/02/26/JavaForkJoin/">Java Fork/Join Framework - an exemplar of elegant design</a></li><li><span>23 Feb 2014</span><a href="/2014/02/23/rate-limited-fns/">core.async for throttling a Clojure function</a></li><li><span>25 Feb 2014</span><a href="/2014/02/25/Ubuntu-Network_trouble/">How to fix Wi-Fi connection issues in Ubuntu 13.04</a></li><li><span>24 Jan 2014</span><a href="/2014/01/24/Java-References/">Java Reference Objects</a></li><li><span>01 Mar 2014</span><a href="/2014/3/01/ssh-tips/">SSH tips</a></li></ul></div></div><div id="footer"><a href="/rss-feed"> RSS Feed</a><p>&copy; 2013<a href="http://foo.com"> Foo Bar</a></p></div></div><script type="text/javascript">
//<![CDATA[
(function() {
	     var links = document.getElementsByTagName('a');
	     var query = '?';
	     for(var i = 0; i < links.length; i++) {
		     if(links[i].href.indexOf('#disqus_thread') >= 0) {
								       query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
								       }
		     }
	     document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/nakkaya/get_num_replies.js' + query + '"></' + 'script>');
	     })();
//]]>
</script></body></html>